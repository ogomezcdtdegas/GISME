<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Densidad</title>
    <style>
        #chartContainer {
            width: 700px;  /* Ajusta el ancho */
            height: 500px; /* Ajusta el alto */
        }
    </style>
</head>
<body>
    <h2>Calcular Incertidumbre y mostrar histograma</h2>
    <input type="number" id="densidad_medida" placeholder="densidad_medida">
    <input type="number" id="u_cal" placeholder="u_cal">
    <input type="number" id="u_res" placeholder="u_res">
    <input type="number" id="u_der" placeholder="u_der">
    <button onclick="calcularIncertidumbre()">Calcular Incertidumbre</button>
    <p id="resultado_incertidumbre"></p>

    <!-- Lienzo donde se dibujará el histograma -->
    <div id="chartContainer">
        <canvas id="histogramaChart"></canvas>
    </div>

    <h2>Calcular Propiedades del Gas Natural</h2>
<input type="number" id="temperatura" placeholder="Temperatura (°C)">
<input type="number" id="presion" placeholder="Presión (bar)">
<input type="text" id="composicion" placeholder="Composición (ej: 0.9,0.05,0.03,0.02)">
<button onclick="calcularPropiedadesGas()">Calcular</button>
<p id="resultadoGas"></p>

    <!-- Agregar la librería Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    
    <script>
        async function calcularIncertidumbre() {
            const densidad_medida = document.getElementById("densidad_medida").value;
            const u_cal = document.getElementById("u_cal").value;
            const u_res = document.getElementById("u_res").value;
            const u_der = document.getElementById("u_der").value;

            if (!densidad_medida || !u_cal || !u_res || !u_der) {
            document.getElementById("resultado_incertidumbre").innerText = "Por favor, ingresa todos los valores.";
            return;
            }
    
            const response = await fetch("http://127.0.0.1:8000/incertidumbre/calcular_incertidumbre/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    densidad_medida: parseFloat(densidad_medida),
                    u_cal: parseFloat(u_cal),
                    u_res: parseFloat(u_res),
                    u_der: parseFloat(u_der)
                })
            });
    
            const data = await response.json();
            document.getElementById("resultado_incertidumbre").innerText = data.incertidumbre_expandida /* se incluye para verificar que exites el dato */
                ? `Densidad Medida: ${data.valor_medido.toFixed(5)}\n` +
                  `Incertidumbre Expandida (cobertura 95%): ${data.incertidumbre_expandida.toFixed(5)}`
                : "Error: " + data.error;

                generarHistograma( data.histograma_data); 
        }
 
 
let histogramaChart;  // Variable global para el gráfico. Esta variable almacena la referencia al gráfico de Chart.js, permitiendo su actualización en cada ejecución.

function generarHistograma(histogramaData) {
    const chartContainer = document.getElementById("chartContainer");

    // 💡 Eliminar el canvas anterior y crear uno nuevo para evitar errores
    chartContainer.innerHTML = '<canvas id="histogramaChart"></canvas>';
    const ctx = document.getElementById("histogramaChart").getContext("2d");

    // 📌 Verificar si `histogramaData` tiene datos antes de graficar
    if (!histogramaData || histogramaData.length === 0) {
        console.error("Error: histogramaData está vacío.");
        return;
    }

    // 📌 Definir bins (intervalos del histograma)
    const bins = 100;
    const min = Math.min(...histogramaData);
    const max = Math.max(...histogramaData);
    const step = (max - min) / bins;

    let histogramCounts = Array(bins).fill(0);
    let histogramLabels = [];

    for (let i = 0; i < bins; i++) {
        histogramLabels.push((min + i * step).toFixed(2));
    }

    histogramaData.forEach(value => {
        let index = Math.floor((value - min) / step);
        if (index >= bins) index = bins - 1;
        histogramCounts[index]++;
    });

    // 📊 Crear el histograma con Chart.js y almacenarlo en la variable global
    histogramaChart = new Chart(ctx, {
    type: "bar",
    data: {
        labels: histogramLabels,
        datasets: [{
            label: "Frecuencia",
            data: histogramCounts,
            backgroundColor: "rgba(75, 192, 192, 0.5)", // Color con transparencia
            borderColor: "rgba(75, 192, 192, 1)",       // Borde más intenso
            borderWidth: 2,
            hoverBackgroundColor: "rgba(255, 99, 132, 0.6)", // Color al pasar el mouse
            hoverBorderColor: "rgba(255, 99, 132, 1)"
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            duration: 2000,  // Duración de la animación
            easing: 'easeOutBounce' // Tipo de animación
        },
        plugins: {
            legend: { position: "top" }, // Posición de la leyenda
            tooltip: { enabled: true, mode: "index", intersect: false } // Tooltips avanzados
        },
        scales: {
            x: { title: { display: true, text: "Valores Simulados", color: "#333", font: { size: 14 } } },
            y: { title: { display: true, text: "Frecuencia", color: "#333", font: { size: 14 } } }
        }
    }
});

    console.log("Histograma actualizado correctamente.");
}      


    </script>

<script>
    async function calcularPropiedadesGas() {
        const temperatura = document.getElementById("temperatura").value;
        const presion = document.getElementById("presion").value;
        const composicion = document.getElementById("composicion").value
            .split(",").map(Number); // Convertir texto en array de números

        const response = await fetch("http://127.0.0.1:8000/api/calcular_propiedades_gas_natural/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                temperatura: parseFloat(temperatura),
                presion: parseFloat(presion),
                composicion: composicion
            })
        });

        const data = await response.json();
        document.getElementById("resultadoGas").innerText = data.densidad 
            ? `Densidad: ${data.densidad.toFixed(3)} kg/m³\n` +
              `Factor de Compresibilidad: ${data.compresibilidad.toFixed(3)}\n` +
              `Cp: ${data.cp.toFixed(3)} kJ/kg·K`
            : "Error: " + data.error;
    }
</script>


</body>
</html>