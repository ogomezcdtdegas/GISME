{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoreo Coriolis - GISME{% endblock %}

{% block extra_css %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/monitoreo.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-common.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-spa.css' %}">
<link rel="stylesheet" href="{% static 'css/soft-colors.css' %}">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3">
                <h5>Cargando Monitoreo Coriolis...</h5>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE SELECCIÓN DE SISTEMAS ============ -->
    <div id="sistema-selector-view">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Monitoreo Coriolis
                        </h4>
                        <p class="mb-0 mt-2">Seleccione el sistema que desea monitorear</p>
                    </div>
                    <div class="card-body">
                        <!-- Barra de búsqueda -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar sistemas...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary" id="clearSearch">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de sistemas -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('tag')">
                                                Nombre <i class="bi bi-arrow-up-down ms-1" id="tag-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('sistema_id')">
                                                MAC Gateway <i class="bi bi-arrow-up-down ms-1" id="sistema_id-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('ubicacion_nombre')">
                                                Ubicación <i class="bi bi-arrow-up-down ms-1" id="ubicacion_nombre-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">Coordenadas</th>
                                        <th scope="col">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="sistemasTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            Cargando sistemas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        <div id="pagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE MONITOREO DE SISTEMA ESPECÍFICO ============ -->
    <div id="sistema-monitoring-view" class="hidden">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0)" onclick="showSelectorView()">Monitoreo Coriolis</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbSistema">
                            Sistema
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header coriolis-header-system text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0" id="sistemaTitle">
                            <i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis
                        </h4>
                        <div>
                            <button class="btn btn-outline-danger btn-sm me-2" onclick="descargarReportePDF()">
                                <i class="bi bi-file-earmark-pdf"></i> Descargar Reporte PDF
                            </button>
                            <button class="btn btn-light btn-sm" onclick="showSelectorView()">
                                <i class="bi bi-arrow-left"></i> Cambiar Sistema
                            </button>
                        </div>
                        <!-- Contenedor oculto para el reporte PDF -->
                        <div id="reportePDF" style="display:none; max-width:600px;">
                            <h3>Reporte del Sistema Coriolis</h3>
                            <p><strong>Sistema:</strong> <span id="pdf-sistema-nombre"></span></p>
                            <p><strong>Estado:</strong> <span id="pdf-sistema-estado"></span></p>
                            <p><strong>Temperatura actual:</strong> <span id="pdf-temperatura"></span></p>
                            <div>
                                <canvas id="pdf-grafica-temperatura" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">

                            <!-- Imagen descriptiva del sistema con marcadores interactivos -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-pipe"></i> Esquema del Sistema Coriolis</h5>
                                        </div>
                                        <div class="card-body coriolis-card-body text-center" style="overflow: auto; max-height: 700px;">
                                            <div class="img-container" style="position:relative; max-width:1050px; margin:auto;">
                                                <img src="{% static 'img/coriolis_render2.png' %}" class="img-fluid" id="sistema-img" style="max-width:100%; height:auto;">
                                                <!-- Displays de sensores -->
                                                <div style="position:absolute; top:33%; left:32%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Flujo</div>
                                                    <div id="display-sensor1" style="font-size:15px; color:#007bff; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <div style="position:absolute; top:73%; left:58%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Temperatura</div>
                                                    <div id="display-sensor2" style="font-size:15px; color:#28a745; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <div style="position:absolute; top:7%; left:56%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Presión</div>
                                                    <div id="display-sensor3" style="font-size:15px; color:#dc3545; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <!-- Marcadores transparentes clickeables -->
                                                <button class="marker" style="position:absolute; top:45%; left:35%; width:32px; height:32px; border-radius:50%; background:rgba(0,123,255,0); border:none; cursor:pointer;" onclick="abrirModal('sensor1')" title="Ver histórico Sensor 1"></button>
                                                <button class="marker" style="position:absolute; top:58%; left:61.5%; width:32px; height:32px; border-radius:50%; background:rgba(40,167,69,0); border:none; cursor:pointer;" onclick="abrirModal('sensor2')" title="Ver histórico Sensor 2"></button>
                                                <button class="marker" style="position:absolute; top:23%; left:58%; width:32px; height:32px; border-radius:50%; background:rgba(220,53,69,0); border:none; cursor:pointer;" onclick="abrirModal('sensor3')" title="Ver histórico Sensor 3"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- Panel de Estado -->
                            <div class="col-lg-8 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-activity"></i> Estado del Sistema</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaInfo" class="metrics-container">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2">Cargando información del sistema...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de Ubicación -->
                            <div class="col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-geo-alt"></i> Ubicación</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaMap" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        

                        <!-- Gráficos de Tendencias -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-graph-up"></i> Tendencias de Medición</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Mapa -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">
                    <i class="bi bi-geo-alt"></i> Ubicación del Sistema
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Sistema:</strong>
                        <div id="modal-sistema-info">-</div>
                    </div>
                    <div class="col-md-4">
                        <strong>Ubicación:</strong>
                        <div id="modal-ubicacion-info">-</div>
                    </div>
                    <div class="col-md-4">
                        <strong>Coordenadas:</strong>
                        <div id="modal-coordenadas-info">-</div>
                    </div>
                </div>
                <div id="map" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="copyCoordinates()">
                    <i class="bi bi-clipboard"></i> Copiar Coordenadas
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Histórico (reutilizable para los 3 sensores) -->
<div class="modal fade" id="historicoModal" tabindex="-1" aria-labelledby="historicoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historicoModalLabel">Histórico</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Selecciona el rango de fechas</label>
          <input type="date" id="fechaInicio" value="2025-07-14"> &rarr;
          <input type="date" id="fechaFin" value="2025-07-17">
          <button class="btn btn-outline-success" onclick="buscarHistorico()"><i class="bi bi-search"></i></button>
        </div>
        <div class="card">
          <div class="card-body">
            <h6 class="mb-3" id="tituloGrafica">Presión del Sistema</h6>
            <div style="width:100%; min-width:300px; height:260px;">
              <canvas id="graficaHistorico" height="220" style="width:100% !important; display:block;"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">CERRAR</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jsPDF y html2canvas para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
async function descargarReportePDF() {
    // Llena los datos del reporte
    const sistemaNombre = document.getElementById('sistemaTitle').textContent.trim();
    const sistemaEstado = document.getElementById('sistemaInfo')?.textContent.trim() || 'N/A';
    const tempText = document.getElementById('display-sensor2').textContent;
    document.getElementById('pdf-sistema-nombre').textContent = sistemaNombre;
    document.getElementById('pdf-sistema-estado').textContent = sistemaEstado;
    document.getElementById('pdf-temperatura').textContent = tempText;

    // Dibuja el gráfico de temperatura usando Chart.js
    const temp = parseFloat(tempText);
    const ctx = document.getElementById('pdf-grafica-temperatura').getContext('2d');
    if (window.pdfChart) {
        window.pdfChart.destroy();
    }
    window.pdfChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 10}, (_, i) => `T-${10 - i}`),
            datasets: [{
                label: 'Temperatura (°F)',
                data: Array.from({length: 9}, () => (90 + Math.random() * 20).toFixed(1)).concat([temp]),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40,167,69,0.1)',
                tension: 0.3,
                pointRadius: 2
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: { display: true },
                title: { display: false }
            },
            scales: {
                x: { title: { display: true, text: 'Tiempo' } },
                y: { title: { display: true, text: 'Temperatura (°F)' }, beginAtZero: true }
            }
        }
    });

    // Espera a que Chart.js termine de renderizar
    await new Promise(resolve => setTimeout(resolve, 300));

    // Muestra el contenedor temporalmente para capturarlo
    const reporte = document.getElementById('reportePDF');
    reporte.style.display = 'block';

    // Usa html2canvas para capturar el reporte
    const canvas = await html2canvas(reporte, {backgroundColor: "#fff"});
    const imgData = canvas.toDataURL('image/png');

    // Crea el PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    // Título y datos generales
    pdf.setFontSize(16);
    pdf.text('Reporte del Sistema Coriolis', 15, 15);
    pdf.setFontSize(12);
    pdf.text('Sistema: ' + sistemaNombre, 15, 25);
    pdf.text('Estado: ' + sistemaEstado, 15, 32);
    pdf.text('Temperatura actual: ' + tempText, 15, 39);
    // Imagen del gráfico
    pdf.addImage(imgData, 'PNG', 10, 45, 190, 0);
    pdf.save('reporte_coriolis.pdf');

    // Oculta el contenedor de nuevo
    reporte.style.display = 'none';
}
</script>
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Scripts locales de Coriolis -->
<script src="{% static 'js/coriolis-common.js' %}"></script>
<script src="{% static 'js/coriolis-map.js' %}"></script>
<script src="{% static 'js/coriolis-spa.js' %}"></script>
<script>
// Simulación de valores aleatorios para los displays de sensores
function actualizarDisplaysSensores() {
  // Sensor 1: Presión (PSI)
  const val1 = (120 + Math.random() * 10).toFixed(1);
  document.getElementById('display-sensor1').textContent = val1 + ' m³/h';
  // Sensor 2: Temperatura (°F)
  const val2 = (90 + Math.random() * 20).toFixed(1);
  document.getElementById('display-sensor2').textContent = val2 + ' °F';
  // Sensor 3: Presión (PSI)
  const val3 = (40 + Math.random() * 10).toFixed(1);
  document.getElementById('display-sensor3').textContent = val3 + ' PSI';
}
setInterval(actualizarDisplaysSensores, 1000);
document.addEventListener('DOMContentLoaded', actualizarDisplaysSensores);

// =====================
// Simulación de datos en tiempo real para el gráfico del modal histórico
// =====================
let historicoChart = null;
let historicoData = [];
let historicoLabels = [];
let historicoSensorId = 'sensor1';
let historicoInterval = null;

function abrirModal(sensorId) {
    document.getElementById('tituloGrafica').textContent = 'Histórico - ' + sensorId;
    historicoSensorId = sensorId;
    // Inicializar datos
    historicoData = [];
    historicoLabels = [];
    const now = new Date();
    for (let i = 59; i >= 0; i--) {
        const fecha = new Date(now.getTime() - i * 100);
        historicoLabels.push(fecha.toLocaleTimeString() + ':' + fecha.getMilliseconds().toString().padStart(3, '0'));
        historicoData.push(generarValorSensor(sensorId));
    }
    renderHistoricoChart(historicoLabels, historicoData, sensorId);
    if (historicoInterval) clearInterval(historicoInterval);
    historicoInterval = setInterval(actualizarHistoricoChart, 100);
    var modal = new bootstrap.Modal(document.getElementById('historicoModal'));
    modal.show();
    // Detener actualización al cerrar el modal
    document.getElementById('historicoModal').addEventListener('hidden.bs.modal', function() {
        clearInterval(historicoInterval);
    }, { once: true });
}

function generarValorSensor(sensorId) {
    if (sensorId === 'sensor1') return (120 + Math.random() * 10).toFixed(1);
    if (sensorId === 'sensor2') return (90 + Math.random() * 20).toFixed(1);
    if (sensorId === 'sensor3') return (40 + Math.random() * 10).toFixed(1);
    return (100 + Math.random() * 10).toFixed(1);
}

function actualizarHistoricoChart() {
    const now = new Date();
    historicoLabels.push(now.toLocaleTimeString() + ':' + now.getMilliseconds().toString().padStart(3, '0'));
    historicoData.push(generarValorSensor(historicoSensorId));
    if (historicoLabels.length > 60) {
        historicoLabels.shift();
        historicoData.shift();
    }
    if (historicoChart) {
        historicoChart.data.labels = [...historicoLabels];
        historicoChart.data.datasets[0].data = [...historicoData];
        historicoChart.update('none');
    }
}

function renderHistoricoChart(labels, data, sensorId) {
    const ctx = document.getElementById('graficaHistorico').getContext('2d');
    if (historicoChart) {
        historicoChart.destroy();
    }
    historicoChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: sensorId === 'sensor2' ? 'Temperatura (°F)' : 'Presión (PSI)',
                data: data,
                borderColor: sensorId === 'sensor1' ? '#007bff' : sensorId === 'sensor2' ? '#28a745' : '#dc3545',
                backgroundColor: 'rgba(0,0,0,0.05)',
                tension: 0.3,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: { display: true },
                title: { display: false }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Hora' },
                    ticks: { maxRotation: 45, minRotation: 45, autoSkip: true }
                },
                y: {
                    title: { display: true, text: sensorId === 'sensor2' ? 'Temperatura (°F)' : 'Presión (PSI)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function buscarHistorico() {
    // Solo refrescar el gráfico, sin overlays ni efectos visuales
    const sensorId = document.getElementById('tituloGrafica').textContent.split(' - ')[1] || 'sensor1';
    abrirModal(sensorId);
}
</script>
{% endblock %}
