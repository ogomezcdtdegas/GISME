{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoreo Coriolis - GISME{% endblock %}

{% block extra_css %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/monitoreo.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-common.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-spa.css' %}">
<link rel="stylesheet" href="{% static 'css/soft-colors.css' %}">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<style>
.hidden {
    display: none !important;
}
</style>

<script>
// Variables globales del sistema desde Django
let SISTEMA_ACTUAL;

// Configuraci√≥n del sistema desde Django template
/*{% if sistema %}*/
    SISTEMA_ACTUAL = {
        id: '{{ sistema.id|default:"" }}',
        tag: '{{ sistema.tag|default:"" }}',
        sistema_id: '{{ sistema.sistema_id|default:"" }}',
        nombre: '{{ sistema.nombre|default:"" }}'
    };
/*{% else %}*/
    SISTEMA_ACTUAL = null;
/*{% endif %}*/
</script>

<div class="container-fluid mt-4">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3">
                <h5>Cargando Monitoreo Coriolis...</h5>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE SELECCI√ìN DE SISTEMAS ============ -->
    <div id="sistema-selector-view">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Monitoreo Coriolis
                        </h4>
                        <p class="mb-0 mt-2">Seleccione el sistema que desea monitorear</p>
                    </div>
                    <div class="card-body">
                        <!-- Barra de b√∫squeda -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar sistemas...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary" id="clearSearch">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de sistemas -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('tag')">
                                                Nombre <i class="bi bi-arrow-up-down ms-1" id="tag-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('sistema_id')">
                                                MAC Gateway <i class="bi bi-arrow-up-down ms-1" id="sistema_id-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('ubicacion_nombre')">
                                                Ubicaci√≥n <i class="bi bi-arrow-up-down ms-1" id="ubicacion_nombre-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">Coordenadas</th>
                                        <th scope="col">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="sistemasTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            Cargando sistemas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginaci√≥n -->
                        <div id="pagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE MONITOREO DE SISTEMA ESPEC√çFICO ============ -->
    <div id="sistema-monitoring-view" class="hidden">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0)" onclick="showSelectorView()">Monitoreo Coriolis</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbSistema">
                            Sistema
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header coriolis-header-system text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="sistemaTitle">
                                <i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis
                            </h4>
                            <small class="text-light opacity-75">
                                <i class="bi bi-clock"></i> √öltima actualizaci√≥n: 
                                <span id="ultima-actualizacion">---</span> (Hora Colombia)
                            </small>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger btn-sm me-2" onclick="descargarReportePDF()">
                                <i class="bi bi-file-earmark-pdf"></i> Descargar Reporte PDF
                            </button>
                            <button class="btn btn-light btn-sm" onclick="showSelectorView()">
                                <i class="bi bi-arrow-left"></i> Cambiar Sistema
                            </button>
                        </div>
                        <!-- Contenedor oculto para el reporte PDF -->
                        <div id="reportePDF" style="display:none; max-width:600px;">
                            <h3>Reporte del Sistema Coriolis</h3>
                            <p><strong>Sistema:</strong> <span id="pdf-sistema-nombre"></span></p>
                            <p><strong>Estado:</strong> <span id="pdf-sistema-estado"></span></p>
                            <p><strong>Temperatura actual:</strong> <span id="pdf-temperatura"></span></p>
                            <div>
                                <canvas id="pdf-grafica-temperatura" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">

                            <!-- Imagen descriptiva del sistema con marcadores interactivos -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-pipe"></i> Esquema del Sistema Coriolis</h5>
                                        </div>
                                        <div class="card-body coriolis-card-body text-center" style="overflow: auto; max-height: 700px;">
                                            <div class="img-container" style="position:relative; max-width:1050px; margin:auto;">
                                                <img src="{% static 'img/coriolis_render2.png' %}" class="img-fluid" id="sistema-img" style="max-width:100%; height:auto;">
                                                <!-- Displays de sensores -->
                                                <div style="position:absolute; top:33%; left:32%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Flujo</div>
                                                    <div id="display-sensor1" style="font-size:15px; color:#007bff; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <div style="position:absolute; top:73%; left:58%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Temperatura</div>
                                                    <div id="display-sensor2" style="font-size:15px; color:#28a745; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <div style="position:absolute; top:7%; left:56%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Presi√≥n</div>
                                                    <div id="display-sensor3" style="font-size:15px; color:#dc3545; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <!-- Marcadores transparentes clickeables -->
                                                <button class="marker" style="position:absolute; top:45%; left:35%; width:32px; height:32px; border-radius:50%; background:rgba(0,123,255,0); border:none; cursor:pointer;" onclick="abrirModal('sensor1')" title="Ver hist√≥rico Sensor 1"></button>
                                                <button class="marker" style="position:absolute; top:58%; left:61.5%; width:32px; height:32px; border-radius:50%; background:rgba(40,167,69,0); border:none; cursor:pointer;" onclick="abrirModal('sensor2')" title="Ver hist√≥rico Sensor 2"></button>
                                                <button class="marker" style="position:absolute; top:23%; left:58%; width:32px; height:32px; border-radius:50%; background:rgba(220,53,69,0); border:none; cursor:pointer;" onclick="abrirModal('sensor3')" title="Ver hist√≥rico Sensor 3"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- Panel de Estado -->
                            <div class="col-lg-8 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-activity"></i> Estado del Sistema</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaInfo" class="metrics-container">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2">Cargando informaci√≥n del sistema...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de Ubicaci√≥n -->
                            <div class="col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-geo-alt"></i> Ubicaci√≥n</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaMap" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        

                        <!-- Gr√°ficos de Tendencias -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-graph-up"></i> Tendencias de Medici√≥n</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Mapa -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">
                    <i class="bi bi-geo-alt"></i> Ubicaci√≥n del Sistema
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Sistema:</strong>
                        <div id="modal-sistema-info">-</div>
                    </div>
                    <div class="col-md-4">
                        <strong>Ubicaci√≥n:</strong>
                        <div id="modal-ubicacion-info">-</div>
                    </div>
                    <div class="col-md-4">
                        <strong>Coordenadas:</strong>
                        <div id="modal-coordenadas-info">-</div>
                    </div>
                </div>
                <div id="map" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="copyCoordinates()">
                    <i class="bi bi-clipboard"></i> Copiar Coordenadas
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Hist√≥rico con dos gr√°ficos para flujo -->
<div class="modal fade" id="historicoModal" tabindex="-1" aria-labelledby="historicoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historicoModalLabel">
          <i class="bi bi-graph-up"></i> Hist√≥rico de Flujo
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Controles superiores -->
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="d-flex align-items-center gap-3">
              <label><strong>Rango de fechas:</strong></label>
              <input type="date" id="fechaInicio" class="form-control" style="width: auto;">
              <span>‚Üí</span>
              <input type="date" id="fechaFin" class="form-control" style="width: auto;">
              <button id="buscarHistoricoFlujo" class="btn btn-outline-success">
                <i class="bi bi-search"></i> Buscar
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button id="volverTiempoReal" type="button" class="btn btn-outline-warning btn-sm me-2" onclick="resetearAModoTiempoReal()">
              <i class="bi bi-arrow-clockwise"></i> Volver a Tiempo Real
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" onclick="exportarDatos()">
              <i class="bi bi-download"></i> Exportar Datos
            </button>
          </div>
        </div>
        
        <!-- Instrucciones de uso -->
        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle"></i>
          <strong>Informaci√≥n:</strong> 
          Los gr√°ficos muestran los datos de flujo volum√©trico y m√°sico para el per√≠odo seleccionado.
          <strong>Hover</strong> sobre los puntos para ver detalles de cada medici√≥n.
        </div>
        
        <!-- Dos gr√°ficos lado a lado -->
        <div class="row">
          <!-- Flujo Volum√©trico -->
          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Flujo Volum√©trico</h6>
                <span id="contador-volumetrico" class="badge bg-light text-primary">0 registros</span>
              </div>
              <div class="card-body">
                <div style="height: 350px; position: relative;">
                  <canvas id="graficaFlujoVolumetrico"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Flujo M√°sico -->
          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Flujo M√°sico</h6>
                <span id="contador-masico" class="badge bg-light text-success">0 registros</span>
              </div>
              <div class="card-body">
                <div style="height: 350px; position: relative;">
                  <canvas id="graficaFlujoMasico"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n adicional -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="alert alert-secondary">
              <i class="bi bi-clock-history"></i>
              <strong>Informaci√≥n:</strong> Los gr√°ficos muestran los datos de flujo volum√©trico (m¬≥/h) y flujo m√°sico (kg/h) para el per√≠odo seleccionado.
              <span id="info-periodo"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jsPDF y html2canvas para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
async function descargarReportePDF() {
    // Llena los datos del reporte
    const sistemaNombre = document.getElementById('sistemaTitle').textContent.trim();
    const sistemaEstado = document.getElementById('sistemaInfo')?.textContent.trim() || 'N/A';
    const tempText = document.getElementById('display-sensor2').textContent;
    document.getElementById('pdf-sistema-nombre').textContent = sistemaNombre;
    document.getElementById('pdf-sistema-estado').textContent = sistemaEstado;
    document.getElementById('pdf-temperatura').textContent = tempText;

    // Dibuja el gr√°fico de temperatura usando Chart.js
    const temp = parseFloat(tempText);
    const ctx = document.getElementById('pdf-grafica-temperatura').getContext('2d');
    if (window.pdfChart) {
        window.pdfChart.destroy();
    }
    window.pdfChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 10}, (_, i) => `T-${10 - i}`),
            datasets: [{
                label: 'Temperatura (¬∞F)',
                data: Array.from({length: 9}, () => (90 + Math.random() * 20).toFixed(1)).concat([temp]),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40,167,69,0.1)',
                tension: 0.3,
                pointRadius: 2
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: { display: true },
                title: { display: false }
            },
            scales: {
                x: { title: { display: true, text: 'Tiempo' } },
                y: { title: { display: true, text: 'Temperatura (¬∞F)' }, beginAtZero: true }
            }
        }
    });

    // Espera a que Chart.js termine de renderizar
    await new Promise(resolve => setTimeout(resolve, 300));

    // Muestra el contenedor temporalmente para capturarlo
    const reporte = document.getElementById('reportePDF');
    reporte.style.display = 'block';

    // Usa html2canvas para capturar el reporte
    const canvas = await html2canvas(reporte, {backgroundColor: "#fff"});
    const imgData = canvas.toDataURL('image/png');

    // Crea el PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    // T√≠tulo y datos generales
    pdf.setFontSize(16);
    pdf.text('Reporte del Sistema Coriolis', 15, 15);
    pdf.setFontSize(12);
    pdf.text('Sistema: ' + sistemaNombre, 15, 25);
    pdf.text('Estado: ' + sistemaEstado, 15, 32);
    pdf.text('Temperatura actual: ' + tempText, 15, 39);
    // Imagen del gr√°fico
    pdf.addImage(imgData, 'PNG', 10, 45, 190, 0);
    pdf.save('reporte_coriolis.pdf');

    // Oculta el contenedor de nuevo
    reporte.style.display = 'none';
}
</script>
<!-- Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Scripts locales de Coriolis -->
<script src="{% static 'js/coriolis-common.js' %}"></script>
<script src="{% static 'js/coriolis-map.js' %}"></script>
<script src="{% static 'js/coriolis-spa.js' %}"></script>
<script>
// =====================
// SISTEMA CON DATOS REALES DE LA BASE DE DATOS
// =====================

// Variables globales para controlar los gr√°ficos
let sistemaActual = null;
let chartFlujoVolumetrico = null;
let chartFlujoMasico = null;
let tiempoRealInterval = null;

// Variables para controlar el modo de los gr√°ficos
let modoTiempoReal = true; // true = √∫ltimos 7 d√≠as actualiz√°ndose, false = filtrado est√°tico
let intervalActualizacionGraficos = null;

// Funci√≥n para obtener el sistema actual (prioridad: contexto Django > URL)
function obtenerSistemaActual() {
    // 1. Primero intentar obtener del contexto de Django
    if (typeof SISTEMA_ACTUAL !== 'undefined' && SISTEMA_ACTUAL && SISTEMA_ACTUAL.id) {
        // console.log('‚úÖ Sistema obtenido desde contexto Django:', SISTEMA_ACTUAL.tag);
        return SISTEMA_ACTUAL.id;
    }
    
    // 2. Fallback: intentar extraer de la URL
    const url = window.location.pathname;
    const match = url.match(/\/sistema\/([a-f0-9-]{36})\//);
    if (match) {
        // console.log('‚úÖ Sistema obtenido desde URL:', match[1]);
        return match[1];
    }
    
    console.warn('‚ö†Ô∏è No se pudo obtener ID del sistema desde contexto Django ni URL');
    return null;
}

// Funci√≥n para actualizar displays con datos reales
async function actualizarDisplaysConDatosReales() {
    const sistemaId = obtenerSistemaActual();
    if (!sistemaId) {
        console.warn('No se detect√≥ un sistema espec√≠fico en la URL');
        return;
    }
    
    try {
        const response = await fetch(`/monitoreo/api/datos-tiempo-real/${sistemaId}/`);
        const data = await response.json();
        
        if (data.success) {
            // Actualizar displays con datos reales
            document.getElementById('display-sensor1').textContent = 
                `${data.datos.flujo.valor.toFixed(1)} ${data.datos.flujo.unidad}`;
            document.getElementById('display-sensor2').textContent = 
                `${data.datos.temperatura.valor.toFixed(1)} ${data.datos.temperatura.unidad}`;
            document.getElementById('display-sensor3').textContent = 
                `${data.datos.presion.valor.toFixed(1)} ${data.datos.presion.unidad}`;
            
            // Actualizar fecha de √∫ltima actualizaci√≥n
            const ultimaActualizacion = document.getElementById('ultima-actualizacion');
            if (ultimaActualizacion && data.fecha_legible) {
                ultimaActualizacion.textContent = data.fecha_legible;
            }
                
            // console.log('‚úÖ Datos tiempo real actualizados:', data.timestamp);
        } else {
            // console.error('‚ùå Error obteniendo datos tiempo real:', data.error);
            // Fallback a valores por defecto
            mostrarDatosNoDisponibles();
        }
    } catch (error) {
        // console.error('‚ùå Error en la petici√≥n de datos tiempo real:', error);
        mostrarDatosNoDisponibles();
    }
}

// Funci√≥n fallback para mostrar mensaje cuando no hay datos
function mostrarDatosNoDisponibles() {
    document.getElementById('display-sensor1').textContent = 'Sin datos';
    document.getElementById('display-sensor2').textContent = 'Sin datos';
    document.getElementById('display-sensor3').textContent = 'Sin datos';
    
    const ultimaActualizacion = document.getElementById('ultima-actualizacion');
    if (ultimaActualizacion) {
        ultimaActualizacion.textContent = 'Sin datos';
    }
}

// Funci√≥n para cargar datos de los √∫ltimos 7 d√≠as (MODO TIEMPO REAL)
async function cargarUltimos7DiasDinamico(sistemaId) {
    try {
        // Calcular fechas de los √∫ltimos 7 d√≠as
        const fechaFin = new Date();
        const fechaInicio = new Date();
        fechaInicio.setDate(fechaFin.getDate() - 7);
        
        const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
        const fechaFinStr = fechaFin.toISOString().split('T')[0];
        
        const url = `/monitoreo/api/datos-flujo/${sistemaId}/?fecha_inicio=${fechaInicioStr}&fecha_fin=${fechaFinStr}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            // console.log('üîÑ Cargando datos reales de √∫ltimos 7 d√≠as:', {
            //     volumetrico: data.flujo_volumetrico.total_registros,
            //     masico: data.flujo_masico.total_registros
            // });
            
            // Renderizar gr√°ficos en modo tiempo real
            renderGraficoFlujoVolumetrico(data.flujo_volumetrico, true);
            renderGraficoFlujoMasico(data.flujo_masico, true);
            
            // Actualizar contadores con indicaci√≥n de tiempo real
            document.getElementById('contador-volumetrico').textContent = 
                `${data.flujo_volumetrico.total_registros} registros (√öltimos 7 d√≠as - Actualizando)`;
            document.getElementById('contador-masico').textContent = 
                `${data.flujo_masico.total_registros} registros (√öltimos 7 d√≠as - Actualizando)`;
            
            // Actualizar informaci√≥n del per√≠odo
            const infoPeriodo = document.getElementById('info-periodo');
            if (infoPeriodo) {
                infoPeriodo.textContent = ` √öltimos 7 d√≠as - Se actualiza autom√°ticamente`;
            }
            
            return true;
        } else {
            // console.error('‚ùå Error cargando datos de √∫ltimos 7 d√≠as:', data.error);
            renderGraficosVacios('Error: ' + data.error);
            return false;
        }
    } catch (error) {
        // console.error('‚ùå Error en la petici√≥n de √∫ltimos 7 d√≠as:', error);
        renderGraficosVacios('Error de conexi√≥n');
        return false;
    }
}

// Funci√≥n para inicializar modo tiempo real (√∫ltimos 7 d√≠as que se actualizan)
function inicializarModoTiempoReal() {
    const sistemaId = obtenerSistemaActual();
    if (!sistemaId) return;
    
    // console.log('üîÑ Iniciando modo tiempo real - √∫ltimos 7 d√≠as din√°mico');
    modoTiempoReal = true;
    
    // Cargar datos iniciales
    cargarUltimos7DiasDinamico(sistemaId);
    
    // Configurar actualizaci√≥n autom√°tica cada 30 segundos
    if (intervalActualizacionGraficos) {
        clearInterval(intervalActualizacionGraficos);
    }
    
    intervalActualizacionGraficos = setInterval(async () => {
        if (modoTiempoReal) {
            // console.log('üîÑ Actualizando gr√°ficos autom√°ticamente...');
            await cargarUltimos7DiasDinamico(sistemaId);
        }
    }, 30000); // Cada 30 segundos
    
    // console.log('‚úÖ Modo tiempo real iniciado - se actualiza cada 30 segundos');
}

// Funci√≥n para cambiar a modo filtrado (est√°tico)
function cambiarAModoFiltrado() {
    // console.log('‚è∏Ô∏è Cambiando a modo filtrado - pausando actualizaciones autom√°ticas');
    modoTiempoReal = false;
    
    // Detener actualizaciones autom√°ticas
    if (intervalActualizacionGraficos) {
        clearInterval(intervalActualizacionGraficos);
        intervalActualizacionGraficos = null;
    }
}

// Funci√≥n para configurar eventos del modal
function configurarEventosModal() {
    // Agregar evento al bot√≥n buscar
    const btnBuscar = document.getElementById('buscarHistoricoFlujo');
    if (btnBuscar) {
        btnBuscar.onclick = function() {
            cambiarAModoFiltrado();  // Cambiar a modo filtrado
            buscarHistoricoFlujo();   // Buscar con filtros
        };
    }
    
    // Agregar evento al bot√≥n reset (volver a tiempo real)
    const btnReset = document.getElementById('volverTiempoReal');
    if (btnReset) {
        btnReset.onclick = resetearAModoTiempoReal;
    }
    
    // console.log('üîß Eventos del modal configurados');
}

// Funci√≥n para resetear a modo tiempo real
function resetearAModoTiempoReal() {
    // console.log('‚ñ∂Ô∏è Reseteando a modo tiempo real - √∫ltimos 7 d√≠as din√°mico');
    
    // Resetear fechas a valores por defecto (√∫ltimos 7 d√≠as)
    const fechaFin = new Date();
    const fechaInicio = new Date();
    fechaInicio.setDate(fechaFin.getDate() - 7);
    
    document.getElementById('fechaInicio').value = fechaInicio.toISOString().split('T')[0];
    document.getElementById('fechaFin').value = fechaFin.toISOString().split('T')[0];
    
    // Reiniciar modo tiempo real
    inicializarModoTiempoReal();
}

// Funci√≥n para abrir modal de flujo (sensor1) con dos gr√°ficos REALES
async function abrirModal(sensorId) {
    if (sensorId !== 'sensor1') {
        // Para sensor2 y sensor3, mostrar mensaje temporal
        alert(`Funcionalidad para ${sensorId} en desarrollo.\nActualmente solo est√° disponible el hist√≥rico de flujo (sensor1).`);
        return;
    }
    
    const sistemaId = obtenerSistemaActual();
    if (!sistemaId) {
        // console.error('‚ùå No se pudo obtener el ID del sistema');
        alert('Error: No se pudo identificar el sistema actual.\n\nVerifique que:\n1. Est√° accediendo desde un sistema espec√≠fico\n2. El sistema existe en la base de datos\n3. La URL contiene el ID del sistema');
        return;
    }
    
    // Configurar fechas por defecto (√∫ltimos 7 d√≠as)
    const fechaFin = new Date();
    const fechaInicio = new Date();
    fechaInicio.setDate(fechaFin.getDate() - 7);
    
    document.getElementById('fechaInicio').value = fechaInicio.toISOString().split('T')[0];
    document.getElementById('fechaFin').value = fechaFin.toISOString().split('T')[0];
    
    // Iniciar en modo tiempo real por defecto (√∫ltimos 7 d√≠as que se actualizan)
    inicializarModoTiempoReal();
    
    // Mostrar modal
    var modal = new bootstrap.Modal(document.getElementById('historicoModal'));
    modal.show();
    
    // Configurar eventos del modal
    configurarEventosModal();
    
    // console.log(`‚úÖ Modal de flujo abierto para sistema: ${sistemaId}`);
}

// Funci√≥n para renderizar gr√°fico de flujo volum√©trico CON DATOS REALES
function renderGraficoFlujoVolumetrico(datosVolumetrico) {
    const ctx = document.getElementById('graficaFlujoVolumetrico').getContext('2d');
    
    if (chartFlujoVolumetrico) {
        chartFlujoVolumetrico.destroy();
    }
    
    const labels = datosVolumetrico.datos.map(item => item.fecha);
    const valores = datosVolumetrico.datos.map(item => item.valor);
    
    chartFlujoVolumetrico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `Flujo Volum√©trico (${datosVolumetrico.unidad})`,
                data: valores,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.3,
                pointRadius: 1,
                pointHoverRadius: 4,
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#007bff',
                    borderWidth: 1,
                    callbacks: {
                        title: function(tooltipItems) {
                            return 'Fecha: ' + tooltipItems[0].label;
                        },
                        label: function(tooltipItem) {
                            return `${tooltipItem.dataset.label}: ${tooltipItem.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Fecha y Hora',
                        color: '#666',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: { 
                        maxRotation: 45, 
                        minRotation: 45, 
                        autoSkip: true,
                        maxTicksLimit: 10,
                        color: '#666'
                    },
                    grid: {
                        color: '#e0e0e0',
                        lineWidth: 0.5
                    }
                },
                y: {
                    title: { 
                        display: true, 
                        text: `Flujo Volum√©trico (${datosVolumetrico.unidad})`,
                        color: '#666',
                        font: { size: 12, weight: 'bold' }
                    },
                    beginAtZero: false,
                    ticks: {
                        color: '#666',
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    },
                    grid: {
                        color: '#e0e0e0',
                        lineWidth: 0.5
                    }
                }
            },
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            hover: {
                mode: 'nearest',
                intersect: false
            }
        }
    });
}

// Funci√≥n para renderizar gr√°fico de flujo m√°sico CON DATOS REALES
function renderGraficoFlujoMasico(datosMasico) {
    const ctx = document.getElementById('graficaFlujoMasico').getContext('2d');
    
    if (chartFlujoMasico) {
        chartFlujoMasico.destroy();
    }
    
    const labels = datosMasico.datos.map(item => item.fecha);
    const valores = datosMasico.datos.map(item => item.valor);
    
    chartFlujoMasico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `Flujo M√°sico (${datosMasico.unidad})`,
                data: valores,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.3,
                pointRadius: 1,
                pointHoverRadius: 4,
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#28a745',
                    borderWidth: 1,
                    callbacks: {
                        title: function(tooltipItems) {
                            return 'Fecha: ' + tooltipItems[0].label;
                        },
                        label: function(tooltipItem) {
                            return `${tooltipItem.dataset.label}: ${tooltipItem.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { 
                        display: true, 
                        text: 'Fecha y Hora',
                        color: '#666',
                        font: { size: 12, weight: 'bold' }
                    },
                    ticks: { 
                        maxRotation: 45, 
                        minRotation: 45, 
                        autoSkip: true,
                        maxTicksLimit: 10,
                        color: '#666'
                    },
                    grid: {
                        color: '#e0e0e0',
                        lineWidth: 0.5
                    }
                },
                y: {
                    title: { 
                        display: true, 
                        text: `Flujo M√°sico (${datosMasico.unidad})`,
                        color: '#666',
                        font: { size: 12, weight: 'bold' }
                    },
                    beginAtZero: false,
                    ticks: {
                        color: '#666',
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    },
                    grid: {
                        color: '#e0e0e0',
                        lineWidth: 0.5
                    }
                }
            },
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            hover: {
                mode: 'nearest',
                intersect: false
            }
        }
    });
}

// Funci√≥n para renderizar gr√°ficos vac√≠os con mensaje de error
function renderGraficosVacios(mensaje) {
    // Flujo Volum√©trico
    const ctxVol = document.getElementById('graficaFlujoVolumetrico').getContext('2d');
    if (chartFlujoVolumetrico) chartFlujoVolumetrico.destroy();
    
    chartFlujoVolumetrico = new Chart(ctxVol, {
        type: 'line',
        data: {
            labels: ['Sin datos'],
            datasets: [{
                label: mensaje,
                data: [0],
                borderColor: '#6c757d',
                backgroundColor: '#6c757d20'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: mensaje }
            }
        }
    });
    
    // Flujo M√°sico
    const ctxMas = document.getElementById('graficaFlujoMasico').getContext('2d');
    if (chartFlujoMasico) chartFlujoMasico.destroy();
    
    chartFlujoMasico = new Chart(ctxMas, {
        type: 'line',
        data: {
            labels: ['Sin datos'],
            datasets: [{
                label: mensaje,
                data: [0],
                borderColor: '#6c757d',
                backgroundColor: '#6c757d20'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: { display: true, text: mensaje }
            }
        }
    });
}

// Funci√≥n para exportar datos como CSV
function exportarDatos() {
    const sistemaId = obtenerSistemaActual();
    if (!sistemaId) {
        alert('No se pudo obtener el sistema actual');
        return;
    }
    
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!fechaInicio || !fechaFin) {
        alert('Por favor selecciona un rango de fechas v√°lido');
        return;
    }
    
    // Crear URL para descarga
    const url = `/monitoreo/api/datos-flujo/${sistemaId}/?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
    
    // Abrir en nueva ventana para descargar
    window.open(url, '_blank');
    
    // console.log('üì• Descargando datos para el per√≠odo:', fechaInicio, 'al', fechaFin);
}

// Mejorar la funci√≥n de carga de datos hist√≥ricos para mostrar contadores
async function cargarDatosHistoricosFlujo(sistemaId) {
    try {
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        const url = `/monitoreo/api/datos-flujo/${sistemaId}/?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            // Renderizar gr√°ficos
            renderGraficoFlujoVolumetrico(data.flujo_volumetrico);
            renderGraficoFlujoMasico(data.flujo_masico);
            
            // Actualizar contadores
            document.getElementById('contador-volumetrico').textContent = 
                `${data.flujo_volumetrico.total_registros} registros`;
            document.getElementById('contador-masico').textContent = 
                `${data.flujo_masico.total_registros} registros`;
            
            // Actualizar informaci√≥n del per√≠odo
            const infoPeriodo = document.getElementById('info-periodo');
            if (infoPeriodo) {
                infoPeriodo.textContent = ` Per√≠odo: ${fechaInicio} al ${fechaFin}`;
            }
                
            // console.log('‚úÖ Datos hist√≥ricos cargados:', {
            //     volumetrico: data.flujo_volumetrico.total_registros,
            //     masico: data.flujo_masico.total_registros
            // });
        } else {
            // console.error('‚ùå Error cargando datos hist√≥ricos de flujo:', data.error);
            renderGraficosVacios('Error: ' + data.error);
        }
    } catch (error) {
        // console.error('‚ùå Error en la petici√≥n de datos hist√≥ricos de flujo:', error);
        renderGraficosVacios('Error de conexi√≥n');
    }
}

// Funci√≥n para buscar hist√≥rico con filtros de fecha (BOT√ìN BUSCAR)
async function buscarHistoricoFlujo() {
    const sistemaId = obtenerSistemaActual();
    if (!sistemaId) {
        alert('Error: No se pudo identificar el sistema actual para realizar la b√∫squeda.');
        return;
    }
    
    // console.log('üîç Buscando hist√≥rico con nuevos filtros...');
    await cargarDatosHistoricosFlujo(sistemaId);
}

// Inicializaci√≥n cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // console.log('üöÄ Iniciando sistema de monitoreo Coriolis con datos REALES');
    
    // Mostrar informaci√≥n de debugging
    // console.log('üîç Informaci√≥n del contexto:');
    // console.log('  - SISTEMA_ACTUAL disponible:', typeof SISTEMA_ACTUAL !== 'undefined' && SISTEMA_ACTUAL);
    // console.log('  - URL actual:', window.location.pathname);
    
    const sistemaId = obtenerSistemaActual();
    
    if (sistemaId) {
        // console.log(`‚úÖ Sistema detectado: ${sistemaId}`);
        
        // Mostrar informaci√≥n adicional si viene del contexto Django
        if (typeof SISTEMA_ACTUAL !== 'undefined' && SISTEMA_ACTUAL) {
            // console.log(`  - Tag: ${SISTEMA_ACTUAL.tag}`);
            // console.log(`  - Sistema ID: ${SISTEMA_ACTUAL.sistema_id}`);
        }
        
        // ‚úÖ L√ìGICA CORREGIDA: Si se detecta cualquier sistema (contexto Django O URL), mostrar vista de monitoreo
        mostrarVistaMonitoreo();
        
        // Actualizar displays inmediatamente
        actualizarDisplaysConDatosReales();
        
        // Configurar actualizaci√≥n autom√°tica cada 5 segundos
        if (tiempoRealInterval) clearInterval(tiempoRealInterval);
        tiempoRealInterval = setInterval(actualizarDisplaysConDatosReales, 5000);
        
        console.log('‚è∞ Actualizaci√≥n autom√°tica configurada cada 5 segundos');
    } else {
        console.warn('‚ö†Ô∏è No se detect√≥ un sistema espec√≠fico - mostrar tabla de selecci√≥n');
        // Mostrar la vista de selecci√≥n de sistemas
        mostrarVistaSelector();
        // Fallback a datos simulados para vista general
        actualizarDisplaysSimulados();
    }
});

// Funci√≥n para mostrar la vista de monitoreo
function mostrarVistaMonitoreo() {
    console.log('üìä Mostrando vista de monitoreo espec√≠fica');
    
    // Ocultar vista de selector
    const selectorView = document.getElementById('sistema-selector-view');
    if (selectorView) {
        selectorView.classList.add('hidden');
        selectorView.style.display = 'none';
        console.log('‚úÖ Vista selector ocultada');
    } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ elemento sistema-selector-view');
    }
    
    // Mostrar vista de monitoreo
    const monitoringView = document.getElementById('sistema-monitoring-view');
    if (monitoringView) {
        monitoringView.classList.remove('hidden');
        monitoringView.style.display = 'block';
        console.log('‚úÖ Vista monitoreo mostrada');
    } else {
        // console.error('‚ùå No se encontr√≥ elemento sistema-monitoring-view');
    }
    
    // Actualizar informaci√≥n del breadcrumb y t√≠tulo 
    if (typeof SISTEMA_ACTUAL !== 'undefined' && SISTEMA_ACTUAL) {
        // Si hay contexto Django, usar esa informaci√≥n
        const breadcrumbSistema = document.getElementById('breadcrumbSistema');
        if (breadcrumbSistema) {
            breadcrumbSistema.textContent = `${SISTEMA_ACTUAL.tag} - ${SISTEMA_ACTUAL.sistema_id}`;
        }
        
        const sistemaTitle = document.getElementById('sistemaTitle');
        if (sistemaTitle) {
            sistemaTitle.innerHTML = `<i class="bi bi-diagram-3"></i> ${SISTEMA_ACTUAL.tag} - Monitoreo Coriolis`;
        }
    } else {
        // Si no hay contexto Django pero s√≠ sistemId por URL, mostrar gen√©rico
        const sistemaId = obtenerSistemaActual();
        if (sistemaId) {
            const breadcrumbSistema = document.getElementById('breadcrumbSistema');
            if (breadcrumbSistema) {
                breadcrumbSistema.textContent = `Sistema ${sistemaId.substring(0, 8)}...`;
            }
            
            const sistemaTitle = document.getElementById('sistemaTitle');
            if (sistemaTitle) {
                sistemaTitle.innerHTML = `<i class="bi bi-diagram-3"></i> Sistema ${sistemaId.substring(0, 8)}... - Monitoreo Coriolis`;
            }
        }
    }
}

// Funci√≥n para mostrar la vista de selector
function mostrarVistaSelector() {
    console.log('üìã Mostrando vista de selecci√≥n de sistemas');
    
    // Mostrar vista de selector
    const selectorView = document.getElementById('sistema-selector-view');
    if (selectorView) {
        selectorView.classList.remove('hidden');
        selectorView.style.display = 'block';
        console.log('‚úÖ Vista selector mostrada');
    } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ elemento sistema-selector-view');
    }
    
    // Ocultar vista de monitoreo
    const monitoringView = document.getElementById('sistema-monitoring-view');
    if (monitoringView) {
        monitoringView.classList.add('hidden');
        monitoringView.style.display = 'none';
        console.log('‚úÖ Vista monitoreo ocultada');
    } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ elemento sistema-monitoring-view');
    }
}

// Funci√≥n fallback para datos simulados (cuando no hay sistema espec√≠fico)
function actualizarDisplaysSimulados() {
    const val1 = (120 + Math.random() * 10).toFixed(1);
    document.getElementById('display-sensor1').textContent = val1 + ' m¬≥/h';
    const val2 = (90 + Math.random() * 20).toFixed(1);
    document.getElementById('display-sensor2').textContent = val2 + ' ¬∞F';
    const val3 = (40 + Math.random() * 10).toFixed(1);
    document.getElementById('display-sensor3').textContent = val3 + ' PSI';
}

// Limpiar intervals cuando se abandone la p√°gina
window.addEventListener('beforeunload', function() {
    if (tiempoRealInterval) {
        clearInterval(tiempoRealInterval);
        console.log('üßπ Intervals limpiados al salir de la p√°gina');
    }
});

// Funci√≥n alias para compatibilidad con botones existentes
function showSelectorView() {
    console.log('üîÑ Cambiando a vista de selector (showSelectorView)');
    mostrarVistaSelector();
    
    // Tambi√©n detener actualizaciones autom√°ticas cuando volvemos al selector
    if (tiempoRealInterval) {
        clearInterval(tiempoRealInterval);
        tiempoRealInterval = null;
        console.log('‚è∏Ô∏è Actualizaciones autom√°ticas pausadas');
    }
}

console.log('‚úÖ Sistema de monitoreo Coriolis con datos REALES cargado');
</script>
{% endblock %}
