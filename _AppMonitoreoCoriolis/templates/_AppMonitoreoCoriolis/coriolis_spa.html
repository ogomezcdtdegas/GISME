{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoreo Coriolis - GISME{% endblock %}

{% block extra_css %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/monitoreo.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-common.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-spa.css' %}">
<link rel="stylesheet" href="{% static 'css/soft-colors.css' %}">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<style>
.hidden {
    display: none !important;
}
</style>

<script>
// Variables globales del sistema desde Django
let SISTEMA_ACTUAL;

// Configuración del sistema desde Django template
/*{% if sistema %}*/
    SISTEMA_ACTUAL = {
        id: '{{ sistema.id|default:"" }}',
        tag: '{{ sistema.tag|default:"" }}',
        sistema_id: '{{ sistema.sistema_id|default:"" }}',
        nombre: '{{ sistema.nombre|default:"" }}'
    };
/*{% else %}*/
    SISTEMA_ACTUAL = null;
/*{% endif %}*/
</script>

<!-- Variables globales se mantienen aquí para Django template -->

<div class="container-fluid mt-4">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3">
                <h5>Cargando Monitoreo Coriolis...</h5>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE SELECCIÓN DE SISTEMAS ============ -->
    <div id="sistema-selector-view">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Monitoreo Coriolis
                        </h4>
                        <p class="mb-0 mt-2">Seleccione el sistema que desea monitorear</p>
                    </div>
                    <div class="card-body">
                        <!-- Barra de búsqueda -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar sistemas...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary" id="clearSearch">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de sistemas -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('tag')">
                                                Nombre <i class="bi bi-arrow-up-down ms-1" id="tag-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('sistema_id')">
                                                MAC Gateway <i class="bi bi-arrow-up-down ms-1" id="sistema_id-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('ubicacion_nombre')">
                                                Ubicación <i class="bi bi-arrow-up-down ms-1" id="ubicacion_nombre-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">Coordenadas</th>
                                        <th scope="col">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="sistemasTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            Cargando sistemas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        <div id="pagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE MONITOREO DE SISTEMA ESPECÍFICO ============ -->
    <div id="sistema-monitoring-view" class="hidden">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0)" onclick="showSelectorView()">Monitoreo Coriolis</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbSistema">
                            Sistema
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header coriolis-header-system text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="sistemaTitle">
                                <i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis
                            </h4>
                            <small class="text-light opacity-75">
                                <i class="bi bi-clock"></i> Última actualización: 
                                <span id="ultima-actualizacion">---</span> (Hora Colombia)
                            </small>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger btn-sm me-2" onclick="descargarReportePDF()">
                                <i class="bi bi-file-earmark-pdf"></i> Descargar Reporte PDF
                            </button>
                            <button class="btn btn-light btn-sm" onclick="showSelectorView()">
                                <i class="bi bi-arrow-left"></i> Cambiar Sistema
                            </button>
                        </div>
                        <!-- Contenedor oculto para el reporte PDF -->
                        <div id="reportePDF" style="display:none; max-width:600px;">
                            <h3>Reporte del Sistema Coriolis</h3>
                            <p><strong>Sistema:</strong> <span id="pdf-sistema-nombre"></span></p>
                            <p><strong>Estado:</strong> <span id="pdf-sistema-estado"></span></p>
                            <p><strong>Temperatura actual:</strong> <span id="pdf-temperatura"></span></p>
                            <div>
                                <canvas id="pdf-grafica-temperatura" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">

                            <!-- Imagen descriptiva del sistema con marcadores interactivos -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="bi bi-pipe"></i> Esquema del Sistema Coriolis</h5>
                                        </div>
                                        <div class="card-body coriolis-card-body text-center" style="overflow: auto; max-height: 700px;">
                                            <div class="img-container" style="position:relative; max-width:1050px; margin:auto;">
                                                <img src="{% static 'img/coriolis_render2.png' %}" class="img-fluid" id="sistema-img" style="max-width:100%; height:auto;">
                                                <!-- Displays de sensores -->
                                                <div style="position:absolute; top:33%; left:32%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Flujo</div>
                                                    <div id="display-sensor1" style="font-size:15px; color:#007bff; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <div style="position:absolute; top:73%; left:58%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Temperatura</div>
                                                    <div id="display-sensor2" style="font-size:15px; color:#28a745; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <div style="position:absolute; top:7%; left:56%; min-width:90px; z-index:2;">
                                                <div class="shadow-sm" style="background:#fff; border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                                    <div style="font-weight:600; color:#888;">Presión</div>
                                                    <div id="display-sensor3" style="font-size:15px; color:#dc3545; font-weight:700;">---</div>
                                                </div>
                                                </div>
                                                <!-- Marcadores transparentes clickeables -->
                                                <button class="marker" style="position:absolute; top:45%; left:35%; width:32px; height:32px; border-radius:50%; background:rgba(0,123,255,0); border:none; cursor:pointer;" onclick="abrirModal('sensor1')" title="Ver histórico Sensor 1"></button>
                                                <button class="marker" style="position:absolute; top:58%; left:61.5%; width:32px; height:32px; border-radius:50%; background:rgba(40,167,69,0); border:none; cursor:pointer;" onclick="abrirModal('sensor2')" title="Ver histórico Sensor 2"></button>
                                                <button class="marker" style="position:absolute; top:23%; left:58%; width:32px; height:32px; border-radius:50%; background:rgba(220,53,69,0); border:none; cursor:pointer;" onclick="abrirModal('sensor3')" title="Ver histórico Sensor 3"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- Panel de Estado -->
                            <div class="col-lg-8 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-activity"></i> Estado del Sistema</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaInfo" class="metrics-container">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2">Cargando información del sistema...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de Ubicación -->
                            <div class="col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-geo-alt"></i> Ubicación</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaMap" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        

                        <!-- Gráficos de Tendencias -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-graph-up"></i> Tendencias de Medición</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Mapa -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">
                    <i class="bi bi-geo-alt"></i> Ubicación del Sistema
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Sistema:</strong>
                        <div id="modal-sistema-info">-</div>
                    </div>
                    <div class="col-md-4">
                        <strong>Ubicación:</strong>
                        <div id="modal-ubicacion-info">-</div>
                    </div>
                    <div class="col-md-4">
                        <strong>Coordenadas:</strong>
                        <div id="modal-coordenadas-info">-</div>
                    </div>
                </div>
                <div id="map" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="copyCoordinates()">
                    <i class="bi bi-clipboard"></i> Copiar Coordenadas
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Histórico con dos gráficos para flujo -->
<div class="modal fade" id="historicoModal" tabindex="-1" aria-labelledby="historicoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historicoModalLabel">
          <i class="bi bi-graph-up"></i> Histórico de Flujo
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Controles superiores -->
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="d-flex align-items-center gap-3">
              <label><strong>Rango de fecha y hora:</strong></label>
              <input type="datetime-local" id="fechaInicio" class="form-control" style="width: 200px;">
              <span>→</span>
              <input type="datetime-local" id="fechaFin" class="form-control" style="width: 200px;">
              <button id="buscarHistoricoFlujo" class="btn btn-outline-success">
                <i class="bi bi-search"></i> Buscar
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button id="volverTiempoReal" type="button" class="btn btn-outline-warning btn-sm me-2" onclick="resetearAModoTiempoReal()">
              <i class="bi bi-arrow-clockwise"></i> Volver a Tiempo Real
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" onclick="exportarDatos()">
              <i class="bi bi-download"></i> Exportar Datos
            </button>
          </div>
        </div>
        
        <!-- Indicador de modo dinámico -->
        <div class="alert alert-info mb-3 d-flex align-items-center">
          <i class="bi bi-info-circle me-2"></i>
          <span id="modo-indicador">
            <strong>Modo Tiempo Real:</strong> 
            <span class="badge bg-success me-2">●</span>
            Los gráficos se actualizan automáticamente cada 10 segundos mostrando los últimos 3 días.
          </span>
        </div>
        
        <!-- Instrucciones de uso -->
        <div class="alert alert-secondary">
          <i class="bi bi-clock-history"></i>
          <strong>Información:</strong> 
          Los gráficos muestran los datos de flujo volumétrico (m³/h) y másico (kg/h) para el período seleccionado.
          <strong>Hover</strong> sobre los puntos para ver detalles. <span id="info-periodo">Últimos 3 días - Se actualiza automáticamente</span>
        </div>
        
        <!-- Dos gráficos lado a lado -->
        <div class="row">
          <!-- Flujo Volumétrico -->
          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Flujo Volumétrico</h6>
                <span id="contador-volumetrico" class="badge bg-light text-primary">0 registros</span>
              </div>
              <div class="card-body">
                <div style="height: 350px; position: relative;">
                  <canvas id="graficaFlujoVolumetrico"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Flujo Másico -->
          <div class="col-lg-6">
            <div class="card mb-3">
              <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Flujo Másico</h6>
                <span id="contador-masico" class="badge bg-light text-success">0 registros</span>
              </div>
              <div class="card-body">
                <div style="height: 350px; position: relative;">
                  <canvas id="graficaFlujoMasico"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Información adicional -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="alert alert-secondary">
              <i class="bi bi-clock-history"></i>
              <strong>Información:</strong> Los gráficos muestran los datos de flujo volumétrico (m³/h) y flujo másico (kg/h) para el período seleccionado.
              <span id="info-periodo"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- jsPDF y html2canvas para exportar a PDF -->
<!-- PDF Generator Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Scripts locales de Coriolis existentes -->
<script src="{% static 'js/coriolis-common.js' %}"></script>
<script src="{% static 'js/coriolis-map.js' %}"></script>
<script src="{% static 'js/coriolis-spa.js' %}"></script>

<!-- Scripts modulares extraídos -->
<script src="{% static '_AppMonitoreoCoriolis/js/config.js' %}?v=2.0"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/utils.js' %}?v=2.0"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/data-loader.js' %}?v=2.0"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/charts.js' %}?v=2.0"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/time-control.js' %}?v=2.0"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/pdf-generator.js' %}?v=2.0"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/main.js' %}?v=2.0"></script>
{% endblock %}
