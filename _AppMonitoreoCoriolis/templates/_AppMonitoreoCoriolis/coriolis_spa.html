{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoreo Coriolis - GISME{% endblock %}

{% block extra_css %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/monitoreo.css' %}">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .custom-marker {
        background: transparent;
        border: none;
    }
    
    .leaflet-popup-content {
        margin: 8px 12px;
        font-size: 14px;
    }
    
    .leaflet-popup-content h6 {
        color: #0d6efd;
        margin-bottom: 8px;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    
    .metrics-container {
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .metric-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    .metric-item:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        font-weight: 600;
        color: #495057;
    }
    
    .metric-value {
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3">
                <h5>Cargando Monitoreo Coriolis...</h5>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE SELECCIÓN DE SISTEMAS ============ -->
    <div id="sistema-selector-view" class="hidden">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Monitoreo Coriolis
                        </h4>
                        <p class="mb-0 mt-2">Seleccione el sistema que desea monitorear</p>
                    </div>
                    <div class="card-body">
                        <!-- Barra de búsqueda -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar sistemas...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary" id="clearSearch">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de sistemas -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('tag')">
                                                Tag <i class="bi bi-arrow-up-down ms-1" id="tag-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('sistema_id')">
                                                ID Sistema <i class="bi bi-arrow-up-down ms-1" id="sistema_id-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('ubicacion_nombre')">
                                                Ubicación <i class="bi bi-arrow-up-down ms-1" id="ubicacion_nombre-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">Coordenadas</th>
                                        <th scope="col">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="sistemasTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            Cargando sistemas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        <div id="pagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE MONITOREO DE SISTEMA ESPECÍFICO ============ -->
    <div id="sistema-monitoring-view" class="hidden">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0)" onclick="showSelectorView()">Monitoreo Coriolis</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbSistema">
                            Sistema
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0" id="sistemaTitle">
                            <i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis
                        </h4>
                        <button class="btn btn-light btn-sm" onclick="showSelectorView()">
                            <i class="bi bi-arrow-left"></i> Cambiar Sistema
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Panel de Estado -->
                            <div class="col-lg-8 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-activity"></i> Estado del Sistema</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaInfo" class="metrics-container">
                                            <div class="text-center">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2">Cargando información del sistema...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de Ubicación -->
                            <div class="col-lg-4 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-geo-alt"></i> Ubicación</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="sistemaMap" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráficos de Tendencias -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-graph-up"></i> Tendencias de Medición</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
    // SPA para Monitoreo Coriolis
    let sistemasData = [];
    let filteredSistemas = [];
    let currentSortField = '';
    let currentSortDirection = 'asc';
    let currentSistema = null;
    let map = null;
    let trendChart = null;

    // Función para obtener CSRF token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Router básico para SPA
    function initRouter() {
        const path = window.location.pathname;
        const sistemaIdMatch = path.match(/\/monitoreo\/([a-f0-9-]+)\//);
        
        if (sistemaIdMatch) {
            const sistemaId = sistemaIdMatch[1];
            loadSistemaDetail(sistemaId);
        } else {
            showSelectorView();
        }
    }

    // Mostrar vista de selección
    function showSelectorView() {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('sistema-selector-view').classList.remove('hidden');
        document.getElementById('sistema-monitoring-view').classList.add('hidden');
        
        // Actualizar URL sin recargar
        history.pushState({view: 'selector'}, '', '/monitoreo/');
        
        // Cargar sistemas si no están cargados
        if (sistemasData.length === 0) {
            loadSistemas();
        }
    }

    // Mostrar vista de monitoreo
    function showMonitoringView(sistemaId) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('sistema-selector-view').classList.add('hidden');
        document.getElementById('sistema-monitoring-view').classList.remove('hidden');
        
        // Actualizar URL sin recargar
        history.pushState({view: 'monitoring', sistemaId: sistemaId}, '', `/monitoreo/${sistemaId}/`);
        
        loadSistemaDetail(sistemaId);
    }

    // Cargar sistemas desde la API de Complementos
    async function loadSistemas() {
        try {
            const response = await fetch('/complementos/listar-todo-sistemas/', {
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Verificar estructura de respuesta
            if (data.success && data.data) {
                sistemasData = data.data; // La respuesta tiene formato {success: true, data: [...]}
                filteredSistemas = [...sistemasData];
                renderSistemasTable();
            } else {
                throw new Error('Estructura de respuesta inválida');
            }
        } catch (error) {
            console.error('Error cargando sistemas:', error);
            document.getElementById('sistemasTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        <i class="bi bi-exclamation-circle"></i> Error cargando sistemas
                    </td>
                </tr>
            `;
        }
    }

    // Cargar detalle de sistema desde la API de Complementos
    async function loadSistemaDetail(sistemaId) {
        try {
            const response = await fetch(`/complementos/sistema/${sistemaId}/`, {
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Verificar estructura de respuesta
            if (data.success && data.data) {
                currentSistema = data.data; // La respuesta tiene formato {success: true, data: {...}}
                renderSistemaDetail();
            } else {
                throw new Error('Estructura de respuesta inválida');
            }
        } catch (error) {
            console.error('Error cargando sistema:', error);
            alert('Error cargando el sistema. Volviendo a la lista...');
            showSelectorView();
        }
    }

    // Renderizar tabla de sistemas
    function renderSistemasTable() {
        const tbody = document.getElementById('sistemasTableBody');
        
        if (filteredSistemas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <i class="bi bi-info-circle"></i> No se encontraron sistemas
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = filteredSistemas.map(sistema => `
            <tr>
                <td>
                    <strong class="text-primary">${sistema.tag}</strong>
                </td>
                <td>
                    <span class="badge bg-secondary">${sistema.sistema_id}</span>
                </td>
                <td>
                    <i class="bi bi-geo-alt text-success"></i> ${sistema.ubicacion_nombre}
                </td>
                <td>
                    <small class="text-muted">${sistema.ubicacion_coordenadas}</small>
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="showMonitoringView('${sistema.id}')">
                        <i class="bi bi-activity"></i> Monitorear
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Renderizar detalle del sistema
    function renderSistemaDetail() {
        if (!currentSistema) return;

        // Actualizar título y breadcrumb
        document.getElementById('sistemaTitle').innerHTML = 
            `<i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis "${currentSistema.tag} ${currentSistema.sistema_id}"`;
        document.getElementById('breadcrumbSistema').textContent = 
            `${currentSistema.tag} ${currentSistema.sistema_id}`;

        // Renderizar información del sistema
        document.getElementById('sistemaInfo').innerHTML = `
            <div class="metric-item">
                <span class="metric-label">Tag:</span>
                <span class="metric-value text-primary">${currentSistema.tag}</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">ID Sistema:</span>
                <span class="metric-value">${currentSistema.sistema_id}</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Ubicación:</span>
                <span class="metric-value">${currentSistema.ubicacion_nombre}</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Coordenadas:</span>
                <span class="metric-value">${currentSistema.ubicacion_coordenadas}</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Estado:</span>
                <span class="metric-value text-success">
                    <i class="bi bi-check-circle"></i> Activo
                </span>
            </div>
        `;

        // Inicializar mapa
        initMap();
        
        // Inicializar gráfico
        initChart();
    }

    // Función de búsqueda
    function filterSistemas() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        filteredSistemas = sistemasData.filter(sistema => 
            sistema.tag.toLowerCase().includes(searchTerm) ||
            sistema.sistema_id.toLowerCase().includes(searchTerm) ||
            sistema.ubicacion_nombre.toLowerCase().includes(searchTerm)
        );
        renderSistemasTable();
    }

    // Función de ordenamiento
    function sortTable(field) {
        if (currentSortField === field) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortField = field;
            currentSortDirection = 'asc';
        }

        filteredSistemas.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];
            
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            if (currentSortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        renderSistemasTable();
        updateSortIcons(field);
    }

    // Función para actualizar íconos de ordenamiento
    function updateSortIcons(field) {
        document.querySelectorAll('[id$="-sort-icon"]').forEach(icon => {
            icon.className = 'bi bi-arrow-up-down ms-1';
        });
        
        const icon = document.getElementById(`${field}-sort-icon`);
        if (icon) {
            icon.className = currentSortDirection === 'asc' ? 
                'bi bi-arrow-up ms-1' : 'bi bi-arrow-down ms-1';
        }
    }

    // Inicializar mapa
    function initMap() {
        if (!currentSistema) return;

        // Destruir mapa anterior si existe
        if (map) {
            map.remove();
        }

        // Coordenadas por defecto (Centro de Colombia)
        let lat = 4.6097;
        let lng = -74.0817;

        // Crear mapa
        map = L.map('sistemaMap').setView([lat, lng], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Agregar marcador
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`
            <div>
                <h6>${currentSistema.tag} ${currentSistema.sistema_id}</h6>
                <p><strong>Ubicación:</strong> ${currentSistema.ubicacion_nombre}</p>
                <p><strong>Coordenadas:</strong> ${currentSistema.ubicacion_coordenadas}</p>
            </div>
        `).openPopup();
    }

    // Inicializar gráfico
    function initChart() {
        if (trendChart) {
            trendChart.destroy();
        }

        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // Datos simulados para demo
        const labels = [];
        const presionData = [];
        const flujoData = [];
        const tempData = [];
        
        for (let i = 0; i < 24; i++) {
            labels.push(`${i}:00`);
            presionData.push(Math.random() * 50 + 100);
            flujoData.push(Math.random() * 20 + 30);
            tempData.push(Math.random() * 10 + 20);
        }

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Presión (PSI)',
                        data: presionData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Flujo (m³/h)',
                        data: flujoData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Temperatura (°C)',
                        data: tempData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Tendencias de las últimas 24 horas'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar router
        initRouter();
        
        // Búsqueda en tiempo real
        document.getElementById('searchInput').addEventListener('input', filterSistemas);
        
        // Limpiar búsqueda
        document.getElementById('clearSearch').addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            filterSistemas();
        });

        // Manejar navegación del navegador
        window.addEventListener('popstate', function(event) {
            if (event.state) {
                if (event.state.view === 'selector') {
                    showSelectorView();
                } else if (event.state.view === 'monitoring') {
                    showMonitoringView(event.state.sistemaId);
                }
            } else {
                showSelectorView();
            }
        });
    });
</script>
{% endblock %}
