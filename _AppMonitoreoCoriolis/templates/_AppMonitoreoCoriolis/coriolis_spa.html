{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoreo Coriolis - GISME{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monitoreo.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-common.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-spa.css' %}">
<link rel="stylesheet" href="{% static 'css/soft-colors.css' %}">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js Annotation Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
{% endblock %}

{% block content %}
<style>
.hidden {
    display: none !important;
}

/* Estilos para imagen fija del sistema Coriolis */
.img-container {
    overflow-x: auto !important;
    overflow-y: hidden !important;
    white-space: nowrap !important;
    padding-bottom: 15px !important; /* Espacio para la barra de scroll horizontal */
}

.img-fixed {
    width: 1050px !important;
    height: auto !important;
    min-width: 1050px !important;
    max-width: none !important;
    display: block !important;
}

/* Elementos de UI fijos que no se mueven con el scroll */
.sistema-ui-overlay {
    position: relative !important;
    pointer-events: none !important; /* Permitir clics a través del overlay */
    z-index: 10 !important;
}

.sistema-ui-element {
    position: absolute !important;
    pointer-events: auto !important; /* Restaurar clics en los elementos específicos */
    z-index: 21 !important;
}

/* Mejorar las barras de scroll */
.img-container::-webkit-scrollbar {
    height: 12px;
}

.img-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 6px;
}

.img-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 6px;
}

.img-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Asegurar que el contenedor del card también tenga scroll horizontal si es necesario */
.coriolis-card-body {
    overflow-x: auto !important;
}

/* Media query personalizada para breakpoint a 1533px */
@media (max-width: 1533px) {
    .coriolis-responsive-layout .col-xl-9,
    .coriolis-responsive-layout .col-xl-3 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
    }
}

/* Estilos para botones responsivos del header */
@media (max-width: 768px) {
    .coriolis-header-buttons {
        flex-direction: column !important;
        gap: 0.75rem !important;
        align-items: stretch !important;
    }
    
    .coriolis-header-buttons .btn {
        width: 100% !important;
        margin: 0 !important;
    }
}
</style>

<script>
// Variables globales del sistema desde Django
let SISTEMA_ACTUAL;

// Configuración del sistema desde Django template
/*{% if sistema %}*/
    SISTEMA_ACTUAL = {
        id: '{{ sistema.id|default:"" }}',
        tag: '{{ sistema.tag|default:"" }}',
        sistema_id: '{{ sistema.sistema_id|default:"" }}',
        nombre: '{{ sistema.nombre|default:"" }}'
    };
/*{% else %}*/
    SISTEMA_ACTUAL = null;
/*{% endif %}*/
</script>

<!-- Variables globales se mantienen aquí para Django template -->

<div class="container-fluid mt-4">
    <!-- Token CSRF para peticiones AJAX -->
    {% csrf_token %}
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3">
                <h5>Cargando Monitoreo Coriolis...</h5>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE SELECCIÓN DE SISTEMAS ============ -->
    <div id="sistema-selector-view">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Monitoreo Coriolis
                        </h4>
                        <p class="mb-0 mt-2">Seleccione el sistema que desea monitorear</p>
                    </div>
                    <div class="card-body">
                        <!-- Barra de búsqueda -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar sistemas...">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary" id="clearSearch">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de sistemas -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('tag')">
                                                Nombre <i class="bi bi-arrow-up-down ms-1" id="tag-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('sistema_id')">
                                                MAC Gateway <i class="bi bi-arrow-up-down ms-1" id="sistema_id-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">
                                            <span style="cursor: pointer;" onclick="sortTable('ubicacion_nombre')">
                                                Ubicación <i class="bi bi-arrow-up-down ms-1" id="ubicacion_nombre-sort-icon"></i>
                                            </span>
                                        </th>
                                        <th scope="col">Coordenadas</th>
                                        <th scope="col">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="sistemasTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            Cargando sistemas...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        <div id="pagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ VISTA DE MONITOREO DE SISTEMA ESPECÍFICO ============ -->
    <div id="sistema-monitoring-view" class="hidden">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0)" onclick="showSelectorView()">Monitoreo Coriolis</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page" id="breadcrumbSistema">
                            Sistema
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header coriolis-header-system text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="sistemaTitle">
                                <i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis
                            </h4>
                            <small class="text-light opacity-75">
                                <i class="bi bi-clock"></i> Última actualización: 
                                <span id="ultima-actualizacion">---</span> (Hora Colombia)
                            </small>
                        </div>
                        <div class="coriolis-header-buttons d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="abrirModalBatches()">
                                <i class="bi bi-search"></i> Buscar Batches
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="descargarReportePDF()">
                                <i class="bi bi-file-earmark-pdf"></i> Descargar Reporte PDF
                            </button>
                            <button class="btn btn-light btn-sm" onclick="showSelectorView()">
                                <i class="bi bi-arrow-left"></i> Cambiar Sistema
                            </button>
                        </div>
                        <!-- Contenedor oculto para el reporte PDF -->
                        <div id="reportePDF" style="display:none; max-width:600px;">
                            <h3>Reporte del Sistema Coriolis</h3>
                            <p><strong>Sistema:</strong> <span id="pdf-sistema-nombre"></span></p>
                            <p><strong>Estado:</strong> <span id="pdf-sistema-estado"></span></p>
                            <p><strong>Temperatura actual:</strong> <span id="pdf-temperatura"></span></p>
                            <div>
                                <canvas id="pdf-grafica-temperatura" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">

                        <div class="row coriolis-responsive-layout">
                            <!-- Imagen descriptiva del sistema con marcadores interactivos -->
                            <div class="col-xl-9 col-12 mb-4">
                                <div class="card h-100">
                                    <div class="card-header" style="position: relative;">
                                        <h5><i class="bi bi-activity"></i> Esquema del Sistema Coriolis</h5>
                                        <!-- Botón de configuración -->
                                        <button type="button" class="btn btn-outline-dark btn-sm" style="position: absolute; top: 10px; right: 15px; z-index: 100;" data-bs-toggle="modal" data-bs-target="#modalConfiguracionSistema" title="Configurar Coeficientes">
                                            <i class="bi bi-gear-fill" style="font-size: 1rem;"></i>
                                        </button>
                                    </div>
                                    <div class="card-body coriolis-card-body text-center" style="overflow: visible; max-height: 700px; position: relative;">
                                        <div style="position: relative; width: 100%; display: flex; justify-content: center;">
                                            <div class="img-container" style="position: relative; overflow-x: auto; height: 500px; width: 100%;">
                                                <div style="position: relative; width: 1050px; min-width: 1050px;">
                                                    <img src="{% static 'img/coriolis_render2.png' %}" class="img-fixed" id="sistema-img" style="width: 1050px; height: auto; display: block;">
                                                    <!-- Displays de sensores -->
                                                    <div style="position: absolute; top: 25%; left: 28%; min-width: 180px; z-index: 50;">
                                                    <div class="shadow-sm" style="background:rgba(255,255,255,0.9); border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                                        <div style="font-weight:600; color:#888;">Flujo Volumétrico <sub>@ flujo</sub></div>
                                                        <div id="display-sensor1" style="font-size:15px; color:#007bff; font-weight:700;">---</div>
                                                    </div>
                                                </div>
                                                <div style="position: absolute; top: 35%; left: 28%; min-width: 180px; z-index: 50;">
                                                    <div class="shadow-sm" style="background:rgba(255,255,255,0.9); border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                                        <div style="font-weight:600; color:#888;">Flujo Másico</div>
                                                        <div id="display-sensor4" style="font-size:15px; color:#418b2a; font-weight:700;">---</div>
                                                    </div>
                                                </div>
                                                <div style="position: absolute; top: 63%; left: 28%; min-width: 180px; z-index: 50;">
                                                    <div class="shadow-sm" style="background:rgba(255,255,255,0.9); border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                                        <div style="font-weight:600; color:#888;">Temperatura Coriolis</div>
                                                        <div id="display-sensor2" style="font-size:15px; color:#f59416; font-weight:700;">---</div>
                                                    </div>
                                                </div>
                                                <div style="position: absolute; top: 73%; left: 28%; min-width: 180px; z-index: 50;">
                                                    <div class="shadow-sm" style="background:rgba(255,255,255,0.9); border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                                        <div style="font-weight:600; color:#888;">Temperatura Diagnóstico</div>
                                                        <div id="display-sensor6" style="font-size:15px; color:#a328c2; font-weight:700;">---</div>
                                                    </div>
                                                </div>
                                                <div style="position: absolute; top: 70%; left: 54%; min-width: 90px; z-index: 50;">
                                                    <div class="shadow-sm" style="background:rgba(255,255,255,0.9); border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                                        <div style="font-weight:600; color:#888;">Temperatura de Sálida</div>
                                                        <div id="display-sensor5" style="font-size:15px; color:#28a745; font-weight:700;">---</div>
                                                    </div>
                                                </div>
                                                <div style="position: absolute; top: 10%; left: 56%; min-width: 90px; z-index: 50;">
                                                    <div class="shadow-sm" style="background:rgba(255,255,255,0.9); border-radius:10px; padding:6px 12px; text-align:center; font-size:13px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                                                        <div style="font-weight:600; color:#888;">Presión</div>
                                                        <div id="display-sensor3" style="font-size:15px; color:#dc3545; font-weight:700;">---</div>
                                                    </div>
                                                </div>
                                                    <!-- Marcadores transparentes clickeables -->
                                                    <button class="marker" style="position:absolute; top:47%; left:34%; width:32px; height:32px; border-radius:50%; background:rgba(0,123,255,0); border:none; cursor:pointer; z-index:60;" onclick="abrirModal('sensor1')" title="Ver histórico Sensor 1"></button>
                                                    <button class="marker" style="position:absolute; top:60%; left:61.5%; width:32px; height:32px; border-radius:50%; background:rgba(40,167,69,0); border:none; cursor:pointer; z-index:60;" onclick="abrirModal('sensor2')" title="Ver histórico Sensor 2"></button>
                                                    <button class="marker" style="position:absolute; top:23%; left:58%; width:32px; height:32px; border-radius:50%; background:rgba(220,53,69,0); border:none; cursor:pointer; z-index:60;" onclick="abrirModal('sensor3')" title="Ver histórico Sensor 3"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Card de la tabla de variables -->
                            <div class="col-xl-3 col-12 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5><i class="bi bi-clipboard-data"></i> Otras variables del Sistema</h5>
                                    </div>
                                    <div class="card-body p-3">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead>
                                                <tr style="border-bottom: 2px solid #e3f0ff;">
                                                    <th style="color: #222; font-weight: 700; background: transparent;">Variable</th>
                                                    <th class="text-center" style="color: #222; font-weight: 700; background: transparent;">Valor</th>
                                                    <th class="text-center" style="color: #222; font-weight: 700; background: transparent;">Unidad</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-variables-sistema">
                                                <tr>
                                                    <td>Volumen Total</td>
                                                    <td id="tabla-volTotal" class="text-center">---</td>
                                                    <td class="text-center">gal</td>
                                                </tr>
                                                <tr>
                                                    <td>Masa Total</td>
                                                    <td id="tabla-masTotal" class="text-center">---</td>
                                                    <td class="text-center">kg</td>
                                                </tr>
                                                <tr>
                                                    <td>Densidad</td>
                                                    <td id="tabla-densidad" class="text-center">---</td>
                                                    <td class="text-center">g/cc</td>
                                                </tr>
                                                <tr>
                                                    <td>Frecuencia</td>
                                                    <td id="tabla-frecuencia" class="text-center">---</td>
                                                    <td class="text-center">Hz</td>
                                                </tr>
                                                <tr>
                                                    <td>% Concentración Sólidos</td>
                                                    <td id="tabla-concSolido" class="text-center">---</td>
                                                    <td class="text-center">%</td>
                                                </tr>
                                                <tr>
                                                    <td>% Corte Agua</td>
                                                    <td id="tabla-corteAgua" class="text-center">---</td>
                                                    <td class="text-center">%</td>
                                                </tr>
                                                <tr>
                                                    <td>Intensidad Señal Gateway</td>
                                                    <td id="tabla-signalGateway" class="text-center">---</td>
                                                    <td class="text-center">dB</td>
                                                </tr>
                                                <tr>
                                                    <td>Temperatura Gateway</td>
                                                    <td id="tabla-tempGateway" class="text-center">---</td>
                                                    <td class="text-center">°C</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráficos de Tendencias -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="bi bi-graph-up"></i> Tendencias de Medición</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="trendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal del Mapa -->
{% include '_AppMonitoreoCoriolis/componentes/modal_mapa.html' %}

<!-- Modal Histórico de Flujo -->
{% include '_AppMonitoreoCoriolis/componentes/modal_flujo.html' %}

<!-- Modal de Presión -->
{% include '_AppMonitoreoCoriolis/componentes/modal_presion.html' %}

<!-- Modal de Temperatura -->
{% include '_AppMonitoreoCoriolis/componentes/modal_temperatura.html' %}

<!-- Modal de Configuración -->
{% include '_AppMonitoreoCoriolis/componentes/modal_configuracion.html' %}

<!-- Modal de Búsqueda de Batches -->
{% include '_AppMonitoreoCoriolis/componentes/modal_batches.html' %}

{% endblock %}

{% block extra_js %}
<!-- jsPDF y html2canvas para exportar a PDF -->
<!-- PDF Generator Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Scripts locales de Coriolis existentes -->
<script src="{% static 'js/coriolis-common.js' %}"></script>
<script src="{% static 'js/coriolis-map.js' %}"></script>
<script src="{% static 'js/coriolis-spa.js' %}"></script>

<!-- Scripts modulares extraídos -->
<script src="{% static '_AppMonitoreoCoriolis/js/config.js' %}?v=2.4"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/utils.js' %}?v=2.2"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/data-loader.js' %}?v=2.5"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/charts.js' %}?v=2.4"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/time-control.js' %}?v=2.4"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/pdf-generator.js' %}?v=2.2"></script>
<script src="{% static '_AppMonitoreoCoriolis/js/main.js' %}?v=2.5"></script>
{% endblock %}
