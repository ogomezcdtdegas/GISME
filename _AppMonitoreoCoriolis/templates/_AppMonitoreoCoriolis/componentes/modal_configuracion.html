<!-- ====================================================================
     COMPONENTE: Modal de Configuraci√≥n de Coeficientes
     Descripci√≥n: Modal para configurar coeficientes de correcci√≥n y variables del sistema
     Uso: Se incluye en el template principal coriolis_spa.html
====================================================================== -->

<div class="modal fade" id="modalConfiguracionSistema" tabindex="-1" aria-labelledby="modalConfiguracionSistemaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfiguracionSistemaLabel">
          <i class="bi bi-gear-fill"></i> COEFICIENTES DE CORRECCI√ìN Y VARIABLES DE CONFIGURACI√ìN
          {% if readonly_config_view %}
          <span class="badge bg-warning ms-2">Solo Lectura</span>
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formConfiguracionSistema">
          <!-- Temperatura de Salida -->
          <div class="col-12">
            <h6 class="fw-bold mb-3">Coeficientes de correcci√≥n:</h6>
          </div>
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="mb-3">Temperatura de Salida:</h6>
            </div>
            <div class="col-md-6">
              <label for="tempSalidaM" class="form-label">M:</label>
              <input type="number" class="form-control" id="tempSalidaM" name="tempSalidaM" step="any" placeholder="Ingrese valor M">
            </div>
            <div class="col-md-6">
              <label for="tempSalidaB" class="form-label">B:</label>
              <input type="number" class="form-control" id="tempSalidaB" name="tempSalidaB" step="any" placeholder="Ingrese valor B">
            </div>
          </div>

          <!-- Presi√≥n de Salida -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="mb-3">Presi√≥n de Salida:</h6>
            </div>
            <div class="col-md-3">
              <label for="presionSalidaM" class="form-label">M:</label>
              <input type="number" class="form-control" id="presionSalidaM" name="presionSalidaM" step="any" placeholder="Ingrese valor M">
            </div>
            <div class="col-md-3">
              <label for="presionSalidaB" class="form-label">B:</label>
              <input type="number" class="form-control" id="presionSalidaB" name="presionSalidaB" step="any" placeholder="Ingrese valor B">
            </div>
            <div class="col-md-3">
              <label for="zeroPresion" class="form-label">Zero:</label>
              <input type="number" class="form-control" id="zeroPresion" name="zeroPresion" step="any" placeholder="0.0">
            </div>
            <div class="col-md-3">
              <label for="spanPresion" class="form-label">Span:</label>
              <input type="number" class="form-control" id="spanPresion" name="spanPresion" step="any" placeholder="1.0">
            </div>
          </div>

          <!-- Informaci√≥n adicional -->
          <div class="alert alert-info d-flex align-items-center mt-3">
            <i class="bi bi-info-circle me-2"></i>
            <small>
              <strong>Informaci√≥n:</strong> Los coeficientes M y B se utilizan para la correcci√≥n lineal de las variables del sistema.
              F√≥rmula: <code>Valor_Corregido = M √ó Valor_Original + B</code>
            </small>
          </div>
          <!-- Configuraci√≥n de Batch -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="fw-bold mb-3">Configuraci√≥n detecci√≥n de Batch:</h6>
            </div>
            <div class="col-md-4">
              <label for="limInfCaudalMasico" class="form-label">L√≠m Inf Caudal M√°sico:</label>
              <input type="number" class="form-control" id="limInfCaudalMasico" name="limInfCaudalMasico" step="any" placeholder="0.0" min="0">
              <small class="form-text text-muted">kg/min</small>
            </div>
            <div class="col-md-4">
              <label for="limSupCaudalMasico" class="form-label">L√≠m Sup Caudal M√°sico:</label>
              <input type="number" class="form-control" id="limSupCaudalMasico" name="limSupCaudalMasico" step="any" placeholder="1000000.0" min="0">
              <small class="form-text text-muted">kg/min</small>
            </div>
            <div class="col-md-4">
              <label for="volMasicoIniBatch" class="form-label">Vol detector de bath:</label>
              <input type="number" class="form-control" id="volMasicoIniBatch" name="volMasicoIniBatch" step="any" placeholder="0.0" min="0">
              <small class="form-text text-muted">kg</small>
            </div>
            <div class="col-md-4">
              <label for="timeFinishedBatch" class="form-label">Tiempo para cierre de batch:</label>
              <input type="number" class="form-control" id="timeFinishedBatch" name="timeFinishedBatch" step="0.1" placeholder="2.0" min="0.1">
              <small class="form-text text-muted">minutos</small>
            </div>
          </div>
          <!-- Configuraci√≥n de Batch -->
          <div class="row mb-4">
            <div class="col-12">
              <h6 class="fw-bold mb-3">Configuraci√≥n Ticket:</h6>
            </div>
            <div class="col-md-4">
              <label for="numberTicket" class="form-label"># Ticket:</label>
              <input type="number" class="form-control" id="numberTicket" name="numberTicket" step="any" placeholder="0" min="0">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
        {% if can_configure_constants %}
        <button type="button" class="btn btn-primary" id="btnActualizarCoeficientes">
          <i class="bi bi-check-circle"></i> Actualizar
        </button>
        {% elif readonly_config_view %}
        <button type="button" class="btn btn-outline-secondary" disabled title="Solo los Administradores pueden modificar coeficientes">
          <i class="bi bi-lock"></i> Solo Lectura (Supervisor)
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// Script para manejar la funcionalidad del modal de configuraci√≥n
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modalConfiguracionSistema');
    const btnActualizar = document.getElementById('btnActualizarCoeficientes');
    const form = document.getElementById('formConfiguracionSistema');

    // Cargar valores actuales al abrir el modal
    modal.addEventListener('show.bs.modal', function () {
        cargarCoeficientesActuales();
    });

    // Manejar click del bot√≥n Actualizar
    btnActualizar.addEventListener('click', function() {
        actualizarCoeficientes();
    });

    function cargarCoeficientesActuales() {
        //console.log('Cargando coeficientes actuales...');
        
        // Obtener el ID del sistema desde la URL
        const sistemaId = obtenerSistemaIdDesdeURL();
        
        if (!sistemaId) {
            //console.warn('No se encontr√≥ ID del sistema actual. Usando valores por defecto.');
            cargarValoresPorDefecto();
            return;
        }

        // Guardar el ID del sistema para uso posterior
        window.SISTEMA_ACTUAL = { id: sistemaId };

        // Cargar coeficientes desde el backend
        fetch(`/complementos/api/coeficientes/${sistemaId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                document.getElementById('tempSalidaM').value = data.data.mt || '1.0';
                document.getElementById('tempSalidaB').value = data.data.bt || '0.0';
                document.getElementById('presionSalidaM').value = data.data.mp || '1.0';
                document.getElementById('presionSalidaB').value = data.data.bp || '0.0';
                document.getElementById('zeroPresion').value = data.data.zero_presion || '0.0';
                document.getElementById('spanPresion').value = data.data.span_presion || '1.0';
                
                // Nuevos campos de configuraci√≥n de batch
                document.getElementById('limInfCaudalMasico').value = data.data.lim_inf_caudal_masico || '0.0';
                document.getElementById('limSupCaudalMasico').value = data.data.lim_sup_caudal_masico || '1000000.0';
                document.getElementById('volMasicoIniBatch').value = data.data.vol_masico_ini_batch || '0.0';
                document.getElementById('numberTicket').value = data.data.num_ticket || '1';
                document.getElementById('timeFinishedBatch').value = data.data.time_finished_batch || '2.0';
                
                if (!data.exists) {
                    //console.info('Coeficientes no configurados. Mostrando valores por defecto.');
                }
            } else {
                //console.warn('Error al cargar coeficientes:', data.error);
                cargarValoresPorDefecto();
            }
        })
        .catch(error => {
            //console.error('Error de conexi√≥n al cargar coeficientes:', error);
            cargarValoresPorDefecto();
        });
    }

    function obtenerSistemaIdDesdeURL() {
        // Obtener el ID del sistema desde la URL actual
        // Patr√≥n: /monitoreo/sistema/ID_DEL_SISTEMA/
        const urlPath = window.location.pathname;
        const sistemaMatch = urlPath.match(/\/sistema\/([a-f0-9-]{36})\//);
        
        if (sistemaMatch && sistemaMatch[1]) {
            //console.log('ID del sistema obtenido desde URL:', sistemaMatch[1]);
            return sistemaMatch[1];
        }
        
        //console.warn('No se pudo extraer el ID del sistema desde la URL:', urlPath);
        return null;
    }

    function cargarValoresPorDefecto() {
        document.getElementById('tempSalidaM').value = '1.0';
        document.getElementById('tempSalidaB').value = '0.0';
        document.getElementById('presionSalidaM').value = '1.0';
        document.getElementById('presionSalidaB').value = '0.0';
        document.getElementById('zeroPresion').value = '0.0';
        document.getElementById('spanPresion').value = '1.0';
        
        // Valores por defecto para configuraci√≥n de batch
        document.getElementById('limInfCaudalMasico').value = '0.0';
        document.getElementById('limSupCaudalMasico').value = '1000000.0';
        document.getElementById('volMasicoIniBatch').value = '0.0';
        document.getElementById('numberTicket').value = '1';
        document.getElementById('timeFinishedBatch').value = '2.0';
    }

    function actualizarCoeficientes() {
        // Obtener el ID del sistema actual
        const sistemaId = window.SISTEMA_ACTUAL ? window.SISTEMA_ACTUAL.id : null;
        
        if (!sistemaId) {
            alert('Error: No se encontr√≥ el ID del sistema actual');
            return;
        }

        // Obtener valores del formulario
        const mt = parseFloat(document.getElementById('tempSalidaM').value);
        const bt = parseFloat(document.getElementById('tempSalidaB').value);
        const mp = parseFloat(document.getElementById('presionSalidaM').value);
        const bp = parseFloat(document.getElementById('presionSalidaB').value);
        const zeroPresion = parseFloat(document.getElementById('zeroPresion').value);
        const spanPresion = parseFloat(document.getElementById('spanPresion').value);
        
        // Obtener valores de configuraci√≥n de batch
        const limInfCaudalMasico = parseFloat(document.getElementById('limInfCaudalMasico').value);
        const limSupCaudalMasico = parseFloat(document.getElementById('limSupCaudalMasico').value);
        const volMasicoIniBatch = parseFloat(document.getElementById('volMasicoIniBatch').value);
        const numTicket = parseInt(document.getElementById('numberTicket').value);
        const timeFinishedBatch = parseFloat(document.getElementById('timeFinishedBatch').value);

        // Validar que todos los valores son n√∫meros v√°lidos
        if (isNaN(mt) || isNaN(bt) || isNaN(mp) || isNaN(bp) || isNaN(zeroPresion) || isNaN(spanPresion) ||
            isNaN(limInfCaudalMasico) || isNaN(limSupCaudalMasico) || isNaN(volMasicoIniBatch) || isNaN(numTicket) || isNaN(timeFinishedBatch)) {
            alert('Error: Todos los valores deben ser n√∫meros v√°lidos');
            return;
        }
        
        // Validaciones adicionales
        if (limInfCaudalMasico < 0 || limSupCaudalMasico < 0 || volMasicoIniBatch < 0 || numTicket < 1 || timeFinishedBatch < 0.1) {
            alert('Error: Los valores de configuraci√≥n no pueden ser negativos, el n√∫mero de ticket debe ser mayor a 0 y el tiempo de cierre debe ser mayor a 0.1 minutos');
            return;
        }
        
        if (limInfCaudalMasico >= limSupCaudalMasico) {
            alert('Error: El l√≠mite inferior debe ser menor que el l√≠mite superior');
            return;
        }

        const coeficientes = {
            systemId: sistemaId,
            mt: mt,
            bt: bt,
            mp: mp,
            bp: bp,
            zero_presion: zeroPresion,
            span_presion: spanPresion,
            lim_inf_caudal_masico: limInfCaudalMasico,
            lim_sup_caudal_masico: limSupCaudalMasico,
            vol_masico_ini_batch: volMasicoIniBatch,
            num_ticket: numTicket,
            time_finished_batch: timeFinishedBatch
        };

        //console.log('Actualizando coeficientes:', coeficientes);

        // Mostrar indicador de carga
        btnActualizar.disabled = true;
        btnActualizar.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';

        // Llamada al backend para guardar los coeficientes
        fetch('/complementos/api/coeficientes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(coeficientes)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de √©xito
                alert(data.message || 'Coeficientes actualizados correctamente');
                // Cerrar modal
                bootstrap.Modal.getInstance(modal).hide();
            } else {
                alert('Error al actualizar coeficientes: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            //console.error('Error:', error);
            alert('Error de conexi√≥n al actualizar coeficientes');
        })
        .finally(() => {
            // Restaurar bot√≥n
            btnActualizar.disabled = false;
            btnActualizar.innerHTML = '<i class="bi bi-check-circle"></i> Actualizar';
        });
    }

    // Funci√≥n para obtener el token CSRF (siguiendo la filosof√≠a de BaseAPI en _AppComplementos)
    // Funci√≥n para obtener CSRF token (versi√≥n robusta)
    function getCSRFToken() {
        // Primero intentar obtener del input hidden
        let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        // Si no se encuentra, intentar obtener de las cookies
        if (!token) {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            token = cookieValue;
        }
        
        // Validar que el token tenga el formato correcto (deber√≠a tener 64 caracteres)
        if (token && token.length !== 64) {
            //console.warn('‚ö†Ô∏è Token CSRF con longitud incorrecta:', token.length, 'caracteres. Esperados: 64');
        }
        
        //console.log('üîê Token CSRF obtenido:', token ? `‚úÖ V√°lido (${token.length} chars)` : '‚ùå No encontrado');
        return token || '';
    }

    function aplicarModoSoloLectura() {
        // Obtener todos los campos del formulario
        const formElements = form.querySelectorAll('input, select, textarea');
        
        formElements.forEach(element => {
            // Hacer los campos de solo lectura
            element.setAttribute('readonly', 'readonly');
            element.style.backgroundColor = '#f8f9fa';
            element.style.cursor = 'not-allowed';
            
            // Agregar tooltip explicativo
            element.setAttribute('title', 'Solo lectura - Supervisor no puede modificar configuraciones');
        });

        // Deshabilitar tambi√©n cualquier bot√≥n dentro del formulario
        const formButtons = form.querySelectorAll('button[type="button"]:not(.btn-close)');
        formButtons.forEach(button => {
            button.disabled = true;
            button.style.cursor = 'not-allowed';
        });
        
        //console.log('‚úÖ Modo solo lectura aplicado para rol Supervisor');
    }
});
</script>