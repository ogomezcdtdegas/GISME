<!-- ====================================================================
     COMPONENTE: Modal de Configuraci√≥n de Coeficientes
     Descripci√≥n: Modal para configurar coeficientes de correcci√≥n y variables del sistema
     Uso: Se incluye en el template principal coriolis_spa.html
====================================================================== -->

<div class="modal fade" id="modalConfiguracionSistema" tabindex="-1" aria-labelledby="modalConfiguracionSistemaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfiguracionSistemaLabel">
          <i class="bi bi-gear-fill"></i> Configuraci√≥n General
          {% if readonly_config_view %}
          <span class="badge bg-warning ms-2">Solo Lectura</span>
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="configTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-correccion-tab" data-bs-toggle="tab" data-bs-target="#tab-correccion" type="button" role="tab" aria-controls="tab-correccion" aria-selected="true">Coeficientes de Correcci√≥n</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-batch-tab" data-bs-toggle="tab" data-bs-target="#tab-batch" type="button" role="tab" aria-controls="tab-batch" aria-selected="false">Detecci√≥n de Batch</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-tickets-tab" data-bs-toggle="tab" data-bs-target="#tab-tickets" type="button" role="tab" aria-controls="tab-tickets" aria-selected="false">Tickets</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-diagnostico-tab" data-bs-toggle="tab" data-bs-target="#tab-diagnostico" type="button" role="tab" aria-controls="tab-diagnostico" aria-selected="false">Diagn√≥stico</button>
          </li>
          <li class="nav-item dropdown" role="presentation">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Incertidumbre</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" id="tab-variables-medicion-tab" data-bs-toggle="tab" href="#tab-variables-medicion" role="tab" aria-controls="tab-variables-medicion">Variables Medici√≥n</a></li>
              <li><a class="dropdown-item" id="tab-medicion-densidad-tab" data-bs-toggle="tab" href="#tab-medicion-densidad" role="tab" aria-controls="tab-medicion-densidad">Medici√≥n de Densidad</a></li>
              <li><a class="dropdown-item" id="tab-caracteristicas-medidor-tab" data-bs-toggle="tab" href="#tab-caracteristicas-medidor" role="tab" aria-controls="tab-caracteristicas-medidor">Caracter√≠sticas del Medidor</a></li>
            </ul>
          </li>
        </ul>

        <form id="formConfiguracionSistema" class="pt-3">
          <div class="tab-content" id="configTabsContent">
            <!-- Tab: Coeficientes de Correcci√≥n -->
            <div class="tab-pane fade show active" id="tab-correccion" role="tabpanel" aria-labelledby="tab-correccion-tab">
              <div class="row align-items-center mb-4">
                <div class="col-auto">
                  <h6 class="fw-bold mb-0">Temperatura de Salida:</h6>
                </div>
            
                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">M</span>
                    <input type="number" class="form-control" id="tempSalidaM" name="tempSalidaM" step="any" placeholder="Ingrese valor M">
                  </div>
                </div>
            
                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">B</span>
                    <input type="number" class="form-control" id="tempSalidaB" name="tempSalidaB" step="any" placeholder="Ingrese valor B">
                  </div>
                </div>
              </div>

              <div class="row align-items-center mb-4">
                <div class="col-auto">
                  <h6 class="fw-bold mb-0">Presi√≥n de Salida:</h6>
                </div>

                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">M</span>
                    <input type="number" class="form-control" id="presionSalidaM" name="presionSalidaM" step="any" placeholder="Ingrese valor M">
                  </div>
                </div>
                
                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">B</span>
                    <input type="number" class="form-control" id="presionSalidaB" name="presionSalidaB" step="any" placeholder="Ingrese valor B">
                  </div>
                </div>
              </div>

              <div class="alert alert-info d-flex align-items-center mt-3">
                <i class="bi bi-info-circle me-2"></i>
                <small>
                  <strong>Informaci√≥n: </strong>Los coeficientes M y B se utilizan para la correcci√≥n lineal de las variables del sistema.<br>
                  <strong>F√≥rmula: </strong><code>Valor_Corregido = M √ó Valor_Original + B</code>
                </small>
              </div>
            </div>

            <!-- Tab: Detecci√≥n de Batch -->
            <div class="tab-pane fade" id="tab-batch" role="tabpanel" aria-labelledby="tab-batch-tab">
              <div class="row mb-4">
                <div class="col-md-3">
                  <label for="limInfCaudalMasico" class="fw-bold form-label">L√≠m Inf Q. M√°sico:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="limInfCaudalMasico" name="limInfCaudalMasico" step="any" placeholder="0.0" min="0">
                    <span class="input-group-text">kg/min</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="limSupCaudalMasico" class="fw-bold form-label">L√≠m Sup Q. M√°sico:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="limSupCaudalMasico" name="limSupCaudalMasico" step="any" placeholder="1000000.0" min="0">
                    <span class="input-group-text">kg/min</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="volMasicoIniBatch" class="fw-bold form-label">Volumen:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="volMasicoIniBatch" name="volMasicoIniBatch" step="any" placeholder="0.0" min="0">
                    <span class="input-group-text">kg</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="timeFinishedBatch" class="fw-bold form-label">Tiempo de Cierre:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="timeFinishedBatch" name="timeFinishedBatch" step="0.1" placeholder="2.0" min="0.1">
                    <span class="input-group-text">min</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Tickets -->
            <div class="tab-pane fade" id="tab-tickets" role="tabpanel" aria-labelledby="tab-tickets-tab">
              <div class="row mb-4 align-items-center g-3 d-flex">
                <div class="col-auto">
                  <h6 class="fw-bold mb-0">Configuraci√≥n Ticket:</h6>
                </div>
                <div class="col-md-3 d-flex align-items-center">
                  <label for="numberTicket" class="fw-bold form-label mb-0 me-1">#</label>
                  <input type="number" class="form-control" id="numberTicket" name="numberTicket" step="any" placeholder="0" min="0">
                </div>
              </div>
            </div>

            <!-- Tab: Diagn√≥stico -->
            <div class="tab-pane fade" id="tab-diagnostico" role="tabpanel" aria-labelledby="tab-diagnostico-tab">
              <div class="row g-3">
                <div class="col-lg-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-header bg-info text-white fw-bold">
                      <i class="bi bi-droplet-half"></i> Fluido y Mult√≠fases
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="diagnosticGlpDensityRef" class="fw-bold form-label">Densidad de referencia GLP</label>
                        <div class="input-group">
                          <input type="number" step="0.0001" class="form-control" id="diagnosticGlpDensityRef" name="diagnosticGlpDensityRef" placeholder="0.55">
                          <span class="input-group-text">g/cc</span>
                        </div>
                        <small class="text-muted">Usada para estimar el porcentaje de agua por mezcla de densidades.</small>
                      </div>
                      <div class="mb-3">
                        <label for="diagnosticGlpDensityTolerance" class="fw-bold form-label">Variaci√≥n permitida GLP</label>
                        <div class="input-group">
                          <input type="number" step="0.1" class="form-control" id="diagnosticGlpDensityTolerance" name="diagnosticGlpDensityTolerance" placeholder="5">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Margen para absorber variaciones naturales del GLP.</small>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-header bg-secondary text-white fw-bold">
                      <i class="bi bi-activity"></i> Se√±ales del medidor
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="diagnosticDriverAmpBase" class="fw-bold form-label">Driver Amp base</label>
                        <div class="input-group">
                          <input type="number" step="0.01" class="form-control" id="diagnosticDriverAmpBase" name="diagnosticDriverAmpBase" placeholder="Ingrese referencia">
                          <span class="input-group-text">mA</span>
                        </div>
                        <small class="text-muted">Valor nominal configurado en sitio.</small>
                      </div>
                      <div class="mb-3">
                        <label for="diagnosticDriverAmpMultiplier" class="fw-bold form-label">Multiplicador alerta Driver Amp</label>
                        <div class="input-group">
                          <input type="number" step="0.05" class="form-control" id="diagnosticDriverAmpMultiplier" name="diagnosticDriverAmpMultiplier" placeholder="1.3" min="1">
                        </div>
                        <small class="text-muted">Se marcar√° alerta cuando Driver Amp supere base √ó multiplicador.</small>
                      </div>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label for="diagnosticN1Threshold" class="fw-bold form-label">Umbral N1</label>
                          <div class="input-group">
                            <input type="number" step="0.01" class="form-control" id="diagnosticN1Threshold" name="diagnosticN1Threshold" placeholder="Valor m√°ximo">
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="diagnosticN2Threshold" class="fw-bold form-label">Umbral N2</label>
                          <div class="input-group">
                            <input type="number" step="0.01" class="form-control" id="diagnosticN2Threshold" name="diagnosticN2Threshold" placeholder="Valor m√°ximo">
                          </div>
                        </div>
                      </div>
                      <div class="mt-3">
                        <label for="diagnosticAmpImbalanceThreshold" class="fw-bold form-label">Umbral desbalance A1/A2</label>
                        <div class="input-group">
                          <input type="number" step="0.1" class="form-control" id="diagnosticAmpImbalanceThreshold" name="diagnosticAmpImbalanceThreshold" placeholder="5">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Se√±ala alerta si |A1-A2|/(A1+A2) supera este porcentaje.</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Incertidumbre / Variables Medici√≥n -->
            <div class="tab-pane fade" id="tab-variables-medicion" role="tabpanel" aria-labelledby="tab-variables-medicion-tab">
              <div class="row g-3">
                <div class="col-md-3">
                  <label for="MF" class="fw-bold form-label">Factor de Correcci√≥n</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="MF" name="MF" placeholder="1.0">
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="vis" class="fw-bold form-label">Viscosidad din√°mica</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="vis" name="vis" placeholder="0.0">
                    <span class="input-group-text">cP</span>
                  </div>
                </div>

                <div class="col-md-3">
                  <label for="deltavis" class="fw-bold form-label">Rango viscosidad</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="deltavis" name="deltavis" placeholder="0.0">
                    <span class="input-group-text">cP</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="DN" class="fw-bold form-label">Di√°metro nominal</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="DN" name="DN" placeholder="0.0">
                    <span class="input-group-text">in</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Incertidumbre / Medici√≥n de Densidad -->
            <div class="tab-pane fade" id="tab-medicion-densidad" role="tabpanel" aria-labelledby="tab-medicion-densidad-tab">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="ucalDens" class="fw-bold form-label">Incertidumbre Calibraci√≥n Densit√≥metro</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="ucalDens" name="ucalDens" placeholder="0.0">
                    <span class="input-group-text">kg/m¬≥</span>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="kcalDens" class="fw-bold form-label">Factor de Cobertura Densit√≥metro</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="kcalDens" name="kcalDens" placeholder="0.0">
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="tipdens" class="fw-bold form-label">Tipo de Densit√≥metro</label>
                  <select class="form-select" id="tipdens" name="tipdens">
                    <option value="" selected disabled>‚Äî Seleccione ‚Äî</option>
                    <option value="Tipo Coriolis">Tipo Coriolis</option>
                    <option value="Tipo Tubo Vibrante">Tipo Tubo Vibrante</option>
                    <option value="Tipo Diente de horquilla de inserci√≥n">Tipo Diente de horquilla de inserci√≥n</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="desvdens" class="fw-bold form-label">Desviaci√≥n Viscosidad</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="desvdens" name="desvdens" placeholder="0.0">
                    <span class="input-group-text">kg/m¬≥</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Incertidumbre / Caracter√≠sticas del Medidor -->
            <div class="tab-pane fade" id="tab-caracteristicas-medidor" role="tabpanel" aria-labelledby="tab-caracteristicas-medidor-tab">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="ucalMet" class="fw-bold form-label">Incertidumbre Calibraci√≥n Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="ucalMet" name="ucalMet" placeholder="0.0">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="kcalMet" class="fw-bold form-label">Factor de Cobertura Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="kcalMet" name="kcalMet" placeholder="0.0">
                  </div>
                </div>

                <div class="col-md-4">
                  <label for="esisMet" class="fw-bold form-label">Error m√°ximo Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="esisMet" name="esisMet" placeholder="0.0">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="ucartaMet" class="fw-bold form-label">Incertidumbre Carta Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="ucartaMet" name="ucartaMet" placeholder="0.0">
                    <span class="input-group-text">%</span>
                  </div>
                </div>

                <div class="col-md-4">
                  <label for="zeroStab" class="fw-bold form-label">Estabilidad en cero Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="zeroStab" name="zeroStab" placeholder="0.0">
                    <span class="input-group-text">Kg/m¬≥</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
        {% if can_configure_constants %}
        <button type="button" class="btn btn-primary" id="btnActualizarCoeficientes">
          <i class="bi bi-check-circle"></i> Actualizar
        </button>
        {% elif readonly_config_view %}
        <button type="button" class="btn btn-outline-secondary" disabled title="Solo los Administradores pueden modificar coeficientes">
          <i class="bi bi-lock"></i> Solo Lectura (Supervisor)
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// Script para manejar la funcionalidad del modal de configuraci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Manejar el evento cuando el modal se cierra para evitar advertencias de aria-hidden
    const modal = document.getElementById('modalConfiguracionSistema');
    const btnActualizar = document.getElementById('btnActualizarCoeficientes');
    const form = document.getElementById('formConfiguracionSistema');
    const setInputValue = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            el.value = value;
        }
    };
    const getInputValue = (id, parser = parseFloat) => {
        const el = document.getElementById(id);
        if (!el) {
            return null;
        }
        return parser === null ? el.value : parser(el.value);
    };
    
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function () {
            // Quitar el foco de cualquier elemento que pueda estar enfocado
            if (document.activeElement) {
                document.activeElement.blur();
            }
        });
        
        modal.addEventListener('hide.bs.modal', function () {
            // Quitar el foco antes de que el modal se cierre
            if (document.activeElement) {
                document.activeElement.blur();
            }
        });
    }

    // Cargar valores actuales al abrir el modal
    modal.addEventListener('show.bs.modal', function () {
        cargarCoeficientesActuales();
    });

    // Manejar click del bot√≥n Actualizar (si el usuario tiene permisos)
    if (btnActualizar) {
        btnActualizar.addEventListener('click', function() {
            actualizarCoeficientes();
        });
    }

    function cargarCoeficientesActuales() {
        //console.log('Cargando coeficientes actuales...');
        
        // Obtener el ID del sistema desde la URL
        const sistemaId = obtenerSistemaIdDesdeURL();
        
        if (!sistemaId) {
            //console.warn('No se encontr√≥ ID del sistema actual. Usando valores por defecto.');
            cargarValoresPorDefecto();
            return;
        }

        // Guardar el ID del sistema para uso posterior
        window.SISTEMA_ACTUAL = { id: sistemaId };

        // Cargar coeficientes desde el backend
        fetch(`/complementos/api/coeficientes/${sistemaId}/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                setInputValue('tempSalidaM', data.data.mt ?? '1.0');
                setInputValue('tempSalidaB', data.data.bt ?? '0.0');
                setInputValue('presionSalidaM', data.data.mp ?? '1.0');
                setInputValue('presionSalidaB', data.data.bp ?? '0.0');
                
                // Nuevos campos de configuraci√≥n de batch
                setInputValue('limInfCaudalMasico', data.data.lim_inf_caudal_masico ?? '0.0');
                setInputValue('limSupCaudalMasico', data.data.lim_sup_caudal_masico ?? '1000000.0');
                setInputValue('volMasicoIniBatch', data.data.vol_masico_ini_batch ?? '0.0');
                setInputValue('numberTicket', data.data.num_ticket ?? '1');
                setInputValue('timeFinishedBatch', data.data.time_finished_batch ?? '2.0');

                // Campos de incertidumbre
                setInputValue('MF', data.data.mf ?? '1.0');
                setInputValue('vis', data.data.vis ?? '0.0');
                setInputValue('deltavis', data.data.deltavis ?? '0.0');
                setInputValue('DN', data.data.dn ?? '0.0');
                setInputValue('ucalDens', data.data.ucal_dens ?? '0.0');
                setInputValue('kcalDens', data.data.kcal_dens ?? '0.0');
                setInputValue('tipdens', data.data.tipdens ?? '');
                setInputValue('desvdens', data.data.desv_dens ?? '0.0');
                setInputValue('ucalMet', data.data.ucal_met ?? '0.0');
                setInputValue('kcalMet', data.data.kcal_met ?? '0.0');
                setInputValue('esisMet', data.data.esis_met ?? '0.0');
                setInputValue('ucartaMet', data.data.ucarta_met ?? '0.0');
                setInputValue('zeroStab', data.data.zero_stab ?? '0.0');
                const diagInputs = {
                    diagnosticGlpDensityRef: data.data.diagnostic_glp_density_ref ?? '0.55',
                    diagnosticGlpDensityTolerance: data.data.diagnostic_glp_density_tolerance_pct ?? '5',
            diagnosticDriverAmpBase: data.data.diagnostic_driver_amp_base ?? '',
            diagnosticDriverAmpMultiplier: data.data.diagnostic_driver_amp_multiplier ?? '1.3',
            diagnosticN1Threshold: data.data.diagnostic_n1_threshold ?? '',
            diagnosticN2Threshold: data.data.diagnostic_n2_threshold ?? '',
            diagnosticAmpImbalanceThreshold: data.data.diagnostic_amp_imbalance_threshold_pct ?? '5'
        };
        Object.entries(diagInputs).forEach(([id, value]) => {
            const input = document.getElementById(id);
            if (input) {
                input.value = value;
            }
        });
                
                if (!data.exists) {
                    //console.info('Coeficientes no configurados. Mostrando valores por defecto.');
                }
            } else {
                //console.warn('Error al cargar coeficientes:', data.error);
                cargarValoresPorDefecto();
            }
        })
        .catch(error => {
            //console.error('Error de conexi√≥n al cargar coeficientes:', error);
            cargarValoresPorDefecto();
        });
    }

    function obtenerSistemaIdDesdeURL() {
        // Obtener el ID del sistema desde la URL actual
        // Patr√≥n: /monitoreo/sistema/ID_DEL_SISTEMA/
        const urlPath = window.location.pathname;
        const sistemaMatch = urlPath.match(/\/sistema\/([a-f0-9-]{36})\//);
        
        if (sistemaMatch && sistemaMatch[1]) {
            //console.log('ID del sistema obtenido desde URL:', sistemaMatch[1]);
            return sistemaMatch[1];
        }
        
        //console.warn('No se pudo extraer el ID del sistema desde la URL:', urlPath);
        return null;
    }

    function cargarValoresPorDefecto() {
        const defaults = {
            tempSalidaM: '1.0',
            tempSalidaB: '0.0',
            presionSalidaM: '1.0',
            presionSalidaB: '0.0',
            limInfCaudalMasico: '0.0',
            limSupCaudalMasico: '1000000.0',
            volMasicoIniBatch: '0.0',
            numberTicket: '1',
            timeFinishedBatch: '2.0',
            MF: '1.0',
            vis: '0.0',
            deltavis: '0.0',
            DN: '0.0',
            ucalDens: '0.0',
            kcalDens: '0.0',
            tipdens: '',
            desvdens: '0.0',
            ucalMet: '0.0',
            kcalMet: '0.0',
            esisMet: '0.0',
            ucartaMet: '0.0',
            zeroStab: '0.0',
            diagnosticGlpDensityRef: '0.55',
            diagnosticGlpDensityTolerance: '5',
            diagnosticDriverAmpBase: '',
            diagnosticDriverAmpMultiplier: '1.3',
            diagnosticN1Threshold: '',
            diagnosticN2Threshold: '',
            diagnosticAmpImbalanceThreshold: '5'
        };
        Object.entries(defaults).forEach(([id, value]) => setInputValue(id, value));
    }

    function actualizarCoeficientes() {
        // Obtener el ID del sistema actual
        const sistemaId = window.SISTEMA_ACTUAL ? window.SISTEMA_ACTUAL.id : null;
        
        if (!sistemaId) {
            showErrorAlert('No se encontr√≥ el ID del sistema actual');
            return;
        }

        // Obtener valores del formulario
        const mt = getInputValue('tempSalidaM');
        const bt = getInputValue('tempSalidaB');
        const mp = getInputValue('presionSalidaM');
        const bp = getInputValue('presionSalidaB');
        
        // Obtener valores de configuraci√≥n de batch
        const limInfCaudalMasico = getInputValue('limInfCaudalMasico');
        const limSupCaudalMasico = getInputValue('limSupCaudalMasico');
        const volMasicoIniBatch = getInputValue('volMasicoIniBatch');
        const numTicketRaw = getInputValue('numberTicket', null);
        const numTicket = numTicketRaw !== null && numTicketRaw !== '' ? parseInt(numTicketRaw, 10) : null;
        const timeFinishedBatch = getInputValue('timeFinishedBatch');

  // =====================
  // Lectura campos incertidumbre
  // =====================
  const mfVal = getInputValue('MF');
  const visVal = getInputValue('vis');
  const deltavisVal = getInputValue('deltavis');
  const dnVal = getInputValue('DN');
  const ucalDensVal = getInputValue('ucalDens');
  const kcalDensVal = getInputValue('kcalDens');
  const tipdensVal = getInputValue('tipdens', null) || '';
  const desvDensVal = getInputValue('desvdens');
  const ucalMetVal = getInputValue('ucalMet');
  const kcalMetVal = getInputValue('kcalMet');
  const esisMetVal = getInputValue('esisMet');
  const ucartaMetVal = getInputValue('ucartaMet');
  const zeroStabVal = getInputValue('zeroStab');
  const diagGlpRefRaw = getInputValue('diagnosticGlpDensityRef', null) ?? '';
  const diagGlpToleranceRaw = getInputValue('diagnosticGlpDensityTolerance', null) ?? '';
  const diagDriverAmpBaseRaw = getInputValue('diagnosticDriverAmpBase', null) ?? '';
  const diagDriverAmpMultiplierRaw = getInputValue('diagnosticDriverAmpMultiplier', null) ?? '';
  const diagN1Raw = getInputValue('diagnosticN1Threshold', null) ?? '';
  const diagN2Raw = getInputValue('diagnosticN2Threshold', null) ?? '';
  const diagImbalanceRaw = getInputValue('diagnosticAmpImbalanceThreshold', null) ?? '';

  const diagGlpRefVal = diagGlpRefRaw === '' ? null : parseFloat(diagGlpRefRaw);
  const diagGlpToleranceVal = diagGlpToleranceRaw === '' ? null : parseFloat(diagGlpToleranceRaw);
  const diagDriverAmpBaseVal = diagDriverAmpBaseRaw === '' ? null : parseFloat(diagDriverAmpBaseRaw);
  const diagDriverAmpMultiplierVal = diagDriverAmpMultiplierRaw === '' ? null : parseFloat(diagDriverAmpMultiplierRaw);
  const diagN1Val = diagN1Raw === '' ? null : parseFloat(diagN1Raw);
  const diagN2Val = diagN2Raw === '' ? null : parseFloat(diagN2Raw);
  const diagImbalanceVal = diagImbalanceRaw === '' ? null : parseFloat(diagImbalanceRaw);

        // Validar que todos los valores son n√∫meros v√°lidos
        const requeridos = [mt, bt, mp, bp, limInfCaudalMasico, limSupCaudalMasico, volMasicoIniBatch, timeFinishedBatch];
        if (requeridos.some(v => v === null || Number.isNaN(v)) || numTicket === null || Number.isNaN(numTicket)) {
            showErrorAlert('Todos los valores deben ser n√∫meros v√°lidos');
            return;
        }

    // Validar campos de incertidumbre (solo si no son NaN; permitir que est√©n en 0)
    const incertidumbreNumericos = [mfVal, visVal, deltavisVal, dnVal, ucalDensVal, kcalDensVal, desvDensVal, ucalMetVal, kcalMetVal, esisMetVal, ucartaMetVal, zeroStabVal];
    const algunNaN = incertidumbreNumericos.some(v => isNaN(v));
    if (algunNaN) {
      showErrorAlert('Campos de incertidumbre contienen valores no num√©ricos');
      return;
    }

    const diagnosticoValores = [diagGlpRefVal, diagGlpToleranceVal, diagDriverAmpBaseVal, diagDriverAmpMultiplierVal, diagN1Val, diagN2Val, diagImbalanceVal];
    const diagnosticoInvalido = diagnosticoValores.some(v => v !== null && Number.isNaN(v));
    if (diagnosticoInvalido) {
      showErrorAlert('Campos de diagn√≥stico contienen valores no num√©ricos');
      return;
    }

    if (diagGlpRefVal !== null && diagGlpRefVal <= 0) {
      showErrorAlert('La densidad de referencia debe ser mayor a 0');
      return;
    }

    if (diagGlpToleranceVal !== null && diagGlpToleranceVal < 0) {
      showErrorAlert('La variaci√≥n de densidad no puede ser negativa');
      return;
    }

    if (diagDriverAmpMultiplierVal !== null && diagDriverAmpMultiplierVal < 1) {
      showErrorAlert('El multiplicador de Driver Amp debe ser mayor o igual a 1');
      return;
    }

    if (diagImbalanceVal !== null && diagImbalanceVal < 0) {
      showErrorAlert('El umbral de desbalance no puede ser negativo');
      return;
    }
        
        // Validaciones adicionales
        if (limInfCaudalMasico < 0 || limSupCaudalMasico < 0 || volMasicoIniBatch < 0 || numTicket < 1 || timeFinishedBatch < 0.1) {
            showErrorAlert('Los valores de configuraci√≥n no pueden ser negativos, el n√∫mero de ticket debe ser mayor a 0 y el tiempo de cierre debe ser mayor a 0.1 minutos');
            return;
        }
        
        if (limInfCaudalMasico >= limSupCaudalMasico) {
            showErrorAlert('Error: El l√≠mite inferior debe ser menor que el l√≠mite superior');
            return;
        }

        const coeficientes = {
            mt: mt,
            bt: bt,
            mp: mp,
            bp: bp,
            lim_inf_caudal_masico: limInfCaudalMasico,
            lim_sup_caudal_masico: limSupCaudalMasico,
            vol_masico_ini_batch: volMasicoIniBatch,
            num_ticket: numTicket,
      time_finished_batch: timeFinishedBatch,
            // Campos incertidumbre (sin densidad manual)
      mf: mfVal,
      vis: visVal,
      deltavis: deltavisVal,
      dn: dnVal,
      ucal_dens: ucalDensVal,
      kcal_dens: kcalDensVal,
      tipdens: tipdensVal,
      desv_dens: desvDensVal,
      ucal_met: ucalMetVal,
      kcal_met: kcalMetVal,
      esis_met: esisMetVal,
      ucarta_met: ucartaMetVal,
      zero_stab: zeroStabVal,
      diagnostic_glp_density_ref: diagGlpRefVal,
      diagnostic_glp_density_tolerance_pct: diagGlpToleranceVal,
      diagnostic_driver_amp_base: diagDriverAmpBaseVal,
      diagnostic_driver_amp_multiplier: diagDriverAmpMultiplierVal,
      diagnostic_n1_threshold: diagN1Val,
      diagnostic_n2_threshold: diagN2Val,
      diagnostic_amp_imbalance_threshold_pct: diagImbalanceVal
        };

        //console.log('Actualizando coeficientes:', coeficientes);

        // Mostrar indicador de carga
        btnActualizar.disabled = true;
        btnActualizar.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';

        // Llamada al backend para guardar los coeficientes
        fetch(`/monitoreo/api/configuracion/actualizar/${sistemaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(coeficientes)
        })
        .then(async response => {
            // Verificar si hay error de permisos
            if (response.status === 403) {
                const data = await response.json();
                const errorMsg = data.error || 'No tiene permisos para esta acci√≥n. Contacte al administrador.';
                const permissionError = new Error(errorMsg);
                permissionError.isPermissionError = true;
                throw permissionError;
            }
            
            // Manejar otros errores HTTP (incluyendo 400)
            if (!response.ok) {
                const data = await response.json();
                // Extraer el mensaje personalizado del backend
                const errorMsg = data.error || data.message || `Error ${response.status}: ${response.statusText}`;
                throw new Error(errorMsg);
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de √©xito con SweetAlert2
                showSuccessAlert(data.message || 'Coeficientes actualizados correctamente');
                // Cerrar modal
                bootstrap.Modal.getInstance(modal).hide();
            } else {
                showErrorAlert('Error al actualizar coeficientes: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            //console.error('Error:', error);
            // Verificar si es error de permisos
            if (error.isPermissionError || error.message.includes('permisos') || error.message.includes('administrador')) {
                showPermissionDeniedAlert(error.message);
            } else {
                showErrorAlert(error.message || 'Error de conexi√≥n al actualizar coeficientes');
            }
        })
        .finally(() => {
            // Restaurar bot√≥n
            btnActualizar.disabled = false;
            btnActualizar.innerHTML = '<i class="bi bi-check-circle"></i> Actualizar';
        });
    }

    // Funci√≥n para obtener el token CSRF (siguiendo la filosof√≠a de BaseAPI en _AppComplementos)
    // Funci√≥n para obtener CSRF token (versi√≥n robusta)
    function getCSRFToken() {
        // Primero intentar obtener del input hidden
        let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        // Si no se encuentra, intentar obtener de las cookies
        if (!token) {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            token = cookieValue;
        }
        
        // Validar que el token tenga el formato correcto (deber√≠a tener 64 caracteres)
        if (token && token.length !== 64) {
            //console.warn('‚ö†Ô∏è Token CSRF con longitud incorrecta:', token.length, 'caracteres. Esperados: 64');
        }
        
        //console.log('üîê Token CSRF obtenido:', token ? `‚úÖ V√°lido (${token.length} chars)` : '‚ùå No encontrado');
        return token || '';
    }

    function aplicarModoSoloLectura() {
        // Obtener todos los campos del formulario
        const formElements = form.querySelectorAll('input, select, textarea');
        
        formElements.forEach(element => {
            // Hacer los campos de solo lectura
            element.setAttribute('readonly', 'readonly');
            element.style.backgroundColor = '#f8f9fa';
            element.style.cursor = 'not-allowed';
            
            // Agregar tooltip explicativo
            element.setAttribute('title', 'Solo lectura - Supervisor no puede modificar configuraciones');
        });

        // Deshabilitar tambi√©n cualquier bot√≥n dentro del formulario
        const formButtons = form.querySelectorAll('button[type="button"]:not(.btn-close)');
        formButtons.forEach(button => {
            button.disabled = true;
            button.style.cursor = 'not-allowed';
        });
        
        //console.log('‚úÖ Modo solo lectura aplicado para rol Supervisor');
    }
});
</script>
