{% load static %}
<!-- ====================================================================
     COMPONENTE: Modal de Configuración de Coeficientes
     Descripción: Modal para configurar coeficientes de corrección y variables del sistema
     Uso: Se incluye en el template principal coriolis_spa.html
====================================================================== -->

<div class="modal fade" id="modalConfiguracionSistema" tabindex="-1" aria-labelledby="modalConfiguracionSistemaLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfiguracionSistemaLabel">
          <i class="bi bi-gear-fill"></i> Configuración General
          {% if readonly_config_view %}
          <span class="badge bg-warning ms-2">Solo Lectura</span>
          {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="configTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-correccion-tab" data-bs-toggle="tab" data-bs-target="#tab-correccion" type="button" role="tab" aria-controls="tab-correccion" aria-selected="true">Coeficientes de Corrección</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-batch-tab" data-bs-toggle="tab" data-bs-target="#tab-batch" type="button" role="tab" aria-controls="tab-batch" aria-selected="false">Detección de Batch</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-diagnostico-tab" data-bs-toggle="tab" data-bs-target="#tab-diagnostico" type="button" role="tab" aria-controls="tab-diagnostico" aria-selected="false">Diagnóstico</button>
          </li>
          <li class="nav-item dropdown" role="presentation">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">Incertidumbre</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" id="tab-variables-medicion-tab" data-bs-toggle="tab" href="#tab-variables-medicion" role="tab" aria-controls="tab-variables-medicion">Variables Medición</a></li>
              <li><a class="dropdown-item" id="tab-medicion-densidad-tab" data-bs-toggle="tab" href="#tab-medicion-densidad" role="tab" aria-controls="tab-medicion-densidad">Medición de Densidad</a></li>
              <li><a class="dropdown-item" id="tab-caracteristicas-medidor-tab" data-bs-toggle="tab" href="#tab-caracteristicas-medidor" role="tab" aria-controls="tab-caracteristicas-medidor">Características del Medidor</a></li>
            </ul>
          </li>
        </ul>

        <form id="formConfiguracionSistema" class="pt-3">
          <div class="tab-content" id="configTabsContent">
            <!-- Tab: Coeficientes de Corrección -->
            <div class="tab-pane fade show active" id="tab-correccion" role="tabpanel" aria-labelledby="tab-correccion-tab">
              <div class="row align-items-center mb-4">
                <div class="col-auto">
                  <h6 class="fw-bold mb-0">Temperatura de Salida:</h6>
                </div>
            
                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">M</span>
                    <input type="number" class="form-control" id="tempSalidaM" name="tempSalidaM" step="any" placeholder="Ingrese valor M">
                  </div>
                </div>
            
                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">B</span>
                    <input type="number" class="form-control" id="tempSalidaB" name="tempSalidaB" step="any" placeholder="Ingrese valor B">
                  </div>
                </div>
              </div>

              <div class="row align-items-center mb-4">
                <div class="col-auto">
                  <h6 class="fw-bold mb-0">Presión de Salida:</h6>
                </div>

                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">M</span>
                    <input type="number" class="form-control" id="presionSalidaM" name="presionSalidaM" step="any" placeholder="Ingrese valor M">
                  </div>
                </div>
                
                <div class="col-auto">
                  <div class="input-group">
                    <span class="fw-bold input-group-text">B</span>
                    <input type="number" class="form-control" id="presionSalidaB" name="presionSalidaB" step="any" placeholder="Ingrese valor B">
                  </div>
                </div>
              </div>

              <div class="alert alert-info d-flex align-items-center mt-3">
                <i class="bi bi-info-circle me-2"></i>
                <small>
                  <strong>Información: </strong>Los coeficientes M y B se utilizan para la corrección lineal de las variables del sistema.<br>
                  <strong>Fórmula: </strong><code>Valor_Corregido = M × Valor_Original + B</code>
                </small>
              </div>
            </div>

            <!-- Tab: Detección de Batch -->
            <div class="tab-pane fade" id="tab-batch" role="tabpanel" aria-labelledby="tab-batch-tab">
              <div class="row mb-4">
                <div class="col-md-3">
                  <label for="limInfCaudalMasico" class="fw-bold form-label">Lím Inf Q. Másico:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="limInfCaudalMasico" name="limInfCaudalMasico" step="any" placeholder="0.0" min="0">
                    <span class="input-group-text">kg/min</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="limSupCaudalMasico" class="fw-bold form-label">Lím Sup Q. Másico:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="limSupCaudalMasico" name="limSupCaudalMasico" step="any" placeholder="1000000.0" min="0">
                    <span class="input-group-text">kg/min</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="volMasicoIniBatch" class="fw-bold form-label">Volumen:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="volMasicoIniBatch" name="volMasicoIniBatch" step="any" placeholder="0.0" min="0">
                    <span class="input-group-text">kg</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="timeFinishedBatch" class="fw-bold form-label">Tiempo de Cierre:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="timeFinishedBatch" name="timeFinishedBatch" step="0.1" placeholder="2.0" min="0.1">
                    <span class="input-group-text">min</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Diagnóstico -->
            <div class="tab-pane fade" id="tab-diagnostico" role="tabpanel" aria-labelledby="tab-diagnostico-tab">
              <div class="row g-3">
                <div class="col-lg-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-header bg-info text-white fw-bold">
                      <i class="bi bi-droplet-half"></i> Fluido y Multífases
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="diagnosticGlpDensityRef" class="fw-bold form-label">Densidad de referencia GLP</label>
                        <div class="input-group">
                          <input type="number" step="0.0001" class="form-control" id="diagnosticGlpDensityRef" name="diagnosticGlpDensityRef" placeholder="0.55">
                          <span class="input-group-text">g/cc</span>
                        </div>
                        <small class="text-muted">Usada para estimar el porcentaje de agua por mezcla de densidades.</small>
                      </div>
                      <div class="mb-3">
                        <label for="diagnosticGlpDensityTolerance" class="fw-bold form-label">Variación permitida GLP</label>
                        <div class="input-group">
                          <input type="number" step="0.1" class="form-control" id="diagnosticGlpDensityTolerance" name="diagnosticGlpDensityTolerance" placeholder="5">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Margen para absorber variaciones naturales del GLP.</small>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-header bg-secondary text-white fw-bold">
                      <i class="bi bi-activity"></i> Señales del medidor
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <label for="diagnosticDriverAmpBase" class="fw-bold form-label">Driver Amp base</label>
                        <div class="input-group">
                          <input type="number" step="0.01" class="form-control" id="diagnosticDriverAmpBase" name="diagnosticDriverAmpBase" placeholder="Ingrese referencia">
                          <span class="input-group-text">__</span>
                        </div>
                        <small class="text-muted">Valor nominal configurado en sitio.</small>
                      </div>
                      <div class="mb-3">
                        <label for="diagnosticDriverAmpMultiplier" class="fw-bold form-label">Multiplicador alerta Driver Amp</label>
                        <div class="input-group">
                          <input type="number" step="0.05" class="form-control" id="diagnosticDriverAmpMultiplier" name="diagnosticDriverAmpMultiplier" placeholder="1.3" min="1">
                        </div>
                        <small class="text-muted">Se marcará alerta cuando Driver Amp supere base × multiplicador.</small>
                      </div>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label for="diagnosticN1Threshold" class="fw-bold form-label">Umbral N1</label>
                          <div class="input-group">
                            <input type="number" step="0.01" class="form-control" id="diagnosticN1Threshold" name="diagnosticN1Threshold" placeholder="Valor máximo">
                          </div>
                        </div>
                        <div class="col-md-6">
                          <label for="diagnosticN2Threshold" class="fw-bold form-label">Umbral N2</label>
                          <div class="input-group">
                            <input type="number" step="0.01" class="form-control" id="diagnosticN2Threshold" name="diagnosticN2Threshold" placeholder="Valor máximo">
                          </div>
                        </div>
                      </div>
                      <div class="mt-3">
                        <label for="diagnosticAmpImbalanceThreshold" class="fw-bold form-label">Umbral desbalance A1/A2</label>
                        <div class="input-group">
                          <input type="number" step="0.1" class="form-control" id="diagnosticAmpImbalanceThreshold" name="diagnosticAmpImbalanceThreshold" placeholder="5">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Señala alerta si |A1-A2|/(A1+A2) supera este porcentaje.</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Incertidumbre / Variables Medición -->
            <div class="tab-pane fade" id="tab-variables-medicion" role="tabpanel" aria-labelledby="tab-variables-medicion-tab">
              <div class="row g-3">
                <div class="col-md-3">
                  <label for="MF" class="fw-bold form-label">Factor de Corrección</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="MF" name="MF" placeholder="1.0">
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="vis" class="fw-bold form-label">Viscosidad dinámica</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="vis" name="vis" placeholder="0.0">
                    <span class="input-group-text">cP</span>
                  </div>
                </div>

                <div class="col-md-3">
                  <label for="deltavis" class="fw-bold form-label">Rango viscosidad</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="deltavis" name="deltavis" placeholder="0.0">
                    <span class="input-group-text">cP</span>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="DN" class="fw-bold form-label">Diámetro nominal</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="DN" name="DN" placeholder="0.0">
                    <span class="input-group-text">in</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Incertidumbre / Medición de Densidad -->
            <div class="tab-pane fade" id="tab-medicion-densidad" role="tabpanel" aria-labelledby="tab-medicion-densidad-tab">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="ucalDens" class="fw-bold form-label">Incertidumbre Calibración Densímetro</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="ucalDens" name="ucalDens" placeholder="0.0">
                    <span class="input-group-text">kg/m³</span>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="kcalDens" class="fw-bold form-label">Factor de Cobertura Densímetro</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="kcalDens" name="kcalDens" placeholder="0.0">
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="tipdens" class="fw-bold form-label">Tipo de Densímetro</label>
                  <select class="form-select" id="tipdens" name="tipdens">
                    <option value="" selected disabled>— Seleccione —</option>
                    <option value="Tipo Coriolis">Tipo Coriolis</option>
                    <option value="Tipo Tubo Vibrante">Tipo Tubo Vibrante</option>
                    <option value="Tipo Diente de horquilla de inserción">Tipo Diente de horquilla de inserción</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="desvdens" class="fw-bold form-label">Desviación Viscosidad</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="desvdens" name="desvdens" placeholder="0.0">
                    <span class="input-group-text">kg/m³</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Incertidumbre / Características del Medidor -->
            <div class="tab-pane fade" id="tab-caracteristicas-medidor" role="tabpanel" aria-labelledby="tab-caracteristicas-medidor-tab">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="ucalMet" class="fw-bold form-label">Incertidumbre Calibración Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="ucalMet" name="ucalMet" placeholder="0.0">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="kcalMet" class="fw-bold form-label">Factor de Cobertura Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="kcalMet" name="kcalMet" placeholder="0.0">
                  </div>
                </div>

                <div class="col-md-4">
                  <label for="esisMet" class="fw-bold form-label">Error máximo Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="esisMet" name="esisMet" placeholder="0.0">
                    <span class="input-group-text">%</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="ucartaMet" class="fw-bold form-label">Incertidumbre Carta Medidor</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="ucartaMet" name="ucartaMet" placeholder="0.0">
                    <span class="input-group-text">%</span>
                  </div>
                </div>

                <div class="col-md-4">
                  <label for="zeroStab" class="fw-bold form-label">Estabilidad en cero</label>
                  <div class="input-group">
                    <input type="number" step="any" class="form-control" id="zeroStab" name="zeroStab" placeholder="0.0">
                    <span class="input-group-text">Kg/min</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
        {% if can_configure_constants %}
        <button type="button" class="btn btn-primary" id="btnActualizarCoeficientes">
          <i class="bi bi-check-circle"></i> Actualizar
        </button>
        {% elif readonly_config_view %}
        <button type="button" class="btn btn-outline-secondary" disabled title="Solo los Administradores pueden modificar coeficientes">
          <i class="bi bi-lock"></i> Solo Lectura (Supervisor)
        </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- JavaScript para el modal de configuración -->
<script src="{% static '_AppMonitoreoCoriolis/js/js_modal_configuracion/modal_configuracion.js' %}"></script>
