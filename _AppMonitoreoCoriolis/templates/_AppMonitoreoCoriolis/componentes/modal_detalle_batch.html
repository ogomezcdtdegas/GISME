<!-- Modal para mostrar el detalle de un batch espec√≠fico -->
<div class="modal fade" id="modalDetalleBatch" tabindex="-1" aria-labelledby="modalDetalleBatchLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalleBatchLabel">
                    <i class="bi bi-graph-up"></i> Detalle del Batch Detectado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Informaci√≥n b√°sica del batch -->
                <div id="infoBatch" class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle"></i> Informaci√≥n del Batch</h6>
                            <div id="infoBatchBasica"></div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-bar-chart"></i> Estad√≠sticas</h6>
                            <div id="estadisticasBatch"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico del batch -->
                <div class="mb-3">
                    <h6><i class="bi bi-graph-up"></i> Gr√°fico del Batch</h6>
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="batchChart"></canvas>
                    </div>
                </div>
                
                <!-- Controles del gr√°fico -->
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showMassRate" checked>
                        <label class="form-check-label" for="showMassRate">
                            Flujo M√°sico (kg/min)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showTotalMass" checked>
                        <label class="form-check-label" for="showTotalMass">
                            Masa Total (lb)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showTemperature">
                        <label class="form-check-label" for="showTemperature">
                            Temperatura (¬∞C)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showDensity">
                        <label class="form-check-label" for="showDensity">
                            Densidad (g/cc)
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="descargarDatosBatch()">
                    <i class="bi bi-download"></i> Descargar Datos
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let batchChart = null;
let datosActualesBatch = null;

// Funci√≥n para mostrar el detalle del batch
function mostrarDetalleBatch(data) {
    // Guardar datos para uso posterior
    datosActualesBatch = data;
    
    // Mostrar informaci√≥n b√°sica
    document.getElementById('infoBatchBasica').innerHTML = `
        <p><strong>Sistema:</strong> ${data.batch_info.sistema_tag}</p>
        <p><strong>Inicio:</strong> ${data.batch_info.fecha_inicio}</p>
        <p><strong>Fin:</strong> ${data.batch_info.fecha_fin}</p>
        <p><strong>Duraci√≥n:</strong> ${data.batch_info.duracion_minutos} minutos</p>
        <div class="alert alert-info mt-2 mb-0" style="padding: 8px 12px; font-size: 0.85em;">
            <i class="bi bi-info-circle"></i> 
            <strong>Contexto extendido:</strong> La gr√°fica muestra 3 minutos antes y despu√©s del batch para mejor an√°lisis.
            <br>ÔøΩ <strong>L√≠nea azul clara:</strong> Datos del batch detectado (l√≠nea gruesa, puntos grandes)
            <br>üî∑ <strong>L√≠nea azul oscura:</strong> Datos de contexto - antes/despu√©s (l√≠nea m√°s fina, puntos peque√±os)
        </div>
    `;
    
    // Mostrar estad√≠sticas
    document.getElementById('estadisticasBatch').innerHTML = `
        <p><strong>Volumen Total:</strong> ${data.batch_info.vol_total} kg</p>
        <p><strong>Temp. Promedio:</strong> ${data.batch_info.temperatura_coriolis_prom}¬∞C</p>
        <p><strong>Densidad Promedio:</strong> ${data.batch_info.densidad_prom} g/cc</p>
        <p><strong>Total Registros:</strong> ${data.batch_info.total_registros}</p>
    `;
    
    // Crear el gr√°fico
    crearGraficoBatch(data.datos_grafico);
    
    // Configurar eventos de los checkboxes
    configurarEventosGraficoBatch();
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleBatch'));
    modal.show();
}

// Funci√≥n para crear el gr√°fico del batch
function crearGraficoBatch(datos) {
    const ctx = document.getElementById('batchChart').getContext('2d');
    
    // Destruir gr√°fico anterior si existe
    if (batchChart) {
        batchChart.destroy();
    }
    
    // Preparar datos para Chart.js
    const labels = datos.map(d => d.fecha_hora);
    
    // Separar datos del batch y del contexto para diferentes estilos
    const datosBatch = datos.filter(d => d.dentro_batch);
    const datosContexto = datos.filter(d => !d.dentro_batch);
    
    const datasets = [
        // Flujo m√°sico completo (contexto + batch) como una sola curva continua
        {
            label: 'Flujo M√°sico - Batch (kg/min)',
            data: datos.map(d => d.mass_rate_kg_min),
            borderColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'), // Azul normal para batch, azul oscuro para contexto
            backgroundColor: '#007bff20',
            yAxisID: 'y1',
            tension: 0.4,
            pointRadius: datos.map(d => d.dentro_batch ? 3 : 1), // Puntos m√°s grandes para el batch
            pointBorderColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'),
            pointBackgroundColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'),
            borderWidth: 2,
            segment: {
                borderColor: function(ctx) {
                    // Cambiar color del segmento seg√∫n si est√° en el batch o contexto
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? '#007bff' : '#004085';
                },
                borderWidth: function(ctx) {
                    // L√≠nea m√°s gruesa para el batch
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? 3 : 2;
                }
            },
            hidden: false
        },
        // Masa total completa (contexto + batch) como una sola curva continua
        {
            label: 'Masa Total - Batch (lb)',
            data: datos.map(d => d.total_mass),
            borderColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'), // Verde normal para batch, verde oscuro para contexto
            backgroundColor: '#28a74520',
            yAxisID: 'y2',
            tension: 0.4,
            pointRadius: datos.map(d => d.dentro_batch ? 3 : 1),
            pointBorderColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'),
            pointBackgroundColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'),
            borderWidth: 2,
            segment: {
                borderColor: function(ctx) {
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? '#28a745' : '#155724';
                },
                borderWidth: function(ctx) {
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? 3 : 2;
                }
            },
            hidden: false
        },
        {
            label: 'Temperatura (¬∞C)',
            data: datos.map(d => d.coriolis_temperature),
            borderColor: '#ffc107',
            backgroundColor: '#ffc10720',
            yAxisID: 'y3',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        },
        {
            label: 'Densidad (g/cc)',
            data: datos.map(d => d.density),
            borderColor: '#6f42c1',
            backgroundColor: '#6f42c120',
            yAxisID: 'y4',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        }
    ];
    
    // Encontrar √≠ndices de inicio y fin del batch para las l√≠neas verticales
    const indiceInicio = datos.findIndex(d => d.dentro_batch);
    const indiceFin = datos.length - 1 - datos.slice().reverse().findIndex(d => d.dentro_batch);
    
    batchChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const punto = datos[context.dataIndex];
                            const prefijo = punto.dentro_batch ? 'üîπ Batch: ' : '‚ö´ Contexto: ';
                            return prefijo + context.dataset.label + ': ' + context.formattedValue;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Tiempo'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Flujo M√°sico (kg/min)'
                    },
                    grid: {
                        color: '#007bff40'
                    }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Masa Total (lb)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#28a74540'
                    }
                },
                y3: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Temperatura (¬∞C)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#ffc10740'
                    },
                    display: false
                },
                y4: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Densidad (g/cc)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#6f42c140'
                    },
                    display: false
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y?.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n para configurar eventos de los checkboxes
function configurarEventosGraficoBatch() {
    const checkboxes = ['showMassRate', 'showTotalMass', 'showTemperature', 'showDensity'];
    const datasets = [0, 1, 2, 3]; // √çndices de los datasets
    const scales = ['y1', 'y2', 'y3', 'y4']; // Escalas correspondientes
    
    checkboxes.forEach((checkboxId, index) => {
        const checkbox = document.getElementById(checkboxId);
        checkbox.addEventListener('change', function() {
            if (batchChart) {
                const dataset = batchChart.data.datasets[datasets[index]];
                const scale = scales[index];
                
                dataset.hidden = !this.checked;
                batchChart.options.scales[scale].display = this.checked;
                batchChart.update();
            }
        });
    });
}

// Funci√≥n para descargar datos del batch (placeholder)
function descargarDatosBatch() {
    if (datosActualesBatch) {
        const csvContent = "data:text/csv;charset=utf-8," 
            + "Fecha/Hora,Flujo M√°sico (kg/min),Masa Total (lb),Temperatura (¬∞C),Densidad (g/cc)\n"
            + datosActualesBatch.datos_grafico.map(d => 
                `${d.fecha_hora},${d.mass_rate_kg_min},${d.total_mass},${d.coriolis_temperature},${d.density}`
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `batch_${datosActualesBatch.batch_info.id}_datos.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
</script>