<!-- Modal para mostrar el detalle de un batch espec√≠fico -->
<div class="modal fade" id="modalDetalleBatch" tabindex="-1" aria-labelledby="modalDetalleBatchLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalleBatchLabel">
                    <i class="bi bi-graph-up"></i> Detalle del Batch Detectado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Informaci√≥n b√°sica del batch -->
                <div class="row" id="contenedorBatch">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white fw-bold">
                                Informaci√≥n B√°sica
                            </div>
                            <div class="card-body" id="infoBatchBasica"></div>
                        </div>
                    </div>
                    
                    <div class="col-md-8 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white fw-bold">
                                Estad√≠sticas del Batch
                            </div>
                            <div class="card-body" id="estadisticasBatch"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Diagn√≥stico del medidor -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-info text-white fw-bold">
                        <i class="bi bi-activity"></i> Diagn√≥stico del Medidor Coriolis
                    </div>
                    <div class="card-body" id="diagnosticoBatch">
                        <div class="text-muted small">
                            <i class="bi bi-info-circle"></i> No hay diagn√≥stico disponible.
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico del batch -->
                 <div class="mb-3">
                    <h5><i class="bi bi-graph-up"></i> Gr√°fico del Batch</h5>
                    <hr style="margin-top: 0; border-top: 2px solid black;">
                    
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="batchChart"></canvas>
                    </div>
                </div>
                
                <!-- Controles del gr√°fico -->
                <div class="mb-3 text-center">
                    <div>
                         <h6><i class="bi bi-sliders fw-bold"></i> Eje Vertical: </h6>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showMassRate" checked>
                        <label class="form-check-label" for="showMassRate">
                            Flujo M√°sico (kg/min)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showTotalMass" checked>
                        <label class="form-check-label" for="showTotalMass">
                            Masa Total (kg)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showTemperature">
                        <label class="form-check-label" for="showTemperature">
                            Temperatura (¬∞F)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showPressure">
                        <label class="form-check-label" for="showPressure">
                            Presi√≥n (psi)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showDensity">
                        <label class="form-check-label" for="showDensity">
                            Densidad (g/cc)
                        </label>
                    </div>
                </div>

                <!-- Informaci√≥n sobre la visualizaci√≥n -->
                <div class="alert alert-info" role="alert" style="font-size: 0.8rem; padding: 5px;">
                  <div class="row">
                    <div class="col-md-12 d-flex">
                      <p class="col-3 mb-0 me-3">
                        <strong><i class="bi bi-info-circle me-1"></i> Contexto Extendido:</strong><br>
                        La gr√°fica muestra 3 minutos antes y despu√©s del batch para mejor an√°lisis.
                    </p>
                    <div class="col-9">
                        <p class="mb-1">
                            <i class="bi bi-circle-fill me-1" style="color: blue;"></i>
                            <strong>L√≠nea azul clara:</strong> Datos del batch detectado (l√≠nea gruesa, puntos grandes)
                        </p>
               
                        <p class="mb-1">
                            <i class="bi bi-circle-fill me-1" style="color: darkblue;"></i>
                            <strong>L√≠nea azul oscura:</strong> Datos de contexto ‚Äî antes/despu√©s (l√≠nea m√°s fina, puntos peque√±os)
                        </p>

                        <p class="mb-0">
                            <i class="bi bi-circle-fill me-1" style="color: red;"></i>
                            <strong>L√≠neas rojas punteadas:</strong> L√≠mites inferior y superior de flujo m√°sico configurados para la detecci√≥n de batches
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n: Incertidumbre -->
         <div class="mb-3">
            <h5><i class="bi bi-percent"></i> Incertidumbre</h5>
            <hr style="margin-top: 0; border-top: 2px solid black;">
            <div class="row g-3">
                <!-- Columna 1: Resultados -->
                 <div class="col-md-6">
                    <div class="row gy-3">
                        <div class="col-4">
                            <label for="NSV" class="form-label">Vol. Est√°ndar Neto</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="NSV" name="NSV" readonly placeholder="-">
                                <span class="input-group-text">bbl</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label for="masa" class="form-label">Masa Corregida</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="masa" name="masa" readonly placeholder="-">
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label for="k" class="form-label">Factor de Cobertura</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="k" name="k" readonly placeholder="-">
                            </div>
                        </div>
                        <div class="col-4">
                            <label for="U" class="form-label">U Estandar</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="U" name="U" readonly placeholder="-">
                                <span class="input-group-text">bbl</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label for="Uexp" class="form-label">U Expandida</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="Uexp" name="Uexp" readonly placeholder="-">
                                <span class="input-group-text">bbl</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label for="Urel" class="form-label">U Relativa</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="Urel" name="Urel" readonly placeholder="-">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div> 
                </div>

                <!-- Columna 2: Tabla de Resultados -->
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle text-center mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Item</th>
                                    <th style="width: 25%;">U std Comb</th>
                                    <th style="width: 25%;">Contrib bbl</th>
                                    <th style="width: 25%;">Contrib Rel</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Medidor</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" id="uMF" name="uMF" readonly placeholder="-">
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="cMF" name="cMF" readonly placeholder="-">
                                            <span class="input-group-text">bbl</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="crMF" name="crMF" readonly placeholder="-">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Densidad</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" id="udl" name="udl" readonly placeholder="-">
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="cdl" name="cdl" readonly placeholder="-">
                                            <span class="input-group-text">bbl</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" id="crdl" name="crdl" readonly placeholder="-">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cerrar
        </button>
        
        {% if can_assign_tickets %}
        <button type="button" id="btnAsignarTicket" class="btn btn-warning" onclick="asignarTicketBatch()">
            <i class="bi bi-tag"></i> Asignar Ticket
        </button>
        {% endif %}

        <button type="button" class="btn btn-primary" onclick="descargarDatosBatch()">
            <i class="bi bi-file-earmark-pdf"></i> Descargar PDF Ticket
        </button>
    </div>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar el evento cuando el modal se cierra para evitar advertencias de aria-hidden
    const modalDetalleBatch = document.getElementById('modalDetalleBatch');
    if (modalDetalleBatch) {
        modalDetalleBatch.addEventListener('hidden.bs.modal', function () {
            // Quitar el foco de cualquier elemento que pueda estar enfocado
            if (document.activeElement) {
                document.activeElement.blur();
            }
        });
        
        modalDetalleBatch.addEventListener('hide.bs.modal', function () {
            // Quitar el foco antes de que el modal se cierre
            if (document.activeElement) {
                document.activeElement.blur();
            }
        });
    }
});

// Registrar el plugin de anotaciones
if (typeof window.chartjs_plugin_annotation !== 'undefined') {
    Chart.register(window.chartjs_plugin_annotation.default || window.chartjs_plugin_annotation);
} else if (typeof ChartAnnotation !== 'undefined') {
    Chart.register(ChartAnnotation);
} else {
    //console.warn('Plugin de anotaciones de Chart.js no est√° disponible');
}

let batchChart = null;
let datosActualesBatch = null;

// Funci√≥n para mostrar el detalle del batch
function mostrarDetalleBatch(data) {
    // Guardar datos para uso posterior
    datosActualesBatch = data;
    
    // Mostrar informaci√≥n b√°sica
    document.getElementById('infoBatchBasica').innerHTML = `
      <p><strong>Sistema:</strong> ${data.batch_info.sistema_tag}</p>
      ${data.batch_info.num_ticket ? `<p><strong># Ticket:</strong> <span class="badge bg-success">${data.batch_info.num_ticket}</span></p>` : ''}
      <p><strong>Inicio:</strong> ${data.batch_info.fecha_inicio}</p>
      <p><strong>Fin:</strong> ${data.batch_info.fecha_fin}</p>
      <p><strong>Duraci√≥n:</strong> ${
        data.batch_info.duracion_minutos != null
          ? (Math.trunc(data.batch_info.duracion_minutos * 100) / 100)
          : 'N/A'
      } minutos</p>
    `;

    // Mostrar estad√≠sticas
    document.getElementById('estadisticasBatch').innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <p><strong>Masa Total:</strong> ${
            data.batch_info.mass_total_kg != null
              ? (Math.trunc(data.batch_info.mass_total_kg * 100) / 100)
              : 'N/A'
          } kg</p>

          <p><strong>Volumen Bruto:</strong> ${
            data.batch_info.vol_total != null
              ? (Math.trunc(data.batch_info.vol_total * 100) / 100)
              : 'N/A'
          } gal</p>

          <p><strong>Temp. Promedio:</strong> ${
            data.batch_info.temperatura_coriolis_prom_f != null
              ? (Math.trunc(data.batch_info.temperatura_coriolis_prom_f * 100) / 100)
              : 'N/A'
          } ¬∞F</p>
        </div>

        <div class="col-md-6">
          <p><strong>Presi√≥n Promedio:</strong> ${
            data.batch_info.presion_out_prom != null
              ? (Math.trunc(data.batch_info.presion_out_prom * 100) / 100)
              : 'N/A'
          } psi</p>

          <p><strong>Densidad Promedio:</strong> ${
            data.batch_info.densidad_prom != null
              ? (Math.trunc(data.batch_info.densidad_prom * 1000000) / 1000000)
              : 'N/A'
          } g/cc</p>

          <p><strong>Total Registros:</strong> ${data.batch_info.total_registros}</p>
        </div>
      </div>
    `;

    // Mostrar diagn√≥stico
    renderDiagnosticoBatch(data.diagnostico);
    
    // Controlar estado del bot√≥n de asignar ticket
    actualizarEstadoBotonTicket(data.batch_info.num_ticket);
    
    // Crear el gr√°fico
    const limites = {
        lim_inf: data.lim_inf_caudal_masico,
        lim_sup: data.lim_sup_caudal_masico
    };
    crearGraficoBatch(data.datos_grafico, limites);
    
    // Configurar eventos de los checkboxes
    configurarEventosGraficoBatch();

    // Actualizar secci√≥n de Incertidumbre (si hay datos)
    actualizarSeccionIncertidumbre(data.incertidumbre);
    
    // Cerrar otros modales antes de mostrar el detalle
    const modalTickets = document.getElementById('modalListarTickets');
    const modalBatches = document.getElementById('modalBuscarBatches');
    
    if (modalTickets) {
        const bsModalTickets = bootstrap.Modal.getInstance(modalTickets);
        if (bsModalTickets) {
            bsModalTickets.hide();
        }
    }
    
    if (modalBatches) {
        const bsModalBatches = bootstrap.Modal.getInstance(modalBatches);
        if (bsModalBatches) {
            bsModalBatches.hide();
        }
    }
    
    // Mostrar el modal de detalle despu√©s de un peque√±o delay para que se cierren los otros modales
    setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalleBatch'));
        modal.show();
    }, 300);
}

// Renderiza el bloque de diagn√≥stico del medidor
function renderDiagnosticoBatch(diagnostico) {
    const contenedor = document.getElementById('diagnosticoBatch');
    if (!contenedor) return;

    if (!diagnostico) {
        contenedor.innerHTML = `
            <div class="alert alert-secondary mb-0">
                <i class="bi bi-info-circle"></i> Diagn√≥stico no disponible para este batch.
            </div>
        `;
        return;
    }

    const estados = {
        'OK': { clase: 'success', icono: 'bi-check-circle', texto: 'Diagn√≥stico dentro de par√°metros' },
        'ALERTA': { clase: 'danger', icono: 'bi-exclamation-triangle', texto: 'Diagn√≥stico con alertas' },
        'SIN_DATOS': { clase: 'secondary', icono: 'bi-info-circle', texto: 'Sin datos de diagn√≥stico' }
    };

    const estado = estados[diagnostico.estado_general] || estados['SIN_DATOS'];
    const mensajes = Array.isArray(diagnostico.mensajes) ? diagnostico.mensajes : [];
    const mensajesHTML = mensajes.length
        ? `<ul class="mb-0 ps-3">${mensajes.map(msg => `<li>${msg}</li>`).join('')}</ul>`
        : '<p class="mb-0">Sin mensajes adicionales.</p>';

    const alarmas = Array.isArray(diagnostico.alarmas_detectadas) ? diagnostico.alarmas_detectadas : [];
    const alarmasHTML = alarmas.length
        ? `<p class="mb-0"><strong>Alarmas detectadas:</strong> ${alarmas.join(', ')}</p>`
        : '';

    const multifaseHTML = renderDiagnosticoMultifase(diagnostico.multifase);
    const saludHTML = renderDiagnosticoSalud(diagnostico.salud_medidor);
    const parametrosHTML = renderDiagnosticoParametros(diagnostico.parametros);

    contenedor.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <i class="bi ${estado.icono} text-${estado.clase} fs-4 me-2"></i>
            <h6 class="mb-0">${estado.texto}</h6>
        </div>
        <div class="alert alert-${estado.clase} mb-3">
            ${mensajesHTML}
        </div>
        ${alarmasHTML}
        ${multifaseHTML}
        ${saludHTML}
        ${parametrosHTML}
    `;
}

function renderDiagnosticoMultifase(multifase) {
    if (!multifase) {
        return `
            <div class="alert alert-secondary">
                <i class="bi bi-info-circle"></i> Sin datos para diagn√≥stico de fluido/multifase.
            </div>
        `;
    }

    const detalles = Array.isArray(multifase.detalles) ? multifase.detalles : [];
    const cards = detalles.length ? detalles.map(renderDiagnosticoDetalleCard).join('') : '<div class="text-muted"><em>Sin indicadores configurados.</em></div>';

    return `
        <div class="mt-3">
            <h6 class="fw-bold mb-2"><i class="bi bi-droplet-half me-1"></i> Fluido / Mult√≠fases</h6>
            <div class="text-muted small mb-2">
                <strong>Densidad GLP ref:</strong> ${formatearDiagnosticoValor(multifase.densidad_glp_referencia)} g/cc ¬∑
                <strong>Variaci√≥n:</strong> ${formatearDiagnosticoValor(multifase.variacion_glp_pct)} %
            </div>
            <div class="row g-3">
                ${cards}
            </div>
        </div>
    `;
}

function renderDiagnosticoDetalleCard(detalle) {
    const estado = detalle.estado || 'SIN_DATOS';
    const color = estado === 'ALERTA' ? 'danger' : (estado === 'OK' ? 'success' : 'secondary');
    const valor = detalle.valor !== undefined && detalle.valor !== null
        ? `<div class="text-muted small mb-0">Valor: ${formatearDiagnosticoValor(detalle.valor)} ${detalle.unidad || ''}</div>`
        : '';

    return `
        <div class="col-md-6 col-xl-3">
            <div class="border rounded h-100 p-3">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-${color} me-2">${estado}</span>
                    <h6 class="mb-0">${detalle.titulo || detalle.id}</h6>
                </div>
                <p class="mb-2">${detalle.mensaje || 'Sin descripci√≥n.'}</p>
                ${valor}
            </div>
        </div>
    `;
}

function renderDiagnosticoSalud(salud) {
    if (!salud) {
        return `
            <div class="alert alert-secondary mt-3">
                <i class="bi bi-info-circle"></i> Sin datos para diagn√≥stico de la salud del medidor.
            </div>
        `;
    }

    const indicadores = Array.isArray(salud.indicadores) ? salud.indicadores : [];
    const filas = indicadores.length
        ? indicadores.map(ind => {
            const estado = ind.estado || 'SIN_DATOS';
            const color = estado === 'ALERTA' ? 'danger' : (estado === 'OK' ? 'success' : 'secondary');
            const umbral = ind.umbral !== undefined && ind.umbral !== null ? formatearDiagnosticoValor(ind.umbral) : 'N/A';
            return `
                <tr>
                    <td>${ind.label || ind.id}</td>
                    <td>${formatearDiagnosticoValor(ind.valor)} ${ind.unidad || ''}</td>
                    <td>${umbral} ${ind.unidad || ''}</td>
                    <td><span class="badge bg-${color}">${estado}</span></td>
                    <td>${ind.descripcion || ''}</td>
                </tr>
            `;
        }).join('')
        : '';

    const tablaIndicadores = filas
        ? `
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-2">
                    <thead>
                        <tr>
                            <th>Indicador</th>
                            <th>Valor</th>
                            <th>Umbral</th>
                            <th>Estado</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody>${filas}</tbody>
                </table>
            </div>
        `
        : '<p class="mb-2"><em>No hay indicadores definidos.</em></p>';

    const mensajes = Array.isArray(salud.mensajes) ? salud.mensajes : [];
    const mensajesHTML = mensajes.length
        ? `<ul class="mb-0 ps-3">${mensajes.map(msg => `<li>${msg}</li>`).join('')}</ul>`
        : '<p class="mb-0 text-muted">Sin observaciones adicionales.</p>';

    return `
        <div class="mt-4">
            <h6 class="fw-bold mb-2"><i class="bi bi-activity me-1"></i> Salud del medidor</h6>
            ${tablaIndicadores}
            <div class="alert alert-light border mb-0">${mensajesHTML}</div>
        </div>
    `;
}

function renderDiagnosticoParametros(parametros) {
    const lista = Array.isArray(parametros) ? parametros : [];
    if (!lista.length) {
        return '<p class="mb-0 mt-3"><em>No hay par√°metros de diagn√≥stico para mostrar.</em></p>';
    }

    const filas = lista.map(param => {
        const metricas = param.metricas || {};
        const unidad = param.unidad ? ` <small class="text-muted">(${param.unidad})</small>` : '';
        const estadoParametro = param.en_alarma
            ? '<span class="badge bg-danger">Alarma</span>'
            : '<span class="badge bg-success">OK</span>';
        return `
            <tr>
                <td>${param.label}${unidad}</td>
                <td>${formatearDiagnosticoValor(metricas.ultimo)}</td>
                <td>${formatearDiagnosticoValor(metricas.promedio)}</td>
                <td>${formatearDiagnosticoValor(metricas.min)}</td>
                <td>${formatearDiagnosticoValor(metricas.max)}</td>
                <td>${estadoParametro}</td>
            </tr>
        `;
    }).join('');

    return `
        <div class="table-responsive mt-4">
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>Par√°metro</th>
                        <th>√öltimo</th>
                        <th>Promedio</th>
                        <th>M√≠nimo</th>
                        <th>M√°ximo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>${filas}</tbody>
            </table>
        </div>
    `;
}

function formatearDiagnosticoValor(valor) {
    if (valor === null || valor === undefined || Number.isNaN(valor)) {
        return 'N/A';
    }
    const absValor = Math.abs(valor);
    let decimales = 3;
    if (absValor >= 1000) {
        decimales = 0;
    } else if (absValor >= 100) {
        decimales = 1;
    } else if (absValor >= 10) {
        decimales = 2;
    }
    return Number.parseFloat(valor).toFixed(decimales);
}

// Funci√≥n para crear el gr√°fico del batch
function crearGraficoBatch(datos, limites) {
    const ctx = document.getElementById('batchChart').getContext('2d');
    
    // Destruir gr√°fico anterior si existe
    if (batchChart) {
        batchChart.destroy();
    }
    
    // Preparar datos para Chart.js
    const labels = datos.map(d => d.fecha_hora);
    
    // Separar datos del batch y del contexto para diferentes estilos
    const datosBatch = datos.filter(d => d.dentro_batch);
    const datosContexto = datos.filter(d => !d.dentro_batch);
    
    const datasets = [
        // Flujo m√°sico completo (contexto + batch) como una sola curva continua
        {
            label: 'Flujo M√°sico - Batch (kg/min)',
            data: datos.map(d => d.mass_rate_kg_min),
            borderColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'), // Azul normal para batch, azul oscuro para contexto
            backgroundColor: '#007bff20',
            yAxisID: 'y1',
            tension: 0.4,
            pointRadius: datos.map(d => d.dentro_batch ? 3 : 1), // Puntos m√°s grandes para el batch
            pointBorderColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'),
            pointBackgroundColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'),
            borderWidth: 2,
            segment: {
                borderColor: function(ctx) {
                    // Cambiar color del segmento seg√∫n si est√° en el batch o contexto
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? '#007bff' : '#004085';
                },
                borderWidth: function(ctx) {
                    // L√≠nea m√°s gruesa para el batch
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? 3 : 2;
                }
            },
            hidden: false
        },
        // Masa total completa (contexto + batch) como una sola curva continua
        {
            label: 'Masa Total - Batch (kg)',
            data: datos.map(d => d.total_mass_kg),
            borderColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'), // Verde normal para batch, verde oscuro para contexto
            backgroundColor: '#28a74520',
            yAxisID: 'y2',
            tension: 0.4,
            pointRadius: datos.map(d => d.dentro_batch ? 3 : 1),
            pointBorderColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'),
            pointBackgroundColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'),
            borderWidth: 2,
            segment: {
                borderColor: function(ctx) {
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? '#28a745' : '#155724';
                },
                borderWidth: function(ctx) {
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? 3 : 2;
                }
            },
            hidden: false
        },
        {
            label: 'Temperatura (¬∞F)',
            data: datos.map(d => d.coriolis_temperature_f),
            borderColor: '#ffc107',
            backgroundColor: '#ffc10720',
            yAxisID: 'y3',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        },
        {
            label: 'Presi√≥n (psi)',
            data: datos.map(d => d.pressure_out),
            borderColor: '#fd7e14',
            backgroundColor: '#fd7e1420',
            yAxisID: 'y4',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        },
        {
            label: 'Densidad (g/cc)',
            data: datos.map(d => d.density),
            borderColor: '#6f42c1',
            backgroundColor: '#6f42c120',
            yAxisID: 'y5',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        }
    ];
    
    // Agregar l√≠neas horizontales para los l√≠mites usando datasets
    if (limites && limites.lim_inf !== undefined) {
        datasets.push({
            label: `L√≠mite Inferior (${limites.lim_inf} kg/min)`,
            data: datos.map(() => limites.lim_inf),
            borderColor: 'red',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            borderWidth: 2,
            yAxisID: 'y1',
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0,
            hidden: false,
            type: 'line'
        });
    }
    
    if (limites && limites.lim_sup !== undefined) {
        datasets.push({
            label: `L√≠mite Superior (${limites.lim_sup} kg/min)`,
            data: datos.map(() => limites.lim_sup),
            borderColor: 'red',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            borderWidth: 2,
            yAxisID: 'y1',
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0,
            hidden: false,
            type: 'line'
        });
    }
    
    // Encontrar √≠ndices de inicio y fin del batch para las l√≠neas verticales
    const indiceInicio = datos.findIndex(d => d.dentro_batch);
    const indiceFin = datos.length - 1 - datos.slice().reverse().findIndex(d => d.dentro_batch);
    
    batchChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const punto = datos[context.dataIndex];
                            const prefijo = punto.dentro_batch ? 'üîπ Batch: ' : '‚ö´ Contexto: ';
                            return prefijo + context.dataset.label + ': ' + context.formattedValue;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Tiempo'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Flujo M√°sico (kg/min)'
                    },
                    grid: {
                        color: '#007bff40'
                    }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Masa Total (kg)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#28a74540'
                    }
                },
                y3: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Temperatura (¬∞F)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#ffc10740'
                    },
                    display: false
                },
                y4: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Presi√≥n (psi)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#fd7e1440'
                    },
                    display: false
                },
                y5: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Densidad (g/cc)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#6f42c140'
                    },
                    display: false
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y?.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n para configurar eventos de los checkboxes
function configurarEventosGraficoBatch() {
    const checkboxes = ['showMassRate', 'showTotalMass', 'showTemperature', 'showPressure', 'showDensity'];
    const datasets = [0, 1, 2, 3, 4]; // √çndices de los datasets
    const scales = ['y1', 'y2', 'y3', 'y4', 'y5']; // Escalas correspondientes
    
    checkboxes.forEach((checkboxId, index) => {
        const checkbox = document.getElementById(checkboxId);
        checkbox.addEventListener('change', function() {
            if (batchChart) {
                const dataset = batchChart.data.datasets[datasets[index]];
                const scale = scales[index];
                
                dataset.hidden = !this.checked;
                batchChart.options.scales[scale].display = this.checked;
                batchChart.update();
            }
        });
    });
}

// Actualiza los campos de la secci√≥n Incertidumbre de forma segura
function actualizarSeccionIncertidumbre(inc) {
    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = (val === null || val === undefined) ? '' : val;
    };

    // Limpiar si no hay datos
    if (!inc) {
        ['NSV','masa','U','Uexp','k','Urel','uMF','cMF','crMF','udl','cdl','crdl'].forEach(id=>setVal(id, ''));
        return;
    }

    // Resumen (columna izquierda) - nombres exactos
    setVal('NSV', inc.NSV);
    setVal('masa', inc.masa);
    setVal('U', inc.U);
    setVal('Uexp', inc.Uexp);
    setVal('k', inc.k);
    setVal('Urel', inc.Urel);

    // Tabla (columna derecha) - nombres exactos
    setVal('uMF', inc.uMF);
    setVal('udl', inc.udl);
    setVal('cMF', inc.cMF);
    setVal('cdl', inc.cdl);
    setVal('crMF', inc.crMF);
    setVal('crdl', inc.crdl);
}

// Funci√≥n para descargar PDF del ticket del batch
function descargarDatosBatch() {
    if (datosActualesBatch && datosActualesBatch.batch_info) {
        const batchId = datosActualesBatch.batch_info.id;
        // Abrir PDF en nueva ventana para descarga
        window.open(`/monitoreo/pdf/ticket-batch/${batchId}/`, '_blank');
    } else {
        alert('No hay datos del batch disponibles para descargar.');
    }
}

// Funci√≥n para controlar el estado del bot√≥n de asignar ticket
function actualizarEstadoBotonTicket(numTicket) {
    const btn = document.getElementById('btnAsignarTicket');
    
    // Verificar si el bot√≥n existe (puede no existir si el usuario no tiene permisos)
    if (!btn) {
        return;
    }
    
    if (numTicket) {
        // Ya tiene ticket - deshabilitar bot√≥n
        btn.disabled = true;
        btn.className = 'btn btn-secondary';
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Ticket ya asignado';
    } else {
        // No tiene ticket - habilitar bot√≥n
        btn.disabled = false;
        btn.className = 'btn btn-warning';
        btn.innerHTML = '<i class="bi bi-ticket-perforated"></i> Asignar Ticket';
    }
}

// Funci√≥n para asignar ticket al batch
async function asignarTicketBatch() {
    if (!datosActualesBatch || !datosActualesBatch.batch_info) {
        showErrorAlert('Error', 'No hay datos del batch disponibles');
        return;
    }
    
    const batchId = datosActualesBatch.batch_info.id;
    const batchNumTicket = datosActualesBatch.batch_info.num_ticket;
    
    // Verificar si ya tiene ticket asignado - NO permitir reasignaci√≥n
    if (batchNumTicket) {
        showWarningAlert(
            'Ticket ya asignado', 
            `Este batch ya tiene el ticket #${batchNumTicket} asignado. No se puede reasignar.`
        );
        return;
    }
    
    // Mostrar confirmaci√≥n antes de asignar
    const confirmResult = await showConfirmAlert(
        'Confirmar asignaci√≥n de ticket',
        '¬øEst√° seguro que desea asignar un ticket a este batch?',
        {
            confirmButtonText: 'S√≠, asignar',
            cancelButtonText: 'Cancelar'
        }
    );
    
    if (!confirmResult.isConfirmed) {
        return;
    }
    
    try {
        // Verificar que el bot√≥n existe (permisos)
        const btn = document.getElementById('btnAsignarTicket');
        if (!btn) {
            showPermissionDeniedAlert('No tiene permisos para asignar tickets');
            return;
        }
        
        // Mostrar loading
        showLoadingAlert('Asignando ticket...', 'Por favor espere mientras se procesa la asignaci√≥n');
        
        const response = await fetch(`/monitoreo/api/asignar-ticket-batch/${batchId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            }
        });
        
        // Cerrar loading
        hideLoadingAlert();
        
        // Verificar si hay error de permisos
        if (response.status === 403) {
            const data = await response.json();
            const errorMsg = data.error || 'No tiene permisos para esta acci√≥n. Contacte al administrador.';
            showPermissionDeniedAlert(errorMsg);
            return;
        }
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Mostrar √©xito con SweetAlert2
            await showSuccessAlert(
                'Ticket asignado exitosamente',
                `¬°Ticket #${data.data.ticket_asignado} asignado correctamente al batch!`
            );
            
            // Actualizar la informaci√≥n del batch en el modal
            datosActualesBatch.batch_info.num_ticket = data.data.ticket_asignado;
            
            // Actualizar la visualizaci√≥n
            document.getElementById('infoBatchBasica').innerHTML = `
                <p><strong>Sistema:</strong> ${datosActualesBatch.batch_info.sistema_tag}</p>
                <p><strong># Ticket:</strong> <span class="badge bg-success">${data.data.ticket_asignado}</span></p>
                <p><strong>Inicio:</strong> ${datosActualesBatch.batch_info.fecha_inicio}</p>
                <p><strong>Fin:</strong> ${datosActualesBatch.batch_info.fecha_fin}</p>
                <p><strong>Duraci√≥n:</strong> ${(datosActualesBatch.batch_info.duracion_minutos !== null && datosActualesBatch.batch_info.duracion_minutos !== undefined) ? Math.trunc(datosActualesBatch.batch_info.duracion_minutos * 100) / 100 : 'N/A'} minutos</p>
                <div class="alert alert-info mt-2 mb-0" style="padding: 8px 12px; font-size: 0.85em;">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Contexto extendido:</strong> La gr√°fica muestra 3 minutos antes y despu√©s del batch para mejor an√°lisis.
                    <br>üîπ <strong>L√≠nea azul clara:</strong> Datos del batch detectado (l√≠nea gruesa, puntos grandes)
                    <br>üî∑ <strong>L√≠nea azul oscura:</strong> Datos de contexto - antes/despu√©s (l√≠nea m√°s fina, puntos peque√±os)
                </div>
            `;
            
            // Actualizar el estado del bot√≥n (ya no se podr√° usar)
            actualizarEstadoBotonTicket(data.data.ticket_asignado);
            
        } else {
            // Mostrar error con SweetAlert2
            showErrorAlert(
                'Error al asignar ticket',
                data.error || 'Ha ocurrido un error inesperado'
            );
        }
    } catch (error) {
        // Cerrar loading si est√° abierto
        hideLoadingAlert();
        
        console.error('Error al asignar ticket:', error);
        showErrorAlert(
            'Error de conexi√≥n',
            'No se pudo conectar con el servidor. Verifique su conexi√≥n a internet.'
        );
    }
}

// Funci√≥n para obtener CSRF token (versi√≥n robusta)
function getCSRFToken() {
    // Primero intentar obtener del input hidden
    let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    // Si no se encuentra, intentar obtener de las cookies
    if (!token) {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        token = cookieValue;
    }
    
    // Validar que el token tenga el formato correcto (deber√≠a tener 64 caracteres)
    if (token && token.length !== 64) {
        //console.warn('‚ö†Ô∏è Token CSRF con longitud incorrecta:', token.length, 'caracteres. Esperados: 64');
    }
    
    //console.log('üîê Token CSRF obtenido:', token ? `‚úÖ V√°lido (${token.length} chars)` : '‚ùå No encontrado');
    return token || '';
}
</script>
