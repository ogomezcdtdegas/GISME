<!-- Modal para mostrar el detalle de un batch espec√≠fico -->
<div class="modal fade" id="modalDetalleBatch" tabindex="-1" aria-labelledby="modalDetalleBatchLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalleBatchLabel">
                    <i class="bi bi-graph-up"></i> Detalle del Batch Detectado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Informaci√≥n b√°sica del batch -->
                <div id="infoBatch" class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-info-circle"></i> Informaci√≥n del Batch</h6>
                            <div id="infoBatchBasica"></div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-bar-chart"></i> Estad√≠sticas</h6>
                            <div id="estadisticasBatch"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico del batch -->
                <div class="mb-3">
                    <h6><i class="bi bi-graph-up"></i> Gr√°fico del Batch</h6>
                    
                    <!-- Informaci√≥n sobre la visualizaci√≥n -->
                    <div class="alert alert-info" role="alert">
                        <div class="row">
                            <div class="col-md-8">
                                <strong><i class="bi bi-info-circle"></i> Contexto extendido:</strong> La gr√°fica muestra 3 minutos antes y despu√©s del batch para mejor an√°lisis.
                                <br>
                                üîπ <strong>L√≠nea azul clara:</strong> Datos del batch detectado (l√≠nea gruesa, puntos grandes)
                                <br>
                                ‚ö´ <strong>L√≠nea azul oscura:</strong> Datos de contexto - antes/despu√©s (l√≠nea m√°s fina, puntos peque√±os)
                            </div>
                            <div class="col-md-4">
                                üî¥ <strong>L√≠neas rojas punteadas:</strong> L√≠mites inferior y superior de flujo m√°sico configurados para la detecci√≥n de batches
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="batchChart"></canvas>
                    </div>
                </div>
                
                <!-- Controles del gr√°fico -->
                <div class="mb-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showMassRate" checked>
                        <label class="form-check-label" for="showMassRate">
                            Flujo M√°sico (kg/min)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showTotalMass" checked>
                        <label class="form-check-label" for="showTotalMass">
                            Masa Total (kg)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showTemperature">
                        <label class="form-check-label" for="showTemperature">
                            Temperatura (¬∞F)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showPressure">
                        <label class="form-check-label" for="showPressure">
                            Presi√≥n (psi)
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="showDensity">
                        <label class="form-check-label" for="showDensity">
                            Densidad (g/cc)
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>

                {% if can_assign_tickets %}
                <button type="button" id="btnAsignarTicket" class="btn btn-warning" onclick="asignarTicketBatch()">
                    <i class="bi bi-tag"></i> Asignar Ticket
                </button>
                {% endif %}

                <button type="button" class="btn btn-primary" onclick="descargarDatosBatch()">
                    <i class="bi bi-file-earmark-pdf"></i> Descargar PDF Ticket
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Registrar el plugin de anotaciones
if (typeof window.chartjs_plugin_annotation !== 'undefined') {
    Chart.register(window.chartjs_plugin_annotation.default || window.chartjs_plugin_annotation);
} else if (typeof ChartAnnotation !== 'undefined') {
    Chart.register(ChartAnnotation);
} else {
    console.warn('Plugin de anotaciones de Chart.js no est√° disponible');
}

let batchChart = null;
let datosActualesBatch = null;

// Funci√≥n para mostrar el detalle del batch
function mostrarDetalleBatch(data) {
    // Guardar datos para uso posterior
    datosActualesBatch = data;
    
    // Mostrar informaci√≥n b√°sica
    document.getElementById('infoBatchBasica').innerHTML = `
        <p><strong>Sistema:</strong> ${data.batch_info.sistema_tag}</p>
        ${data.batch_info.num_ticket ? `<p><strong># Ticket:</strong> <span class="badge bg-success">${data.batch_info.num_ticket}</span></p>` : ''}
        <p><strong>Inicio:</strong> ${data.batch_info.fecha_inicio}</p>
        <p><strong>Fin:</strong> ${data.batch_info.fecha_fin}</p>
        <p><strong>Duraci√≥n:</strong> ${(data.batch_info.duracion_minutos !== null && data.batch_info.duracion_minutos !== undefined)? Math.trunc(data.batch_info.duracion_minutos * 100) / 100: 'N/A'} minutos</p>
        <div class="alert alert-info mt-2 mb-0" style="padding: 8px 12px; font-size: 0.85em;">
            <i class="bi bi-info-circle"></i> 
            <strong>Contexto extendido:</strong> La gr√°fica muestra 3 minutos antes y despu√©s del batch para mejor an√°lisis.
            <br>üîπ <strong>L√≠nea azul clara:</strong> Datos del batch detectado (l√≠nea gruesa, puntos grandes)
            <br>üî∑ <strong>L√≠nea azul oscura:</strong> Datos de contexto - antes/despu√©s (l√≠nea m√°s fina, puntos peque√±os)
        </div>
    `;
    
    // Mostrar estad√≠sticas
    document.getElementById('estadisticasBatch').innerHTML = `
        <p><strong>Masa Total:</strong> ${(data.batch_info.mass_total_kg !== null && data.batch_info.mass_total_kg !== undefined)? Math.trunc(data.batch_info.mass_total_kg * 100) / 100: 'N/A'} kg</p>
        <p><strong>Volumen Bruto:</strong> ${(data.batch_info.vol_total !== null && data.batch_info.vol_total !== undefined)? Math.trunc(data.batch_info.vol_total * 100) / 100: 'N/A'} m¬≥</p>
        <p><strong>Temp. Promedio:</strong> ${(data.batch_info.temperatura_coriolis_prom_f !== null && data.batch_info.temperatura_coriolis_prom_f !== undefined)? Math.trunc(data.batch_info.temperatura_coriolis_prom_f * 100) / 100: 'N/A'} ¬∞F</p>
        <p><strong>Presi√≥n Promedio:</strong> ${(data.batch_info.presion_out_prom !== null && data.batch_info.presion_out_prom !== undefined)? Math.trunc(data.batch_info.presion_out_prom * 100) / 100: 'N/A'} psi</p>
        <p><strong>Densidad Promedio:</strong> ${(data.batch_info.densidad_prom !== null && data.batch_info.densidad_prom !== undefined)? Math.trunc(data.batch_info.densidad_prom * 1000000) / 1000000: 'N/A'} g/cc</p>
        <p><strong>Total Registros:</strong> ${data.batch_info.total_registros}</p>
    `;
    
    // Controlar estado del bot√≥n de asignar ticket
    actualizarEstadoBotonTicket(data.batch_info.num_ticket);
    
    // Crear el gr√°fico
    const limites = {
        lim_inf: data.lim_inf_caudal_masico,
        lim_sup: data.lim_sup_caudal_masico
    };
    crearGraficoBatch(data.datos_grafico, limites);
    
    // Configurar eventos de los checkboxes
    configurarEventosGraficoBatch();
    
    // Cerrar otros modales antes de mostrar el detalle
    const modalTickets = document.getElementById('modalListarTickets');
    const modalBatches = document.getElementById('modalBuscarBatches');
    
    if (modalTickets) {
        const bsModalTickets = bootstrap.Modal.getInstance(modalTickets);
        if (bsModalTickets) {
            bsModalTickets.hide();
        }
    }
    
    if (modalBatches) {
        const bsModalBatches = bootstrap.Modal.getInstance(modalBatches);
        if (bsModalBatches) {
            bsModalBatches.hide();
        }
    }
    
    // Mostrar el modal de detalle despu√©s de un peque√±o delay para que se cierren los otros modales
    setTimeout(() => {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalleBatch'));
        modal.show();
    }, 300);
}

// Funci√≥n para crear el gr√°fico del batch
function crearGraficoBatch(datos, limites) {
    const ctx = document.getElementById('batchChart').getContext('2d');
    
    // Destruir gr√°fico anterior si existe
    if (batchChart) {
        batchChart.destroy();
    }
    
    // Preparar datos para Chart.js
    const labels = datos.map(d => d.fecha_hora);
    
    // Separar datos del batch y del contexto para diferentes estilos
    const datosBatch = datos.filter(d => d.dentro_batch);
    const datosContexto = datos.filter(d => !d.dentro_batch);
    
    const datasets = [
        // Flujo m√°sico completo (contexto + batch) como una sola curva continua
        {
            label: 'Flujo M√°sico - Batch (kg/min)',
            data: datos.map(d => d.mass_rate_kg_min),
            borderColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'), // Azul normal para batch, azul oscuro para contexto
            backgroundColor: '#007bff20',
            yAxisID: 'y1',
            tension: 0.4,
            pointRadius: datos.map(d => d.dentro_batch ? 3 : 1), // Puntos m√°s grandes para el batch
            pointBorderColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'),
            pointBackgroundColor: datos.map(d => d.dentro_batch ? '#007bff' : '#004085'),
            borderWidth: 2,
            segment: {
                borderColor: function(ctx) {
                    // Cambiar color del segmento seg√∫n si est√° en el batch o contexto
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? '#007bff' : '#004085';
                },
                borderWidth: function(ctx) {
                    // L√≠nea m√°s gruesa para el batch
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? 3 : 2;
                }
            },
            hidden: false
        },
        // Masa total completa (contexto + batch) como una sola curva continua
        {
            label: 'Masa Total - Batch (kg)',
            data: datos.map(d => d.total_mass_kg),
            borderColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'), // Verde normal para batch, verde oscuro para contexto
            backgroundColor: '#28a74520',
            yAxisID: 'y2',
            tension: 0.4,
            pointRadius: datos.map(d => d.dentro_batch ? 3 : 1),
            pointBorderColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'),
            pointBackgroundColor: datos.map(d => d.dentro_batch ? '#28a745' : '#155724'),
            borderWidth: 2,
            segment: {
                borderColor: function(ctx) {
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? '#28a745' : '#155724';
                },
                borderWidth: function(ctx) {
                    const currentIndex = ctx.p0DataIndex;
                    const isInBatch = datos[currentIndex]?.dentro_batch;
                    return isInBatch ? 3 : 2;
                }
            },
            hidden: false
        },
        {
            label: 'Temperatura (¬∞F)',
            data: datos.map(d => d.coriolis_temperature_f),
            borderColor: '#ffc107',
            backgroundColor: '#ffc10720',
            yAxisID: 'y3',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        },
        {
            label: 'Presi√≥n (psi)',
            data: datos.map(d => d.pressure_out),
            borderColor: '#fd7e14',
            backgroundColor: '#fd7e1420',
            yAxisID: 'y4',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        },
        {
            label: 'Densidad (g/cc)',
            data: datos.map(d => d.density),
            borderColor: '#6f42c1',
            backgroundColor: '#6f42c120',
            yAxisID: 'y5',
            tension: 0.4,
            pointRadius: 2,
            hidden: true
        }
    ];
    
    // Agregar l√≠neas horizontales para los l√≠mites usando datasets
    if (limites && limites.lim_inf !== undefined) {
        datasets.push({
            label: `L√≠mite Inferior (${limites.lim_inf} kg/min)`,
            data: datos.map(() => limites.lim_inf),
            borderColor: 'red',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            borderWidth: 2,
            yAxisID: 'y1',
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0,
            hidden: false,
            type: 'line'
        });
    }
    
    if (limites && limites.lim_sup !== undefined) {
        datasets.push({
            label: `L√≠mite Superior (${limites.lim_sup} kg/min)`,
            data: datos.map(() => limites.lim_sup),
            borderColor: 'red',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            borderWidth: 2,
            yAxisID: 'y1',
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0,
            hidden: false,
            type: 'line'
        });
    }
    
    // Encontrar √≠ndices de inicio y fin del batch para las l√≠neas verticales
    const indiceInicio = datos.findIndex(d => d.dentro_batch);
    const indiceFin = datos.length - 1 - datos.slice().reverse().findIndex(d => d.dentro_batch);
    
    batchChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const punto = datos[context.dataIndex];
                            const prefijo = punto.dentro_batch ? 'üîπ Batch: ' : '‚ö´ Contexto: ';
                            return prefijo + context.dataset.label + ': ' + context.formattedValue;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Tiempo'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Flujo M√°sico (kg/min)'
                    },
                    grid: {
                        color: '#007bff40'
                    }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Masa Total (kg)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#28a74540'
                    }
                },
                y3: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Temperatura (¬∞F)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#ffc10740'
                    },
                    display: false
                },
                y4: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Presi√≥n (psi)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#fd7e1440'
                    },
                    display: false
                },
                y5: {
                    type: 'linear',
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Densidad (g/cc)'
                    },
                    grid: {
                        drawOnChartArea: false,
                        color: '#6f42c140'
                    },
                    display: false
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y?.toFixed(2)}`;
                        }
                    }
                }
            }
        }
    });
}

// Funci√≥n para configurar eventos de los checkboxes
function configurarEventosGraficoBatch() {
    const checkboxes = ['showMassRate', 'showTotalMass', 'showTemperature', 'showPressure', 'showDensity'];
    const datasets = [0, 1, 2, 3, 4]; // √çndices de los datasets
    const scales = ['y1', 'y2', 'y3', 'y4', 'y5']; // Escalas correspondientes
    
    checkboxes.forEach((checkboxId, index) => {
        const checkbox = document.getElementById(checkboxId);
        checkbox.addEventListener('change', function() {
            if (batchChart) {
                const dataset = batchChart.data.datasets[datasets[index]];
                const scale = scales[index];
                
                dataset.hidden = !this.checked;
                batchChart.options.scales[scale].display = this.checked;
                batchChart.update();
            }
        });
    });
}

// Funci√≥n para descargar PDF del ticket del batch
function descargarDatosBatch() {
    if (datosActualesBatch && datosActualesBatch.batch_info) {
        const batchId = datosActualesBatch.batch_info.id;
        // Abrir PDF en nueva ventana para descarga
        window.open(`/monitoreo/pdf/ticket-batch/${batchId}/`, '_blank');
    } else {
        alert('No hay datos del batch disponibles para descargar.');
    }
}

// Funci√≥n para controlar el estado del bot√≥n de asignar ticket
function actualizarEstadoBotonTicket(numTicket) {
    const btn = document.getElementById('btnAsignarTicket');
    
    // Verificar si el bot√≥n existe (puede no existir si el usuario no tiene permisos)
    if (!btn) {
        return;
    }
    
    if (numTicket) {
        // Ya tiene ticket - deshabilitar bot√≥n
        btn.disabled = true;
        btn.className = 'btn btn-secondary';
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Ticket ya asignado';
    } else {
        // No tiene ticket - habilitar bot√≥n
        btn.disabled = false;
        btn.className = 'btn btn-warning';
        btn.innerHTML = '<i class="bi bi-ticket-perforated"></i> Asignar Ticket';
    }
}

// Funci√≥n para asignar ticket al batch
async function asignarTicketBatch() {
    if (!datosActualesBatch || !datosActualesBatch.batch_info) {
        alert('Error: No hay datos del batch disponibles');
        return;
    }
    
    const batchId = datosActualesBatch.batch_info.id;
    const batchNumTicket = datosActualesBatch.batch_info.num_ticket;
    
    // Verificar si ya tiene ticket asignado - NO permitir reasignaci√≥n
    if (batchNumTicket) {
        alert(`Este batch ya tiene el ticket #${batchNumTicket} asignado. No se puede reasignar.`);
        return;
    }
    
    try {
        // Deshabilitar el bot√≥n mientras se procesa (verificar que existe)
        const btn = document.getElementById('btnAsignarTicket');
        if (!btn) {
            alert('Error: No tiene permisos para asignar tickets');
            return;
        }
        
        const textoOriginal = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Asignando...';
        
        const response = await fetch(`/monitoreo/api/asignar-ticket-batch/${batchId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`¬°Ticket #${data.data.ticket_asignado} asignado exitosamente al batch!`);
            
            // Actualizar la informaci√≥n del batch en el modal
            datosActualesBatch.batch_info.num_ticket = data.data.ticket_asignado;
            
            // Actualizar la visualizaci√≥n
            document.getElementById('infoBatchBasica').innerHTML = `
                <p><strong>Sistema:</strong> ${datosActualesBatch.batch_info.sistema_tag}</p>
                <p><strong># Ticket:</strong> <span class="badge bg-success">${data.data.ticket_asignado}</span></p>
                <p><strong>Inicio:</strong> ${datosActualesBatch.batch_info.fecha_inicio}</p>
                <p><strong>Fin:</strong> ${datosActualesBatch.batch_info.fecha_fin}</p>
                <p><strong>Duraci√≥n:</strong> ${datosActualesBatch.batch_info.duracion_minutos} minutos</p>
                <div class="alert alert-info mt-2 mb-0" style="padding: 8px 12px; font-size: 0.85em;">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Contexto extendido:</strong> La gr√°fica muestra 3 minutos antes y despu√©s del batch para mejor an√°lisis.
                    <br>üîπ <strong>L√≠nea azul clara:</strong> Datos del batch detectado (l√≠nea gruesa, puntos grandes)
                    <br>üî∑ <strong>L√≠nea azul oscura:</strong> Datos de contexto - antes/despu√©s (l√≠nea m√°s fina, puntos peque√±os)
                </div>
            `;
            
            // Actualizar el estado del bot√≥n (ya no se podr√° usar)
            actualizarEstadoBotonTicket(data.data.ticket_asignado);
            
        } else {
            alert('Error al asignar ticket: ' + data.error);
        }
    } catch (error) {
        console.error('Error al asignar ticket:', error);
        alert('Error de conexi√≥n al asignar ticket');
    } finally {
        // Restaurar el bot√≥n (si existe)
        const btn = document.getElementById('btnAsignarTicket');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    }
}

// Funci√≥n para obtener CSRF token (versi√≥n robusta)
function getCSRFToken() {
    // Primero intentar obtener del input hidden
    let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    // Si no se encuentra, intentar obtener de las cookies
    if (!token) {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        token = cookieValue;
    }
    
    // Validar que el token tenga el formato correcto (deber√≠a tener 64 caracteres)
    if (token && token.length !== 64) {
        console.warn('‚ö†Ô∏è Token CSRF con longitud incorrecta:', token.length, 'caracteres. Esperados: 64');
    }
    
    console.log('üîê Token CSRF obtenido:', token ? `‚úÖ V√°lido (${token.length} chars)` : '‚ùå No encontrado');
    return token || '';
}
</script>