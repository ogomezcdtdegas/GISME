{% extends 'base.html' %}
{% load static %}

{% block title %}Monitoreo Coriolis{% if sistema %} - {{ sistema.tag }} {{ sistema.sistema_id }}{% endif %} - GISME{% endblock %}

{% block extra_css %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/monitoreo.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-common.css' %}">
<link rel="stylesheet" href="{% static 'css/coriolis-hybrid.css' %}">
<link rel="stylesheet" href="{% static 'css/soft-colors.css' %}">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {% if show_selector %}
        <!-- ============ VISTA DE SELECCIÓN DE SISTEMAS ============ -->
        <div id="sistema-selector-view">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">
                                <i class="bi bi-diagram-3"></i> Monitoreo Coriolis
                            </h4>
                            <p class="mb-0 mt-2">Seleccione el sistema que desea monitorear</p>
                        </div>
                        <div class="card-body">
                            <!-- Barra de búsqueda -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar sistemas...">
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-outline-secondary" id="clearSearch">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                </div>
                            </div>

                            <!-- Tabla de sistemas -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">
                                                <span style="cursor: pointer;" onclick="sortTable('tag')">
                                                    Tag <i class="bi bi-arrow-up-down ms-1" id="tag-sort-icon"></i>
                                                </span>
                                            </th>
                                            <th scope="col">
                                                <span style="cursor: pointer;" onclick="sortTable('sistema_id')">
                                                    ID Sistema <i class="bi bi-arrow-up-down ms-1" id="sistema_id-sort-icon"></i>
                                                </span>
                                            </th>
                                            <th scope="col">
                                                <span style="cursor: pointer;" onclick="sortTable('ubicacion_nombre')">
                                                    Ubicación <i class="bi bi-arrow-up-down ms-1" id="ubicacion_nombre-sort-icon"></i>
                                                </span>
                                            </th>
                                            <th scope="col">Coordenadas</th>
                                            <th scope="col">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sistemasTableBody">
                                        <tr>
                                            <td colspan="5" class="text-center">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                Cargando sistemas...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Paginación -->
                            <div id="pagination" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- ============ VISTA DE MONITOREO DE SISTEMA ESPECÍFICO ============ -->
        <div id="sistema-monitoring-view">
            <div class="row">
                <div class="col-12">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'monitoreo_coriolis' %}">Monitoreo Coriolis</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                {{ sistema.tag }} {{ sistema.sistema_id }}
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="bi bi-diagram-3"></i> Monitoreo de Medidores Coriolis "{{ sistema.tag }} {{ sistema.sistema_id }}"
                            </h4>
                            <a href="{% url 'monitoreo_coriolis' %}" class="btn btn-light btn-sm">
                                <i class="bi bi-arrow-left"></i> Cambiar Sistema
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Panel de Estado -->
                                <div class="col-lg-8 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="bi bi-activity"></i> Estado del Sistema
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4 text-center">
                                                    <div class="card bg-success text-white">
                                                        <div class="card-body">
                                                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                                                            <h6 class="mt-2">Sistema Activo</h6>
                                                            <p class="mb-0">Funcionando correctamente</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    <div class="card bg-info text-white">
                                                        <div class="card-body">
                                                            <i class="bi bi-droplet" style="font-size: 2rem;"></i>
                                                            <h6 class="mt-2">Flujo Actual</h6>
                                                            <p class="mb-0">125.4 m³/h</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    <div class="card bg-warning text-white">
                                                        <div class="card-body">
                                                            <i class="bi bi-thermometer-half" style="font-size: 2rem;"></i>
                                                            <h6 class="mt-2">Temperatura</h6>
                                                            <p class="mb-0">24.5°C</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Panel de Controles -->
                                <div class="col-lg-4 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="bi bi-gear"></i> Controles
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-primary">
                                                    <i class="bi bi-play-circle"></i> Iniciar Monitoreo
                                                </button>
                                                <button class="btn btn-warning">
                                                    <i class="bi bi-pause-circle"></i> Pausar
                                                </button>
                                                <button class="btn btn-info">
                                                    <i class="bi bi-download"></i> Exportar Datos
                                                </button>
                                                <button class="btn btn-secondary">
                                                    <i class="bi bi-gear"></i> Configuración
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gráfico de Tendencias -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="bi bi-graph-up"></i> Tendencias en Tiempo Real
                                            </h5>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-success me-2">
                                                    <i class="bi bi-broadcast-pin"></i> En Vivo
                                                </span>
                                                <small class="text-muted">Actualización cada 2s</small>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <!-- Métricas Instantáneas -->
                                            <div class="metrics-container">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <div class="metric-item">
                                                            <span>Presión (PSI):</span>
                                                            <span class="metric-value trend-up" id="current-pressure">125.4</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="metric-item">
                                                            <span>Flujo (m³/h):</span>
                                                            <span class="metric-value trend-stable" id="current-flow">87.2</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="metric-item">
                                                            <span>Temperatura (°C):</span>
                                                            <span class="metric-value trend-down" id="current-temp">24.8</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="metric-item">
                                                            <span>Densidad (kg/m³):</span>
                                                            <span class="metric-value trend-up" id="current-density">0.823</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Gráfico -->
                                            <div class="chart-container">
                                                <canvas id="trendChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Información del Sistema -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-info-circle"></i> Información del Sistema
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tr>
                                                    <td><strong>Tag:</strong></td>
                                                    <td>{{ sistema.tag }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>ID Sistemass:</strong></td>
                                                    <td>{{ sistema.sistema_id }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Ubicación:</strong></td>
                                                    <td>{{ sistema.ubicacion.nombre }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Coordenadas:</strong></td>
                                                    <td>
                                                        <a href="#" onclick="showMapModal('{{ sistema.ubicacion.latitud }}', '{{ sistema.ubicacion.longitud }}', '{{ sistema.tag }}', '{{ sistema.sistema_id }}', '{{ sistema.ubicacion.nombre }}')" 
                                                           class="text-primary text-decoration-none" 
                                                           title="Ver en mapa">
                                                            <i class="bi bi-geo-alt me-1"></i>{{ sistema.ubicacion.latitud }}, {{ sistema.ubicacion.longitud }}
                                                        </a>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-clock"></i> Estado de Conexión
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-success me-2">Conectado</span>
                                                <small class="text-muted">Última actualización: hace 2 segundos</small>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">Actualizando cada: <span id="countdown">0.1</span>s</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal para el mapa de ubicación -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">
                    <i class="bi bi-geo-alt"></i> Ubicación del Sistema
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 400px;">
                    <!-- El mapa se carga aquí dinámicamente -->
                </div>
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Sistema:</strong> <span id="modal-sistema-info"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Ubicación:</strong> <span id="modal-ubicacion-info"></span>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <strong>Coordenadas:</strong> <span id="modal-coordenadas-info"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="copyCoordinates()">
                    <i class="bi bi-clipboard"></i> Copiar Coordenadas
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Scripts locales de Coriolis -->
<script src="{% static 'js/coriolis-common.js' %}"></script>
<script src="{% static 'js/coriolis-map.js' %}"></script>

{% if show_selector %}
    <!-- Script para vista de selector -->
    <script src="{% static 'js/coriolis-hybrid-selector.js' %}"></script>
{% else %}
    <!-- Script para vista de monitoreo -->
    <script src="{% static 'js/coriolis-hybrid-monitoring.js' %}"></script>
    
    <!-- Agregar atributos de contexto para JavaScript -->
    <div style="display: none;" 
         data-sistema-tag="{{ sistema.tag }}" 
         data-sistema-id="{{ sistema.sistema_id }}"></div>
{% endif %}
{% endblock %}
