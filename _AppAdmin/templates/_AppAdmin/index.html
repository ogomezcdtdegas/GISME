{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <!-- Mensajes de éxito/error -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Formulario de creación -->
        <div class="col-lg-5">
            <div class="card shadow-lg">
                <div class="card-header text-white text-center" style="background-color: #343a40;">  
                    <h4 class="mb-0 fw-normal">
                        <i class="bi bi-person-plus"></i> 
                        {% if object %}Editar Usuario{% else %}Crear Usuario{% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" class="row g-3">
                        {% csrf_token %}

                        <div class="col-12">
                            <label class="form-label">Correo Electrónico *</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger small">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Nombre</label>
                            {{ form.first_name }}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Apellido</label>
                            {{ form.last_name }}
                        </div>

                        <div class="col-12">
                            <label class="form-label">Rol *</label>
                            {{ form.role }}
                        </div>

                        <div class="col-12 text-center mt-3">
                            <button type="submit" class="btn btn-success w-75">
                                <i class="bi bi-check-circle"></i> 
                                {% if object %}Actualizar Usuario{% else %}Crear Usuario{% endif %}
                            </button>
                            {% if object %}
                                <a href="{% url 'crear_usuario' %}" class="btn btn-secondary w-75 mt-2">
                                    <i class="bi bi-arrow-left"></i> Cancelar
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tabla de usuarios -->
        <div class="col-lg-7">
            <div class="card shadow-lg">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #343a40;">
                    <h4 class="mb-0 fw-normal">
                        <i class="bi bi-people"></i> Usuarios Registrados
                    </h4>
                    <span class="badge bg-light text-dark">{{ usuarios|length }} usuario{{ usuarios|length|pluralize:"s" }}</span>
                </div>
                <div class="card-body p-0">
                    {% if usuarios %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th>Email</th>
                                        <th>Nombre</th>
                                        <th>Rol</th>
                                        <th>Fecha</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for usuario in usuarios %}
                                    <tr>
                                        <td>
                                            <strong>{{ usuario.email }}</strong>
                                        </td>
                                        <td>
                                            {{ usuario.first_name }} {{ usuario.last_name }}
                                        </td>
                                        <td>
                                            {% if usuario.user_role %}
                                                <span class="badge 
                                                    {% if usuario.user_role.role == 'admin_principal' %}bg-danger
                                                    {% elif usuario.user_role.role == 'admin' %}bg-warning
                                                    {% else %}bg-info{% endif %}">
                                                    {{ usuario.user_role.get_role_display }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">Sin rol</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ usuario.date_joined|date:"d/m/Y" }}</small>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'editar_usuario' usuario.pk %}" 
                                                   class="btn btn-outline-primary" title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button class="btn btn-outline-danger" 
                                                        data-user-id="{{ usuario.pk }}" 
                                                        data-user-email="{{ usuario.email }}"
                                                        onclick="eliminarUsuario(this.dataset.userId, this.dataset.userEmail)"
                                                        title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center p-4">
                            <i class="bi bi-person-x fs-1 text-muted"></i>
                            <h5 class="text-muted mt-2">No hay usuarios registrados</h5>
                            <p class="text-muted">Crea el primer usuario usando el formulario de la izquierda.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar al usuario <strong id="userToDelete"></strong>?</p>
                <p class="text-danger"><small>Esta acción no se puede deshacer.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<script>
let userIdToDelete = null;

function eliminarUsuario(userId, userEmail) {
    userIdToDelete = userId;
    document.getElementById('userToDelete').textContent = userEmail;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function confirmarEliminacion() {
    if (!userIdToDelete) return;
    
    fetch('{% url "eliminar_usuario" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `user_id=${userIdToDelete}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Recargar página para actualizar la tabla
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error al eliminar usuario: ' + error);
    });
    
    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
}
</script>
{% endblock %}
